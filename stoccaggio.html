<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SSO – Pagina in sviluppo</title>
  <style>
    /* ===== Base ===== */
    html, body { height:100%; background:#000; margin:0; }
    [data-sso] { color-scheme: dark; font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--fg); }
    [data-sso]{ --bg:#000; --fg:#fff; --accent:#0a84ff; --border:#2c2c2e; --highlight:#ffd60a; --radius:22px; --elev:0 10px 24px rgba(0,0,0,.15); }

    .wrap{ width:100%; max-width:min(760px,100vw); margin:0 auto; padding:calc(8px + env(safe-area-inset-top)) 0 calc(24px + env(safe-area-inset-bottom)); display:flex; flex-direction:column; gap:14px; align-items:center; }
    /* Riduco leggermente il padding-top per alzare i titoli nelle sezioni */
    .section{ width:calc(100% - 32px); border-radius:var(--radius); padding:12px 16px 14px; background:#fff; color:#111; border:1px solid rgba(0,0,0,.08); box-shadow:var(--elev); }
    .section > .title{ margin-top:0; }

    .title{ display:flex; align-items:center; gap:8px; font-weight:800; font-size:18px; margin-bottom:8px; color:#111; }
    .text{ font-size:15px; color:#222; }

    .blink{ width:8px; height:8px; border-radius:999px; background:var(--highlight); animation:blink 1.2s ease-in-out infinite; }
    @keyframes blink{ 0%,100%{opacity:1;}50%{opacity:.5;} }

    .divider{ width:100%; height:2px; background:var(--highlight); box-shadow:0 0 8px rgba(255,214,10,.3); margin:10px 0; }

    /* ===== Search ===== */
    .search{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .input{ flex:1; padding:14px; border-radius:16px; border:1px solid var(--border); font-size:16px; background:#fff; color:#111; }
    .btn{ border:none; border-radius:16px; padding:14px 20px; background:#0a84ff; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 4px 14px rgba(10,132,255,.35); }
    @media(min-width:520px){.search{flex-direction:row;}.btn{width:auto;}}

    /* ===== Orders ===== */
    .orders{ display:flex; flex-direction:column; gap:10px; }
    #sso-out.orders{ margin-top:16px; }
    #sso-ritiri-list.orders{ margin-top:16px; }

    .order-card{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:14px; background:#fff; border:1px solid rgba(0,0,0,.08); box-shadow:var(--elev); cursor:pointer; }
    .order-card:active{ transform:scale(.995); }
    .order-badge{ min-width:46px; height:32px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; background:#ffd60a; color:#000; font-weight:900; }
    .order-main{ flex:1; min-width:0; }
    .order-name{ font-weight:800; color:#0b0b0b; font-size:15px; }
    .order-sub{ display:flex; flex-wrap:wrap; gap:6px; margin-top:4px; }
    .order-pill{ padding:4px 8px; border-radius:999px; font-weight:700; font-size:11px; }
    .order-time{ background:#f2f2f3; color:#111; }
    .order-date{ background:#e9e9eb; color:#111; }
    /* Stoccaggio: azzurro a gradiente + testo nero */
    .order-zone{ background:linear-gradient(135deg,#cfe9ff,#7dc4ff); color:#000; border:1px solid rgba(0,0,0,.08); }

    /* ===== Tabs / Date ===== */
    .tabs{ display:flex; gap:12px; flex-wrap:nowrap; overflow:auto; }
    .tab{ padding:10px 14px; border-radius:999px; border:1px solid rgba(0,0,0,.06); background:#f2f2f3; font-weight:800; cursor:pointer; white-space:nowrap; color:#111; }
    .tab.active{ background:#111; color:#fff; }
    .tab-date{ position:relative; }
    .date-ghost{ position:absolute; inset:0; opacity:0; cursor:pointer; }

    .date-accent{ color:#22c55e; font-weight:900; }
    .empty{ padding:12px; border-radius:14px; border:1px dashed rgba(0,0,0,.15); background:#fff; color:#333; font-size:14px; text-align:center; }
    .status{ margin-top:8px; font-size:12px; color:#555; }

    /* ===== Modal Fullscreen ===== */
    .modal{ position:fixed; inset:0; display:none; z-index:2147483647; }
    .modal.open{ display:block; }
    .modal .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter:saturate(1.2) blur(6px); }
    .modal .sheet{ position:absolute; inset:0; background:#fff; color:#111; display:flex; flex-direction:column; }
    .modal header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; border-bottom:1px solid #ececec; position:sticky; top:0; background:#fff; z-index:1; }
    .modal header .h{ font-weight:900; font-size:16px; }
    .modal header .zone{ font-size:12px; padding:6px 10px; border-radius:999px; background:linear-gradient(135deg,#cfe9ff,#7dc4ff); color:#000; border:1px solid rgba(0,0,0,.08); white-space:nowrap; }
    .modal .close{ border:1px solid #ddd; background:#fff; border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer; }
    .modal .content{ padding:12px 16px 28px; overflow:auto; }
    .kv{ width:100%; border-collapse:collapse; }
    .kv th, .kv td{ text-align:left; padding:10px 8px; border-bottom:1px solid #f1f1f1; font-size:14px; }
    .kv th{ width:36%; color:#444; font-weight:700; }
    .kv tr:last-child th, .kv tr:last-child td{ border-bottom:none; }
  </style>
</head>
<body>
  <!-- ROOT NAMESPACED -->
  <div data-sso id="sso-app">
    <div class="wrap">
      <section class="section">
        <h2 class="title"><span class="blink"></span> Pagina in sviluppo</h2>
        <p class="text">Questa pagina è in fase di sviluppo e verrà rilasciata con la versione <strong>SSO 10</strong>.</p>
      </section>

      <div class="divider"></div>

      <!-- Blocco: Ricerca rapida -->
      <section class="section">
        <h2 class="title">Ricerca rapida</h2>
        <p class="text">Inserisci il <strong>nome cliente</strong> per risalire al numero d'ordine e alla posizione di stoccaggio.</p>
        <div class="search">
          <input id="sso-q" class="input" type="search" placeholder="Cerca nome cliente…" />
          <button id="sso-go" class="btn">Cerca</button>
        </div>
        <div id="sso-out" class="orders"></div>
        <div id="sso-status" class="status"></div>
      </section>

      <!-- Blocco: Elenco ritiri -->
      <section class="section">
        <h2 class="title">Ritiri di <span id="sso-ritiri-title-date" class="date-accent">—</span></h2>
        <div class="tabs">
          <button class="tab active" id="sso-tab-oggi">Oggi</button>
          <button class="tab" id="sso-tab-domani">Domani</button>
          <button class="tab tab-date" id="sso-tab-data"><span id="sso-tab-date-label">Data</span><input id="sso-ritiri-date" class="date-ghost" type="date" /></button>
        </div>
        <div id="sso-ritiri-list" class="orders"></div>
      </section>
    </div>
  </div>

  <!-- ===== Fullscreen Modal (hidden by default) ===== -->
  <div id="sso-modal" class="modal" aria-hidden="true" role="dialog">
    <div class="backdrop"></div>
    <div class="sheet">
      <header>
        <div style="min-width:0;">
          <div id="sso-modal-title" class="h" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Dettaglio ordine</div>
          <div id="sso-modal-sub" class="text" style="margin-top:4px;color:#555;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
        </div>
        <div class="zone" id="sso-modal-zone">—</div>
        <button id="sso-modal-close" class="close" aria-label="Chiudi">Chiudi</button>
      </header>
      <div class="content">
        <table class="kv" id="sso-modal-table"></table>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const root = document.getElementById('sso-app');
    const QS = sel => root.querySelector(sel);

    // === API: Apps Script (AGGREGATO) ===
    const API_URL = 'https://script.google.com/macros/s/AKfycbzp_2RNQO9ROQkpcGebBpZ9P_MyZEmxkqLh5G-ODe4Yo2x9E0aRbEQIbmofaxhod9VGFA/exec';

    // === Helpers ===
    const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const ddmmyyyy = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    const fmtIT = d => new Intl.DateTimeFormat('it-IT',{weekday:'long',day:'2-digit',month:'long'}).format(d);
    const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
    const esc = s => String(s==null? '': s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

    function parseAnyDate(s){
      if(!s) return null;
      const str=String(s).trim();
      let m=str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/); // gg/mm/aaaa
      if(m){ const dd=+m[1], mm=+m[2]-1, yy=+m[3]; return new Date(yy<100?2000+yy:yy, mm, dd, 12,0,0); }
      m=str.match(/^(\d{4})-(\d{2})-(\d{2})$/); // yyyy-mm-dd
      if(m){ return new Date(+m[1], +m[2]-1, +m[3], 12,0,0); }
      const d=new Date(str); return Number.isNaN(d.getTime())? null : d;
    }

    // Stato
    let DATA_ROWS = []; // {ord,name,dateKey,dateText,time,zone, src, __i}
    let UPDATED_AT = null;

    // Mappa flessibile di colonne dal JSON completo dell'API
    function mapRowsFromAPI(rows){
      const pickKey = (obj, candidates) => {
        const keys = Object.keys(obj);
        for(const cand of candidates){
          const k = keys.find(x => norm(x) === norm(cand));
          if(k) return k;
        }
        for(const cand of candidates){
          const k = keys.find(x => norm(x).includes(norm(cand)));
          if(k) return k;
        }
        return null;
      };

      const out = [];
      for(const r of rows){
        const nameKey = pickKey(r, ['NOME CLIENTE','NOME','CLIENTE']);
        const dateKeyRaw = pickKey(r, ['DATA ORDINE','DATA','GIORNO']);
        const timeKey = pickKey(r, ['ORA','ORARIO']);
        const zoneKey = pickKey(r, ['ZONA STOCCAGGIO','ZONA','STOCCAGGIO','UBICAZIONE']);
        const ordKey = pickKey(r, ['NUMERO ORDINE','ORDINE','N° ORDINE','ORD']);

        const name = nameKey ? (r[nameKey]||'').trim() : '';
        if(!name) continue;
        const d = dateKeyRaw ? parseAnyDate(r[dateKeyRaw]) : null;
        const time = timeKey ? String(r[timeKey]||'').trim() : '';
        const zone = zoneKey ? String(r[zoneKey]||'').trim() : '';
        const ordRaw = ordKey ? r[ordKey] : r.ord;
        const ord = ordRaw != null ? Number(ordRaw) : null;

        out.push({
          ord: Number.isFinite(ord)? ord : null,
          name,
          dateKey: d? ymd(d) : null,
          dateText: d? ddmmyyyy(d) : '',
          time,
          zone: zone || '?',
          src: r // conserva tutte le colonne originali
        });
      }
      out.sort((a,b)=>{
        if(a.dateKey && b.dateKey && a.dateKey!==b.dateKey) return a.dateKey.localeCompare(b.dateKey);
        const ta=a.time||'', tb=b.time||'';
        if(ta && tb){ const cmp=ta.localeCompare(tb); if(cmp!==0) return cmp; }
        return a.name.localeCompare(b.name);
      });
      out.forEach((o,i)=>o.__i=i);
      return out;
    }

    function orderCard(o, opts={}){
      const { hideDate=false, showDateFirst=false } = opts;
      const datePill = (!hideDate && o.dateText) ? `<span class='order-pill order-date'>${esc(o.dateText)}</span>` : '';
      const timePill = o.time ? `<span class='order-pill order-time'>${esc(o.time)}</span>` : '';
      const pills = showDateFirst ? `${datePill}${timePill}` : `${timePill}${datePill}`;
      return `
        <div class='order-card' data-idx='${o.__i}'>
          <span class='order-badge'>${o.ord ?? '—'}</span>
          <div class='order-main'>
            <div class='order-name'>${esc(o.name)}</div>
            <div class='order-sub'>
              ${pills}
              <span class='order-pill order-zone'>${esc(o.zone||'?')}</span>
            </div>
          </div>
        </div>`;
    }

    const rowsForDate = d => {
      const key = ymd(new Date(d));
      return DATA_ROWS.filter(r=>r.dateKey===key).sort((a,b)=>{
        const ta=a.time||'', tb=b.time||'';
        if(ta && tb){ const cmp=ta.localeCompare(tb); if(cmp!==0) return cmp; }
        return a.name.localeCompare(b.name);
      });
    };

    function renderList(d){
      const rows = rowsForDate(d);
      const html = rows.length ? rows.map(o=>orderCard(o,{hideDate:true})).join('') : `<div class='empty'>Nessun ritiro</div>`;
      document.getElementById('sso-ritiri-list').innerHTML = html;
      document.getElementById('sso-ritiri-title-date').textContent = fmtIT(d);
    }

    function findByName(q){
      const n = norm(q.trim()); if(!n) return [];
      const exact = DATA_ROWS.filter(r=>norm(r.name)===n); if(exact.length) return exact;
      const starts = DATA_ROWS.filter(r=>norm(r.name).startsWith(n)); if(starts.length) return starts;
      return DATA_ROWS.filter(r=>norm(r.name).includes(n));
    }

    async function refreshData(){
      const res = await fetch(API_URL + '?_ts=' + Date.now(), { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      UPDATED_AT = data.updatedAt || null;
      DATA_ROWS = mapRowsFromAPI(data.rows || []);
      document.getElementById('sso-status').textContent = UPDATED_AT ? `Dati aggiornati: ${new Date(UPDATED_AT).toLocaleString('it-IT')}` : '';
    }

    async function submit(){
      const qv = (document.getElementById('sso-q').value||'').trim();
      try { await refreshData(); } catch(_) { /* fallback: uso cache */ }
      const rows = qv ? findByName(qv) : rowsForDate(new Date());
      document.getElementById('sso-out').innerHTML = rows.map(o=>orderCard(o,{showDateFirst:true})).join('') || `<div class='empty'>Nessun risultato</div>`;
      if(rows.length) document.getElementById('sso-out').scrollIntoView({behavior:'smooth',block:'start'});
    }

    // Tabs & Date
    const tabs={
      oggi:document.getElementById('sso-tab-oggi'),
      domani:document.getElementById('sso-tab-domani'),
      data:document.getElementById('sso-tab-data')
    };
    const dateInput=document.getElementById('sso-ritiri-date');
    const dateLabel=document.getElementById('sso-tab-date-label');
    const setDateTabLabel = d => { dateLabel.textContent = ddmmyyyy(d); };

    function activate(which){
      Object.values(tabs).forEach(t=>{ t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
      tabs[which].classList.add('active'); tabs[which].setAttribute('aria-selected','true');
      if(which==='data'){
        if(!dateInput.value) dateInput.value = ymd(new Date());
        const d = new Date(`${dateInput.value}T12:00:00`);
        setDateTabLabel(d); renderList(d);
        if(dateInput.showPicker){ try{ dateInput.showPicker(); }catch(_){} }
      } else {
        dateLabel.textContent='Data';
        const base=new Date(); if(which==='domani') base.setDate(base.getDate()+1); renderList(base);
      }
    }

    // ===== Modal logic =====
    const modal = document.getElementById('sso-modal');
    const modalClose = document.getElementById('sso-modal-close');
    const modalTable = document.getElementById('sso-modal-table');
    const modalTitle = document.getElementById('sso-modal-title');
    const modalSub = document.getElementById('sso-modal-sub');
    const modalZone = document.getElementById('sso-modal-zone');

    function openModal(row){
      modalTitle.textContent = row.name || 'Dettaglio ordine';
      modalSub.textContent = [ row.ord? `Ordine #${row.ord}`: null, row.dateText? row.dateText: null, row.time? row.time: null ].filter(Boolean).join(' • ');
      modalZone.textContent = row.zone || '—';

      const entries = Object.entries(row.src || {});
      const extra = [ ['Numero Ordine (parsed)', row.ord ?? '—'], ['Data (parsed)', row.dateText || '—'], ['Ora (parsed)', row.time || '—'], ['Zona (parsed)', row.zone || '—'] ];

      const seen = new Set();
      const rowsHtml = [
        ...entries.map(([k,v])=>{
          const key = String(k).trim();
          seen.add(norm(key));
          return `<tr><th>${esc(key)}</th><td>${esc(v)}</td></tr>`;
        }),
        ...extra.filter(([k,_])=>!seen.has(norm(k))).map(([k,v])=>`<tr><th>${esc(k)}</th><td>${esc(v)}</td></tr>`)
      ].join('');

      modalTable.innerHTML = rowsHtml || `<tr><td>Nessun dettaglio</td></tr>`;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    }

    function closeModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
    }

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target.classList.contains('backdrop')) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeModal(); });

    // Click su card → apre modale
    root.addEventListener('click', e=>{
      const card = e.target.closest('.order-card');
      if(card){
        const idx = Number(card.getAttribute('data-idx'));
        const row = DATA_ROWS.find(x=>x.__i===idx);
        if(row) openModal(row);
      }
    });

    // === Boot ===
    (async function init(){
      try{
        await refreshData();
      }catch(err){
        console.warn('Errore API:', err);
        DATA_ROWS = [];
        document.getElementById('sso-status').textContent = 'Errore nel caricamento dei dati';
      }
      document.getElementById('sso-go').onclick=submit; document.getElementById('sso-q').onkeydown=e=>{ if(e.key==='Enter') submit(); };
      tabs.oggi.onclick=()=>activate('oggi'); tabs.domani.onclick=()=>activate('domani'); tabs.data.onclick=()=>activate('data');
      dateInput.onchange=()=>activate('data');
      setInterval(async ()=>{
        try{
          await refreshData();
          const isDomani = tabs.domani.classList.contains('active');
          const isData   = tabs.data.classList.contains('active');
          if (isData) {
            const d = new Date(`${dateInput.value||ymd(new Date())}T12:00:00`);
            renderList(d);
          } else {
            const base = new Date(); if (isDomani) base.setDate(base.getDate()+1);
            renderList(base);
          }
          const qv = (document.getElementById('sso-q').value||'').trim();
          if (qv) {
            const rows = findByName(qv);
            document.getElementById('sso-out').innerHTML = rows.map(o=>orderCard(o,{showDateFirst:true})).join('') || `<div class='empty'>Nessun risultato</div>`;
          }
        }catch(_){}
      }, 300000);
      activate('oggi');
    })();
  })();
  </script>
</body>
</html>
