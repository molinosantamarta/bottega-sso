<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SSO – Pagina in sviluppo</title>
  <style>
    /* ===== Base ===== */
    html, body { height:100%; background:#000; margin:0; }
    [data-sso] { color-scheme: dark; font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--fg); -webkit-text-size-adjust:115%; text-size-adjust:115%; }
    [data-sso] :where(*) { box-sizing:border-box; }
    [data-sso]{ --bg:#000; --fg:#fff; --accent:#0a84ff; --border:#2c2c2e; --highlight:#ffd60a; --pane-max:min(760px,100vw); --radius:22px; --elev:0 10px 24px rgba(0,0,0,.15); }

    .wrap{ width:100%; max-width:var(--pane-max); margin:0 auto; padding:calc(8px + env(safe-area-inset-top)) 0 calc(24px + env(safe-area-inset-bottom)); display:flex; flex-direction:column; gap:14px; }

    /* ===== Card ===== */
    .section{ width:calc(100% - 32px); max-width:var(--pane-max); margin:0; border-radius:var(--radius); padding:14px 16px; background:#fff; color:#111; border:1px solid rgba(0,0,0,.08); box-shadow:var(--elev); }
    .section:active{ transform:translateY(.5px); }
    @media (max-width:430px){ .section{ width:calc(100% - 24px); padding:12px; border-radius:18px; } }

    .title{ display:flex; align-items:center; gap:8px; font-size:clamp(15px,3.8vw,18px); font-weight:800; color:#111; margin:2px 0 8px; letter-spacing:.2px; }
    .text{ font-size:clamp(13px,3.5vw,15px); line-height:1.45; color:#222; opacity:.95; }

    /* ===== Blink indicator ===== */
    .blink{ width:8px; height:8px; border-radius:999px; background:var(--highlight); box-shadow:0 0 0 3px rgba(255,214,10,.25); animation:blink 1.2s ease-in-out infinite; }
    @keyframes blink{ 0%,100%{ opacity:1; box-shadow:0 0 0 3px rgba(255,214,10,.25), 0 0 0 rgba(255,214,10,0);} 50%{ opacity:.65; box-shadow:0 0 0 3px rgba(255,214,10,.25), 0 0 20px rgba(255,214,10,.5);} }

    /* ===== Divider ===== */
    .divider{ width:100%; max-width:var(--pane-max); position:relative; height:0; }
    .divider::before{ content:""; position:absolute; left:-24px; right:-24px; top:-1px; height:2px; background:var(--highlight); box-shadow:0 0 0 1px rgba(255,214,10,.65), 0 0 18px rgba(255,214,10,.25); }

    /* ===== Search ===== */
    .search{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .input{ flex:1; width:100%; padding:16px; border-radius:16px; border:1px solid var(--border); background:#fff; color:#111; font-size:16px; line-height:1.1; outline:none; transition:border .2s ease; }
    .input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(10,132,255,.25); }
    .input::placeholder{ color:#777; }
    .btn{ width:100%; height:48px; border:none; border-radius:16px; background:#0a84ff; color:#fff; font-weight:700; font-size:15px; letter-spacing:.2px; cursor:pointer; box-shadow:0 4px 14px rgba(10,132,255,.10); transition:background .2s,transform .1s; }
    .btn:hover{ background:#0068e6; }
    .btn:active{ transform:translateY(.5px); }
    @media (min-width:520px){ .search{ flex-direction:row; align-items:center; } .btn{ width:auto; height:auto; padding:12px 20px; } }

    /* ===== Orders (shared UI) ===== */
    .orders{ display:flex; flex-direction:column; gap:10px; }
    #out.orders{ margin-top:18px; }
    .order-card{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:14px; background:#fff; border:1px solid rgba(0,0,0,.08); box-shadow:var(--elev); cursor:pointer; }
    .order-badge{ min-width:46px; height:32px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; background:#ffd60a; color:#000; font-weight:900; }
    .order-main{ flex:1; min-width:0; }
    .order-name{ font-weight:800; color:#0b0b0b; font-size:15px; }
    .order-sub{ color:#555; font-size:12px; margin-top:3px; display:flex; gap:10px; flex-wrap:wrap; }
    .order-zone{ background:#111; color:#fff; border-radius:999px; padding:4px 8px; font-weight:700; font-size:11px; }
    .order-zone.missing{ background:#f6f6f7; color:#111; border:1px dashed #bbb; }
    .order-time{ background:#f2f2f3; color:#111; border-radius:999px; padding:4px 8px; font-weight:700; font-size:11px; }

    /* ===== Tabs / selectors ===== */
    .tabs{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0 10px; }
    .tab{ appearance:none; border:none; padding:10px 14px; border-radius:999px; background:#f2f2f3; color:#111; font-weight:800; font-size:13px; letter-spacing:.2px; cursor:pointer; border:1px solid rgba(0,0,0,.08); transition:background .2s, color .2s, border .2s, transform .1s; }
    .tab.active{ background:#111; color:#fff; border-color:#111; }
    .tab:active{ transform:translateY(.5px); }

    /* ===== Date picker (mobile-friendly) ===== */
    .date-picker{ display:none; margin-left:auto; }
    .tabs.show-date .date-picker{ display:flex; }
    .date-input{ appearance:none; padding:10px 14px; border-radius:999px; border:1px solid rgba(0,0,0,.08); background:#fff; color:#111; font-weight:800; font-size:13px; letter-spacing:.2px; box-shadow:0 1px 4px rgba(0,0,0,.04); }
    .date-input::-webkit-calendar-picker-indicator{ cursor:pointer; }

    /* ===== Fullscreen order sheet ===== */
    .sheet{ position:fixed; inset:0; z-index:50; display:none; }
    .sheet[open]{ display:block; }
    .sheet-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter:saturate(120%) blur(2px); }
    .sheet-panel{ position:absolute; inset:env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0; margin:0 auto; max-width:var(--pane-max); height:calc(100% - env(safe-area-inset-top) - env(safe-area-inset-bottom)); background:#fff; color:#111; border-radius:var(--radius); box-shadow:0 10px 40px rgba(0,0,0,.15); display:flex; flex-direction:column; }
    .sheet-head{ padding:12px 14px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(0,0,0,.08); }
    .sheet-title{ font-weight:900; font-size:18px; }
    .sheet-sub{ font-size:12px; color:#444; }
    .sheet-close{ appearance:none; border:none; background:#111; color:#fff; border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer; }
    .sheet-body{ padding:12px 16px 24px; overflow:auto; }
    .sheet-tags{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:8px 0 12px; }
    .tag{ display:inline-flex; align-items:center; justify-content:center; padding:6px 10px; border-radius:999px; font-weight:800; font-size:11px; border:1px solid rgba(0,0,0,.08); }
    .tag.dark{ background:#111; color:#fff; border-color:#111; }
    .tag.light{ background:#f3f3f4; color:#111; }
    .brand-oval{ display:inline-flex; align-items:center; justify-content:center; padding:6px 16px; border-radius:999px; border:1px solid #111; font-weight:800; font-size:12px; }
    .sheet-list{ margin:14px auto; max-width:520px; }
    .sheet-list ul{ list-style:none; padding:0; margin:0; text-align:center; }
    .sheet-list li{ padding:6px 0; border-bottom:1px dashed rgba(0,0,0,.08); }
    .sheet-meta{ display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#555; margin-top:6px; }

    /* Date accent for titles */
    .date-accent{ color:#22c55e; font-weight:900; }
  </style>
</head>
<body>
  <div data-sso>
    <div class="wrap">

      <!-- Blocco: Pagina in sviluppo -->
      <section class="section" aria-labelledby="dev-title">
        <h2 id="dev-title" class="title"><span class="blink" aria-hidden="true"></span> Pagina in sviluppo (beta6)</h2>
        <p class="text">Questa pagina è in fase di sviluppo e verrà rilasciata con la versione <strong>SSO 10</strong>.</p>
      </section>

      <!-- Divisione netta -->
      <div class="divider" role="separator" aria-label="Inizio area operativa"></div>

      <!-- Blocco: Ricerca rapida -->
      <section class="section" aria-labelledby="search-title">
        <h2 id="search-title" class="title">Ricerca rapida</h2>
        <p class="text">Inserisci il <strong>nome cliente</strong> per risalire al numero d'ordine e alla posizione di stoccaggio.</p>
        <div class="search" role="search">
          <input id="q" class="input" type="search" inputmode="search" autocomplete="off" placeholder="Cerca nome cliente…" aria-label="Cerca per nome" />
          <button id="go" class="btn" type="button" aria-label="Cerca">Cerca</button>
        </div>
        <div id="out" class="orders" role="list" aria-live="polite"></div>
      </section>

      <!-- Blocco: Elenco ritiri -->
      <section class="section" aria-labelledby="ritiri-title">
        <h2 id="ritiri-title" class="title">Ritiri di <span id="ritiri-title-date" class="date-accent">—</span></h2>
        <div id="ritiri-tabs" class="tabs" role="tablist">
          <button class="tab active" role="tab" aria-selected="true" id="tab-oggi">Oggi</button>
          <button class="tab" role="tab" aria-selected="false" id="tab-domani">Domani</button>
          <button class="tab" role="tab" aria-selected="false" id="tab-data">Data</button>
          <div class="date-picker">
            <input id="ritiri-date" class="date-input" type="date" aria-label="Seleziona data" />
          </div>
        </div>
        <div id="ritiri-list" class="orders" role="list" aria-live="polite"></div>
      </section>

    </div>
  </div>

  <!-- Fullscreen order sheet (modal) -->
  <div id="order-sheet" class="sheet" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet-backdrop" data-close></div>
    <div class="sheet-panel">
      <div class="sheet-head">
        <div>
          <div id="sheet-title" class="sheet-title">—</div>
          <div id="sheet-sub" class="sheet-sub">—</div>
        </div>
        <button class="sheet-close" type="button" data-close>Chiudi</button>
      </div>
      <div class="sheet-body">
        <div class="sheet-tags">
          <span id="sheet-interno" class="tag light">ORDINE INTERNO</span>
          <span id="sheet-pren" class="tag dark">SI</span>
          <span id="sheet-order" class="tag light">#000</span>
          <span class="brand-oval">La Bottega</span>
        </div>
        <div id="sheet-reparti" class="tag dark" style="margin-bottom:8px;">FRUTTA E VERDURA</div>
        <div class="sheet-list">
          <ul id="sheet-items"><li>—</li></ul>
        </div>
        <div class="sheet-meta">
          <div id="sheet-zone">Zona: —</div>
          <div id="sheet-note">Note: —</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Utilities =====
    const $ = s => document.querySelector(s);
    const zones = ['NEGOZIO - SOPRA','NEGOZIO - SOTTO','CELLA SOPRA','CAMION SOPRA','CAMION SOTTO','SCALE','CARNE'];
    const escapeHTML = s => s.replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));

    // ===== Shared card renderer =====
    function orderCard({ ord, name, zone, time }){
      const safeName = escapeHTML(name);
      const safeZone = zone ? escapeHTML(zone) : null;
      return `
        <div class="order-card" role="listitem" data-ord="${ord}" data-name="${safeName}" data-zone="${safeZone||''}" data-time="${time||''}">
          <span class="order-badge">${ord}</span>
          <div class="order-main">
            <div class="order-name">${safeName}</div>
            <div class="order-sub">
              ${time ? `<span class="order-time">${time}</span>` : ''}
              <span class="order-zone ${safeZone ? '' : 'missing'}">${safeZone || '?'}</span>
            </div>
          </div>
        </div>`;
    }

    // ===== Ricerca rapida =====
    const q = $('#q');
    const go = $('#go');
    const out = $('#out');

    const orderFrom = n => { let h=0; for(let i=0;i<n.length;i++) h=(h*31+n.charCodeAt(i))>>>0; return 100+(h%900); };
    const zoneFrom  = n => { let h=0; for(let i=0;i<n.length;i++) h=(h*17+n.charCodeAt(i))>>>0; return zones[h%zones.length]; };

    function renderSearch(name){
      const ord = orderFrom(name);
      const zone = zoneFrom(name);
      out.innerHTML = orderCard({ ord, name, zone, time:null });
    }

    function submit(){
      const n = q.value.trim();
      if(!n){ out.innerHTML = ''; return; }
      renderSearch(n);
      requestAnimationFrame(()=>out.scrollIntoView({behavior:'smooth', block:'start'}));
    }

    go.addEventListener('click', submit);
    q.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); submit(); } });

    // ===== Ritiri (mock) =====
    const tabs = { oggi: $('#tab-oggi'), domani: $('#tab-domani'), data: $('#tab-data') };
    const tabsWrap = $('#ritiri-tabs');
    const listEl = $('#ritiri-list');
    const dateEl = $('#ritiri-date');

    function atMidnight(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
    function fmtTime(h,m){ return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function ymd(d){ return new Date(d).toISOString().slice(0,10); }
    function fullItalianDate(d){
      try{
        const fmt = new Intl.DateTimeFormat('it-IT', { weekday:'long', day:'2-digit', month:'long' });
        // es: "sabato 04 ottobre" -> capitalizza il primo carattere
        const s = fmt.format(d);
        return s.charAt(0).toUpperCase() + s.slice(1);
      } catch(err){
        const giorni = ['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];
        const mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
        return `${giorni[d.getDay()]}, ${String(d.getDate()).padStart(2,'0')} ${mesi[d.getMonth()]}`;
      }
    }

    function setRitiriTitle(dateLike){
      const d = (typeof dateLike === 'string') ? new Date(dateLike) : new Date(dateLike);
      const el = document.getElementById('ritiri-title-date');
      if(!el) return;
      const t = d instanceof Date && !Number.isNaN(d.getTime()) ? fullItalianDate(d) : '—';
      el.textContent = t;
    }

    const names = ['Abbiati','Negri','Tiziani','Monza','Invernizzi','Pontevecchio','Fontana','Rho','Pellegrino','Faspar'];
    const pick = (arr,i) => arr[i % arr.length];

    function genOrdersFor(date){
      const base = atMidnight(date);
      const count = 4 + (base.getDate() % 3); // 4..6
      const orders = [];
      for(let i=0;i<count;i++){
        const h = 8 + ((i*2 + base.getDay()) % 9); // 8..16
        const m = (i*15) % 60;
        const name = pick(names, i + base.getDate());
        const ord = 100 + ((base.getDate()*37 + i*19) % 900);
        const maybeZone = ((i + base.getDate()) % 4 === 0) ? null : pick(zones, i + base.getDay()); // 25% senza zona
        orders.push({ ord, name, time: fmtTime(h,m), zone: maybeZone });
      }
      return orders;
    }

    function renderRitiri(date){
      const data = genOrdersFor(date);
      listEl.innerHTML = data.map(o => orderCard(o)).join('');
    }

    function activate(which){
      Object.values(tabs).forEach(btn=>{ btn.classList.remove('active'); btn.setAttribute('aria-selected','false'); });
      tabs[which].classList.add('active'); tabs[which].setAttribute('aria-selected','true');
      if(which==='data'){
        tabsWrap.classList.add('show-date');
        if(!dateEl.value) dateEl.value = ymd(new Date());
        renderRitiri(dateEl.value);
        setRitiriTitle(dateEl.value);
      } else {
        tabsWrap.classList.remove('show-date');
        const base = new Date();
        const target = (which==='oggi' ? base : addDays(base,1));
        renderRitiri(target);
        setRitiriTitle(target);
      }
    }

    tabs.oggi.addEventListener('click', ()=>activate('oggi'));
    tabs.domani.addEventListener('click', ()=>activate('domani'));
    tabs.data.addEventListener('click', ()=>activate('data'));

    dateEl.addEventListener('change', ()=>{
      if(tabs.data.classList.contains('active')){
        renderRitiri(dateEl.value);
        setRitiriTitle(dateEl.value);
      }
    });

    // === Init con data reale del dispositivo ===
    document.addEventListener('DOMContentLoaded', ()=>{
      activate('oggi');
      setRitiriTitle(new Date());
    });

    // ===== Fullscreen order sheet logic =====
    const sheet = $('#order-sheet');
    const sheetTitle = $('#sheet-title');
    const sheetSub = $('#sheet-sub');
    const sheetReparti = $('#sheet-reparti');
    const sheetItems = $('#sheet-items');
    const sheetZone = $('#sheet-zone');
    const sheetNote = $('#sheet-note');

    function fmtItalianShort(dateStr){
      const d = new Date(dateStr || Date.now());
      const giorni = ['dom','lun','mar','mer','gio','ven','sab'];
      const mesi = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
      return `${giorni[d.getDay()]} ${d.getDate()} ${mesi[d.getMonth()]}`;
    }

    function mockItems(seed){
      const base = [
        'patate montagna 1 sacco','cipolla tropea 1 kg','radicchio treviso 2','datterini 1 kg','zucchine 6',
        'cavolfiore piccolo 1','carciofi 4','limoni naturali 2','uva senza semi 1 kg','kiwi gialli 2 kg',
        'mandarini senza semi 1 kg','zucca mezza','finocchi 2','cetrioli 4','cosce pollo tagliate 4','petto tacchino sottile 6'
      ];
      const out = [];
      for(let i=0;i<Math.min(16, 8 + (seed % 9)); i++) out.push(base[i % base.length]);
      return out;
    }

    function openSheet({ ord, name, zone, time }){
      sheetTitle.textContent = name;
      sheetSub.textContent = time ? time : fmtItalianShort(dateEl.value || new Date());
      document.getElementById('sheet-order').textContent = `#${ord}`;
      document.getElementById('sheet-pren').textContent = 'SI';
      sheetReparti.textContent = 'FRUTTA E VERDURA, CARNE';
      const items = mockItems(Number(ord));
      sheetItems.innerHTML = items.map(it => `<li>${escapeHTML(it)}</li>`).join('');
      sheetZone.textContent = `Zona: ${zone || '?'}`;
      sheetNote.textContent = 'Note: —';
      sheet.setAttribute('open','');
      sheet.removeAttribute('aria-hidden');
    }

    function closeSheet(){
      sheet.removeAttribute('open');
      sheet.setAttribute('aria-hidden','true');
    }

    document.addEventListener('click', (e)=>{
      const card = e.target.closest('.order-card');
      if(card){
        const data = {
          ord: card.getAttribute('data-ord'),
          name: card.getAttribute('data-name'),
          zone: card.getAttribute('data-zone') || null,
          time: card.getAttribute('data-time') || null,
        };
        openSheet(data);
      }
      if(e.target.matches('[data-close]')) closeSheet();
    });

    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSheet(); });
  </script>
</body>
</html>
