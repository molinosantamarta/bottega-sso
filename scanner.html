<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Scanner – SSO</title>
  <style>
    /* Reset pagina e sfondo nero pieno */
    html, body { height:100%; background:#000; }
    body { margin:0; touch-action: manipulation; }

    [data-sso] { color-scheme: dark; position: relative; }
    [data-sso] :where(*) { box-sizing: border-box; }
    [data-sso]{
      --bg:#000;
      --fg:#fff;
      --muted:#1c1c1e;
      --accent:#0a84ff;
      --danger:#ff453a;
      --ok:#34c759;
      --chip:#1f1f22;
      --border:#2c2c2e;
      --success:#22c55e;
      --torch-on:#ffd60a;
      --yellow:#ffd60a;

      --pane-w: 100%;
      --pane-max: min(760px, 100vw);
      --pane-gutter: 0px;

      --radius-outer: 28px;
      --radius-inner: 20px;

      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;
      -webkit-text-size-adjust:115%;
      text-size-adjust:115%;
    }

    /* wrapper centrale */
    [data-sso] .wrap{
      width:100%;
      padding:8px 0 24px;
      max-width:var(--pane-max);
      margin-left:auto;
      margin-right:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    /* card sezione */
    [data-sso] .section{
      width:100%;
      max-width:var(--pane-max);
      margin:14px auto;
      border-radius:26px;
      padding:14px 16px;
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 10px 24px rgba(0,0,0,.15);
      transition:background .25s ease, box-shadow .25s ease, border-color .25s ease;
      overflow:hidden;
      position: relative; z-index: 0;
      pointer-events:auto;
    }
    @media (max-width: 430px){
      [data-sso] .section{ width:96vw; border-radius:22px; }
    }
    /* Glow più intenso quando selezionate/attive */
    [data-sso] .section.active{
      background:linear-gradient(180deg, #ffffff, #fbfbfb);
      border-color:rgba(0,0,0,.12);
      box-shadow:
        0 14px 32px rgba(0,0,0,.22),
        0 0 0 2px rgba(10,132,255,.25) inset,
        0 0 20px 2px rgba(10,132,255,.28),
        0 0 36px 4px rgba(52,199,89,.25);
    }

    /* Focus del primo blocco quando la tab esterna è "scanner" */
    .scanner-focus{
      outline: 2px solid rgba(10,132,255,.35);
      box-shadow: 0 16px 36px rgba(10,132,255,.28), 0 10px 24px rgba(0,0,0,.18);
    }

    /* Garantisco priorità click su STEP1 */
    #section1 { position: relative; z-index: 10; }

    /* Titolo step */
    [data-sso] .step-title{ color:#111; font-size:14px; opacity:.95; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
    [data-sso] .step-badge{ background:#f1f1f5; color:#111; border-radius:999px; padding:2px 8px; font-size:12px; border:1px solid #e2e2e8; }
    [data-sso] .step-badge.done{ background:linear-gradient(180deg,#eafff2,#b8ffd4); color:#073; font-weight:900; border-color:#a4f5c4; text-shadow:none; }
    @keyframes pulse-badge { 0%,100{ transform:scale(1); box-shadow:0 0 0 0 rgba(10,132,255,0);} 50%{ transform:scale(1.1); box-shadow:0 0 0 6px rgba(10,132,255,.15);} }
    [data-sso] .step-badge.pulse{ animation:pulse-badge 1.2s ease-in-out infinite; background:linear-gradient(180deg, #0a84ff, #0569c9); color:#fff; border-color:#0569c9; }

    .seg-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .seg-label{ font-size:13px; color:#222; opacity:.95; min-width:120px; font-weight:800; } /* più bold */
    .seg{ display:flex; background:#121214; border:1px solid var(--border); border-radius:999px; overflow:auto; -webkit-overflow-scrolling:touch; }
    .seg .opt{ padding:8px 12px; font-size:14px; border:0; background:transparent; color:#fff; cursor:pointer; white-space:nowrap; }
    .seg .opt.active{ background:linear-gradient(180deg, #b8ffd4, #a4f5c4); color:#003b1f; font-weight:900; border-radius:999px; box-shadow:0 6px 18px rgba(120,255,180,.35), inset 0 1px 0 rgba(255,255,255,.35); }

    .chips{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .chip{ background:#121214; color:#fff; padding:10px 12px; border-radius:999px; font-size:14px; border:1px solid var(--border); cursor:pointer; white-space:nowrap; }
    .chip.active{ background:linear-gradient(180deg, #b8ffd4, #a4f5c4); color:#003b1f; font-weight:900; box-shadow:0 6px 18px rgba(120,255,180,.35), inset 0 1px 0 rgba(255,255,255,.35); border-color:transparent; }

    .custom{ display:flex; gap:8px; margin-top:10px; }
    .custom input{ flex:1; padding:10px 12px; border-radius:999px; border:1px solid #d2d2d7; background:#f2f2f5; color:#111; font-size:14px; }
    .custom input::placeholder{ color:#3a3a3f; } /* più scuro */
    .custom button{ padding:12px 14px; border-radius:999px; border:0; background:#e6e6ea; color:#111; font-weight:800; cursor:pointer; }

    .selected-zone{ margin-top:10px; padding:10px 12px; border-radius:16px; background:#fafafa; border:1px solid #e6e6ea; display:flex; align-items:center; gap:8px; font-weight:600; color:#222; }
    .selected-zone.active{ background:#ffd60a; color:#000; box-shadow:0 4px 14px rgba(0,0,0,.18); border-color:#e6c408; }
    .selected-dot{ width:10px; height:10px; border-radius:999px; background:var(--ok); display:inline-block; }

    .video-wrap{
      width:100%; aspect-ratio:16/9; border-radius:var(--radius-inner);
      overflow:hidden; border:1px solid #e6e6ea; margin-top:10px;
      background:#000; position:relative; display:block; z-index: 0;
      pointer-events:auto;
    }
    @media (max-width:600px){ .video-wrap{ height:56vw; aspect-ratio:auto; } }
    .video-wrap.paused::after{
      content:"La scansione è in pausa"; position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      backdrop-filter:blur(6px) brightness(.7); color:#fff; font-weight:800; letter-spacing:.6px;
      pointer-events:none;
    }

    /* overlay guida barcode */
    .qr-guide{ position:absolute; left:50%; top:30%; transform:translate(-50%,-50%); height:30%; width:auto; opacity:.95; display:none; pointer-events:none; border-radius:8px; border:1px solid rgba(255,255,255,.25); }
    .qr-hint{ position:absolute; left:50%; top:66%; transform:translate(-50%,-50%); max-width:80%; width:80%; color:#fff; font-weight:800; font-size:13px; letter-spacing:.2px; line-height:1.25; background:rgba(0,0,0,.45); padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.2); display:none; text-align:center; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; pointer-events:none; }

    .dup-msg{ position:absolute; left:50%; top:8%; transform:translateX(-50%); width:90%; max-width:680px; padding:10px 14px; border-radius:14px; background:rgba(0,0,0,.65); color:#fff; font-weight:800; letter-spacing:.2px; text-align:center; opacity:0; pointer-events:none; transition:opacity .2s ease; border:1px solid rgba(255,255,255,.2); display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.25; }
    .dup-msg.show{ opacity:1; }

    video{ display:none; width:100%; height:100%; object-fit:cover; object-position:center; background:#000; }

    .placeholder{ position:absolute; inset:0; border:1px dashed #d8d8de; border-radius:var(--radius-inner); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; color:#777; text-align:left; padding:15px; }
    .ph-row{ display:flex; align-items:center; gap:12px; justify-content:center; width:100%; }
    .ph-icon{ width:36px; height:36px; opacity:.9; }

    .box{ border:1px solid var(--border); border-radius:var(--radius-inner); padding:12px; background:#0b0b0b; margin-top:10px; color:#fff; }
    .label{ font-size:12px; opacity:.85; margin-bottom:4px; }
    .zone-line{ font-size:15px; font-weight:700; margin-bottom:8px; }
    .list{ display:flex; flex-wrap:wrap; gap:8px; min-height:44px; }

    .pill{ display:inline-flex; align-items:center; justify-content:center; background:#ffd60a; color:#000; font-weight:800; font-size:15px; line-height:1; padding:0 10px; border-radius:999px; box-shadow:0 1px 0 rgba(255,255,255,.25) inset, 0 4px 12px rgba(0,0,0,.25); border:1px solid #e6c408; }
    .pill.n1{ width:36px; height:36px; padding:0; }
    .pill.n2{ min-width:40px; height:36px; }
    .pill.n3{ min-width:48px; height:36px; }

    .summary{ margin-top:10px; font-size:12px; opacity:.75; }
    .divider{ height:0.75px; background:#fff; opacity:.18; margin:10px 0 12px; border-radius:1px; }

    /* --- Aggiunta manuale (ora nel blocco 2) --- */
    .manual-wrap{ margin-top:12px; background:transparent; box-shadow:none; } /* niente sfumature/blu */
    .manual-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .keypad{ display:none; margin-top:10px; }
    .keypad.show{ display:block; }
    .key-display{ height:44px; border:1px solid var(--border); border-radius:16px; background:#111; color:#fff; display:flex; align-items:center; justify-content:flex-end; padding:0 12px; font-weight:800; font-size:18px; letter-spacing:.8px; }
    .keys{ margin-top:8px; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; }
    .key{ height:48px; border-radius:16px; border:1px solid #2c2c2e; background:#1a1a1d; color:#fff; font-weight:800; font-size:18px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; }
    .key.action{ background:#2a2a2d; }
    .key.confirm{ background:#ffd60a; color:#000; }

    .btn{ padding:14px 16px; border:0; border-radius:24px; font-size:16px; font-weight:700; color:#fff; cursor:pointer; transition: filter .15s ease, opacity .15s ease, background-color .15s ease, color .15s ease; display:inline-flex; align-items:center; justify-content:center; line-height:1; gap:10px; }
    .btn:disabled{ opacity:.7; cursor:not-allowed; filter:none; }
    .primary{ background:var(--accent); }
    .ghost{ background:#4b4b4e; color:#ddd; }
    .danger{ background:var(--danger); }
    .success{ background:var(--success); color:#001f0f; }
    .btn-yellow{ background:var(--yellow); color:#000; }
    .btn.pause{ background:#5a5a5e; color:#fff; }
    .btn.resume{ background:var(--success); color:#001f0f; }
    .pause-ico, .play-ico{ margin-left:8px; font-weight:900; }

    /* Icone bianche animate e più grandi */
    .btn .ico{ display:inline-flex; width:22px; height:22px; }
    .btn .ico svg{ width:100%; height:100%; display:block; }
    @keyframes nudgeUp { 0%{ transform:translateY(0) } 50%{ transform:translateY(-3px) } 100%{ transform:translateY(0) } }
    @keyframes blink { 0%,49%{ opacity:1 } 50%,100%{ opacity:.2 } }
    .btn-send .ico { animation: nudgeUp 1.1s ease-in-out infinite; }
    .btn-cancel .ico { animation: blink 1s steps(2,end) infinite; }

    .controls{ display:flex; gap:10px; align-items:center; }
    .controls.nowrap{ flex-wrap:nowrap; }
    .controls .spacer{ flex:1; }
    .controls.split .btn{ flex:1; }
    #section3 .controls.split .btn{ font-size:18px; padding:21px 16px; }

    .icon-btn{
      width:44px; height:44px; border-radius:999px; position:relative;
      border:1px solid #e6e6ea; background:#fff; color:#000;
      display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.6), 0 4px 10px rgba(0,0,0,.12);
      overflow:visible;
      z-index: 1;
    }

    /* TORCIA – cono verso l'alto */
    @keyframes torch-breathe {
      0%, 100% { transform:translateX(-50%) scale(1); opacity:1; }
      50%      { transform:translateX(-50%) scale(1.05); opacity:.96; }
    }
    .icon-btn.torch-on{
      background:var(--torch-on); color:#111; border-color:#d8be07;
      box-shadow:
        0 0 0 1px rgba(216,190,7,.45) inset,
        0 10px 22px rgba(0,0,0,.18),
        0 0 40px rgba(255,214,10,.65),
        0 0 120px rgba(255,214,10,.5);
    }
    .icon-btn.torch-on::before{
      content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:200px; height:200px; border-radius:50%;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,240,170,0.98) 0%,
          rgba(255,228,120,0.78) 35%,
          rgba(255,214,10,0.48) 62%,
          rgba(255,214,10,0.00) 80%);
      filter:blur(10px);
      mix-blend-mode:screen;
      pointer-events:none;
      animation: torch-breathe 1.6s ease-in-out infinite;
    }
    .icon-btn.torch-on::after{
      content:""; position:absolute; left:50%; top:-44px; transform:translateX(-50%);
      width: 520px; height: 700px;
      background:
        linear-gradient(0deg,
          rgba(255,240,170,0.96) 0%,
          rgba(255,228,120,0.82) 12%,
          rgba(255,220,80,0.52) 48%,
          rgba(255,214,10,0.24) 72%,
          rgba(255,214,10,0.00) 100%);
      /* cono verso l'alto */
      clip-path: polygon(50% 0%, 92% 100%, 8% 100%);
      filter: blur(12px) saturate(125%);
      mix-blend-mode: screen;
      pointer-events:none;
    }
    .icon-btn:active{ transform:scale(.97); }
    .icon-btn svg{ width:22px; height:22px; display:block; }

    .torch-wrap{ display:flex; align-items:center; gap:7px; }
    .torch-label{ font-size:15px; line-height:1.05; text-align:right; opacity:.9; text-transform:lowercase; color:#222; }
    .torch-label strong{ display:block; text-transform:uppercase; }

    .spacer{ height:1px; }

    /* Contenitore esterno del pulsante finale */
    .btn-new-outer{
      width:var(--pane-w);
      max-width:var(--pane-max);
      margin:16px auto 0;
      display:none;
    }
    .btn-new-outer .btn{ width:100%; }

    /* PATCH: nessuno pseudo-elemento può bloccare i tap */
    *::before, *::after{ pointer-events:none !important; }
  </style>
</head>
<body>
  <div data-sso>
    <div class="wrap">

      <!-- (RIMOSSA) Pillola versione -->

      <!-- STEP 1 -->
      <div class="section active" id="section1">
        <div class="step-title"><span class="step-badge" id="badge1">1</span> Seleziona la zona che stai per scansionare</div>

        <div class="seg-row">
          <div class="seg-label">CELLA NEGOZIO</div>
          <div class="seg" id="segNegozio">
            <button class="opt" data-zone="NEGOZIO - SOPRA" type="button">SOPRA</button>
            <button class="opt" data-zone="NEGOZIO - SOTTO" type="button">SOTTO</button>
          </div>
        </div>

        <div class="seg-row">
          <div class="seg-label">CELLA CAMION</div>
          <div class="seg" id="segCamion">
            <button class="opt" data-zone="CAMION - SOPRA" type="button">SOPRA</button>
            <button class="opt" data-zone="CAMION - SOTTO" type="button">SOTTO</button>
          </div>
        </div>

        <div class="chips">
          <button class="chip" data-zone="CARNE" type="button">CELLA CARNE</button>
          <button class="chip" data-zone="SCALE" type="button">SCALE</button>
        </div>

        <div class="custom">
          <input id="customZone" placeholder="Scrivi tu la zona..">
          <button id="useCustom" type="button">Usa</button>
        </div>

        <div class="selected-zone" id="selectedZone"><span class="selected-dot"></span> <span id="loc">Nessuna zona selezionata</span></div>
      </div>

      <!-- STEP 2 -->
      <div class="section" id="section2">
        <div class="step-title"><span class="step-badge" id="badge2">2</span> Avvia scansione</div>

        <div class="controls nowrap">
          <button id="btnScan" class="btn primary" type="button">Avvia scansione</button>
          <div class="spacer"></div>
          <div class="torch-wrap">
            <div class="torch-label"><span>torcia</span><strong id="torchState">OFF</strong></div>
            <button id="btnTorch" class="icon-btn" title="Torcia" aria-label="Torcia" type="button">
              <svg viewBox="0 0 512 512" aria-hidden="true">
                <path d="M128 96h256v64l-64 96v128a64 64 0 0 1-64 64h-0a64 64 0 0 1-64-64V256l-64-96V96z" fill="currentColor"/>
                <rect x="208" y="48" width="96" height="24" rx="12" fill="currentColor"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="video-wrap" id="videoWrap">
          <img id="qrGuide" class="qr-guide" style="display:none" src="https://i.etsystatic.com/42904695/r/il/09d9a7/4896461065/il_fullxfull.4896461065_kktw.jpg" alt="Guida barcode" />
          <div id="qrHint" class="qr-hint" style="display:none">Scansiona il codice a barre</div>
          <video id="video" playsinline muted></video>

          <div id="placeholder" class="placeholder">
            <div class="ph-row">
              <svg class="ph-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4 7h3l1.5-2h7L17 7h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Z" stroke="currentColor" stroke-width="1.5"/>
                <circle cx="12" cy="13" r="3.5" stroke="currentColor" stroke-width="1.5"/>
              </svg>
              <span>La fotocamera comparirà qui dopo aver cliccato “Avvia scansione”.</span>
            </div>
            <div class="ph-row">
              <svg class="ph-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4 10h3l4-3v10l-4-3H4z" stroke="currentColor" stroke-width="1.5"/>
                <path d="M16 8a5 5 0 0 1 0 8M14 10a3 3 0 0 1 0 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              <span>Attiva il volume per un’esperienza migliore e più intuitiva.</span>
            </div>
          </div>

          <div id="dupMsg" class="dup-msg">già scansionato, passa al prossimo ordine.</div>
        </div>

        <!-- *** Aggiunta manuale spostata qui (Blocco 2) *** -->
        <div class="manual-wrap">
          <div class="manual-controls">
            <button id="toggleKeypad" class="btn ghost" type="button">Aggiungi manualmente</button>
          </div>
          <div class="keypad" id="keypad">
            <div class="key-display" id="keyDisplay">—</div>
            <div class="keys">
              <div class="key">1</div><div class="key">2</div><div class="key">3</div>
              <div class="key">4</div><div class="key">5</div><div class="key">6</div>
              <div class="key">7</div><div class="key">8</div><div class="key">9</div>
              <div class="key action" data-act="back">⌫</div>
              <div class="key">0</div>
              <div class="key confirm" data-act="ok">Aggiungi</div>
            </div>
          </div>
        </div>
        <!-- *** /Aggiunta manuale *** -->

      </div>

      <!-- STEP 3 -->
      <div class="section" id="section3">
        <div class="step-title"><span class="step-badge" id="badge3">3</span> Verifica e Conferma</div>
        <div class="box">
          <div class="label">Zona</div>
          <div class="zone-line" id="zoneLine">—</div>
          <div class="list" id="list"></div>
          <div class="summary" id="summary">0 ordini in memoria</div>

          <div class="divider"></div>

          <div class="controls split" style="margin-top:0;">
            <!-- Bottoni finali aggiornati -->
            <button id="btnCopy" class="btn success btn-send" disabled type="button" title="Termina e invia">
              <span class="ico" aria-hidden="true">
                <!-- freccia verso l'alto -->
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 5l0 14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                  <path d="M6 9l6-6 6 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span>Termina e invia</span>
            </button>
            <button id="btnClear" class="btn danger btn-cancel" disabled type="button" title="Annulla">
              <span class="ico" aria-hidden="true">
                <!-- X lampeggiante -->
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 7l10 10M17 7L7 17" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <span>Annulla</span>
            </button>
          </div>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="section" id="section4" style="display:none">
        <div class="step-title"><span class="step-badge" id="badge4">4</span> Invio scansioni</div>
        <div class="box gradient-border" id="step4Box"></div>
        <div class="progress-done" id="pDoneOuter" style="display:none">
          <button id="btnNew" class="btn btn-yellow" type="button">Nuova scansione</button>
        </div>
      </div>

      <!-- Pulsante finale FUORI dal blocco 4 -->
      <div id="btnNewOuter" class="btn-new-outer"></div>

      <div class="spacer"></div>
    </div>
  </div>

  <script>
  (function(){
    const SECTION = (document.currentScript && document.currentScript.closest('[data-view]')) || document;
    const root = SECTION.querySelector('[data-sso]');
    if (!root) { console.warn('Scanner: [data-sso] non trovato nel suo container'); return; }

    const $  = (sel) => root.querySelector(sel);
    const $$ = (sel) => Array.from(root.querySelectorAll(sel));
    const S  = (sel) => SECTION.querySelector(sel);

    const loc = $('#loc');
    const zoneLine = $('#zoneLine');
    const list = $('#list');
    const badge1 = $('#badge1');
    const badge2 = $('#badge2');
    const badge3 = $('#badge3');
    const badge4 = S('#badge4');
    const selectedZoneBox = $('#selectedZone');
    const videoWrap = S('#videoWrap');
    const video = $('#video');
    const placeholder = $('#placeholder');
    const dupMsg = S('#dupMsg');
    const qrGuide = S('#qrGuide');
    const qrHint  = S('#qrHint');
    const btnScan = $('#btnScan');
    const btnClear= $('#btnClear');
    const btnCopy = $('#btnCopy');
    const btnTorch= S('#btnTorch');
    const torchState = S('#torchState');
    const step4 = S('#section4');
    const step4Box = S('#step4Box');
    const pDoneOuter = S('#pDoneOuter');
    const btnNewExternal = S('#btnNew');
    const btnNewOuter = S('#btnNewOuter');

    // Manual keypad (ora nel blocco 2)
    const toggleKeypadBtn = S('#toggleKeypad');
    const keypad = S('#keypad');
    const keyDisplay = S('#keyDisplay');

    let currentZone = null;
    const data = {};
    let stream = null;
    let videoTrack = null;

    let qrPaused = false;
    let qrRunning = false;
    let hasEverStarted = false;
    let scanningLocked = false;
    let dupTimer = null;
    let firstScanDone = false;

    // === CONFIG GOOGLE FORM ===
    const GFORM = {
      ACTION: "https://docs.google.com/forms/d/e/1FAIpQLSdixUK5TjPdfYMeso-XXTJHYy2Vy23F44j5FEMWFddWRfRh7Q/formResponse",
      ENTRY_ZONE:   "entry.1910612286",
      ENTRY_ORDERS: "entry.1223265482"
    };

    /* Guida barcode visibile solo a inizio scansione */
    if (qrGuide) qrGuide.style.display = 'none';
    if (qrHint)  qrHint.style.display  = 'none';

    /* Sblocco difensivo click & type */
    $$('#segNegozio .opt, #segCamion .opt, .chip, #useCustom').forEach(el=>{
      if (el.tagName === 'BUTTON' && !el.hasAttribute('type')) el.setAttribute('type','button');
      el.removeAttribute('disabled');
      el.style.pointerEvents = 'auto';
    });
    const s1 = S('#section1'); if (s1) s1.style.zIndex = '10';

    /* Audio feedback */
    const AC = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    function ensureAC(){ if (!audioCtx) audioCtx = new AC(); return audioCtx; }
    function playTone(freq=880, dur=0.16, type='sine', gain=0.2, delay=0){
      try{
        const ac = ensureAC();
        const o = ac.createOscillator(), g = ac.createGain();
        o.type = type; o.frequency.value = freq; o.connect(g); g.connect(ac.destination);
        const now = ac.currentTime + (delay||0);
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
        o.start(now); o.stop(now + dur + 0.02);
      }catch(_){}}
    function soundZoneChange(){ playTone(660, 0.09, 'triangle', 0.18); }
    function soundScanOK(){  playTone(1046.5, 0.10, 'sine', 0.22, 0.00); playTone(1318.5, 0.11, 'sine', 0.20, 0.07); }
    function soundScanDuplicate(){ playTone(392, 0.18, 'square', 0.22); }

    badge1.classList.add('pulse');

    function markActive(sectionId){
      $$('.section').forEach(s=>s.classList.remove('active'));
      const sec = S('#'+sectionId);
      if (sec) sec.classList.add('active');
    }

    function clearZoneSelectionsUI(){
      $$('.opt,.chip').forEach(b=>b.classList.remove('active'));
      selectedZoneBox.classList.remove('active');
      if (loc) loc.textContent = 'Nessuna zona selezionata';
      if (zoneLine) zoneLine.textContent = '—';
    }

    function select(z){
      if (scanningLocked){
        alert('Non puoi cambiare zona dopo aver avviato la scansione.');
        return;
      }
      currentZone = z;
      if (loc) loc.textContent = z;
      if (zoneLine) zoneLine.textContent = z;
      renderList();

      $$('.seg-label').forEach(l=>l.classList.remove('active'));
      $$('.seg').forEach(s=>s.classList.remove('active'));
      $$('.chip').forEach(c=>c.classList.remove('active'));
      selectedZoneBox.classList.remove('active');

      if(z.startsWith('NEGOZIO')){
        $('#segNegozio').previousElementSibling.classList.add('active');
        $('#segNegozio').classList.add('active');
      }
      if(z.startsWith('CAMION')){
        $('#segCamion').previousElementSibling.classList.add('active');
        $('#segCamion').classList.add('active');
      }
      if(z.startsWith('CARNE') || z.startsWith('SCALE')){
        const chip = [...$$('.chip')].find(c => c.dataset.zone===z);
        if(chip) chip.classList.add('active');
      }

      badge1.classList.remove('pulse');
      badge1.classList.add('done');
      badge2.classList.add('pulse');

      S('#section1').classList.add('active');
      selectedZoneBox.classList.add('active');

      soundZoneChange();
    }

    function pillClassFor(num){
      const len = String(num).length;
      if (len === 1) return 'pill n1';
      if (len === 2) return 'pill n2';
      return 'pill n3';
    }

    function updateSummaryFor(zone){
      const arr = (data[zone]||[]);
      const unique = new Set(arr).size;
      const summary = $('#summary');
      if (summary) {
        const label = unique === 1 ? 'ordine' : 'ordini';
        summary.textContent = `${unique} ${label} in memoria`;
      }
    }

    function renderList(){
      list.innerHTML='';
      const arr = (data[currentZone]||[]).slice().sort((a,b)=>a-b);
      if (!arr.length){ list.innerHTML = '<em style="opacity:.7">Nessun numero</em>'; }
      for (const n of arr){
        const s = document.createElement('span');
        s.className = pillClassFor(n);
        s.textContent = n;
        list.appendChild(s);
      }
      updateSummaryFor(currentZone || '_');
    }

    function showDuplicateOverlay(){
      if (!dupMsg) return;
      dupMsg.classList.add('show');
      clearTimeout(dupTimer);
      dupTimer = setTimeout(()=>dupMsg.classList.remove('show'), 1200);
    }

    function setActionButtonsEnabled(enabled){
      btnCopy.disabled = !enabled;
      btnClear.disabled = !enabled;
    }

    function hideQrGuideOnce(){
      if (!firstScanDone){
        firstScanDone = true;
        if (qrGuide) qrGuide.style.display = 'none';
        if (qrHint)  qrHint.style.display  = 'none';
      }
    }

    function addScanned(val){
      if (!currentZone){ alert('Seleziona prima una zona.'); return; }
      if (val < 1 || val > 999) { alert('Sono ammessi solo valori da 1 a 999.'); return; }
      if (!data[currentZone]) data[currentZone] = [];
      if (!data[currentZone].includes(val)) {
        data[currentZone].push(val);
        renderList();
        soundScanOK();
        setActionButtonsEnabled(true);
        hideQrGuideOnce();
      } else {
        soundScanDuplicate();
        showDuplicateOverlay();
        hideQrGuideOnce();
      }
    }

    // --- Inserimento manuale ---
    let manualBuffer = "";
    function refreshManualDisplay(){ if (keyDisplay) keyDisplay.textContent = manualBuffer.length ? manualBuffer : '—'; }

    if (toggleKeypadBtn) {
      toggleKeypadBtn.addEventListener('click', ()=>{
        if (!currentZone){
          alert('Seleziona prima una zona per poter inserire manualmente.');
          return;
        }
        keypad.classList.toggle('show');
        if (!keypad.classList.contains('show')) {
          manualBuffer = "";
          refreshManualDisplay();
        }
      });
    }

    if (keypad){
      keypad.addEventListener('click', (e)=>{
        const k = e.target.closest('.key'); if (!k) return;
        const act = k.dataset.act;
        if (act === 'back'){ manualBuffer = manualBuffer.slice(0,-1); refreshManualDisplay(); return; }
        if (act === 'ok'){
          if (!manualBuffer) return;
          const n = parseInt(manualBuffer, 10);
          if (Number.isFinite(n) && n >= 1 && n <= 999) { addScanned(n); }
          else { alert('Inserisci un valore da 1 a 999.'); }
          manualBuffer = ""; refreshManualDisplay(); return;
        }
        const digit = k.textContent.trim();
        if (/^\d$/.test(digit)){
          const next = (manualBuffer + digit).replace(/^0+(\d)/,'$1');
          if (next.length <= 3) { manualBuffer = next; refreshManualDisplay(); }
        }
      });
    }

    // Selettori zona
    $$('#segNegozio .opt, #segCamion .opt, .chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (scanningLocked){ alert('Non puoi cambiare zona dopo aver avviato la scansione.'); return; }
        $$('.opt, .chip').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        select(btn.dataset.zone);
      });
      btn.style.pointerEvents = 'auto';
    });
    const useCustom = $('#useCustom');
    if (useCustom){
      useCustom.addEventListener('click', ()=>{
        if (scanningLocked){ alert('Non puoi cambiare zona dopo aver avviato la scansione.'); return; }
        const v = ($('#customZone').value||'').trim(); if (!v) return;
        $$('.opt,.chip').forEach(b=>b.classList.remove('active'));
        select(v);
      });
    }

    // === Camera / BARCODE (Code 39) ===
    async function openCamera(){
      if (!currentZone){ alert('Seleziona una zona.'); return; }
      try{
        const constraints = {
          audio:false,
          video:{ facingMode:{ ideal:'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 } }
        };

        video.setAttribute('playsinline',''); video.setAttribute('muted',''); video.muted = true;
        await stopCamera();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          throw new Error('getUserMedia non disponibile (HTTPS? permessi bloccati?)');
        }

        const streamLocal = await navigator.mediaDevices.getUserMedia(constraints);
        stream = streamLocal;
        video.srcObject = stream;
        await video.play();
        videoTrack = stream.getVideoTracks()[0];

        firstScanDone = false;
        if (qrGuide) qrGuide.style.display = 'block';
        if (qrHint)  qrHint.style.display  = 'block';

        if (window.startQR) {
          window.startQR(video, (text) => {
            if (qrPaused) return;
            const match = text.match(/\d+/g);
            if (!match) return;
            for (const m of match) addScanned(parseInt(m, 10));
          });
          qrRunning = true;
        }

        markActive('section2');
        video.style.display='block';
        if (placeholder) placeholder.style.display='none';

        badge2.classList.remove('pulse'); badge2.classList.add('done'); badge3.classList.add('pulse');

        hasEverStarted = true;
        scanningLocked = true;
        lockZoneSelectors(true);

        setScanButton_active();
        setActionButtonsEnabled(true);

      } catch(err){
        console.error(err);
        alert('Non riesco ad aprire la fotocamera.\n- Sito in HTTPS?\n- Permesso camera concesso al browser?\n\n' + (err && err.name ? 'Errore: '+err.name : ''));
      }
    }

    function lockZoneSelectors(lock){
      $$('#segNegozio .opt, #segCamion .opt, .chip, #useCustom').forEach(el=>{
        if (lock) el.setAttribute('disabled','disabled');
        else el.removeAttribute('disabled');
      });
      const customInput = $('#customZone');
      if (customInput) customInput.disabled = !!lock;
    }

    async function stopCamera(){
      if (window.stopQR) window.stopQR();
      qrRunning = false; qrPaused = false;
      if (videoWrap) videoWrap.classList.remove('paused');

      if (stream){ for (const t of stream.getTracks()) t.stop(); stream = null; }
      try{ video.pause(); }catch(_){ }
      video.srcObject = null;
      videoTrack = null;

      if (qrGuide) qrGuide.style.display = 'none';
      if (qrHint)  qrHint.style.display  = 'none';

      setScanButton_start();
    }

    function setScanButton_start(){
      btnScan.textContent = 'Avvia scansione';
      btnScan.classList.remove('pause','resume','success');
      btnScan.classList.add('primary');
    }
    function setScanButton_active(){
      btnScan.innerHTML = 'Pausa scansione <span class="pause-ico">⏸</span>';
      btnScan.classList.remove('primary','resume','success');
      btnScan.classList.add('pause');
    }
    function setScanButton_paused(){
      btnScan.innerHTML = 'Riprendi scansione <span class="play-ico">▶</span>';
      btnScan.classList.remove('primary','pause');
      btnScan.classList.add('resume','success');
    }

    btnScan.addEventListener('click', async ()=>{
      if (!hasEverStarted || !stream){ await openCamera(); return; }
      if (!qrPaused){
        qrPaused = true;
        if (window.stopQR) window.stopQR();
        qrRunning = false;
        if (videoWrap) videoWrap.classList.add('paused');
        setScanButton_paused();
        setActionButtonsEnabled(true);
      } else {
        if (window.startQR){
          window.startQR(video, (text)=>{
            if (qrPaused) return;
            const match = text.match(/\d+/g);
            if (!match) return;
            for (const m of match) addScanned(parseInt(m, 10));
          });
          qrRunning = true;
        }
        qrPaused = false;
        if (videoWrap) videoWrap.classList.remove('paused');
        setScanButton_active();
        setActionButtonsEnabled(true);
      }
    });

    if (btnTorch){
      btnTorch.addEventListener('click', async ()=>{
        try {
          if (!videoTrack) {
            await openCamera();
            if (!videoTrack) return;
          }
          const caps = videoTrack.getCapabilities && videoTrack.getCapabilities();
          if (!caps || !caps.torch) { alert('Torcia non supportata su questo dispositivo'); return; }
          const settings = videoTrack.getSettings && videoTrack.getSettings();
          const current = settings && settings.torch ? true : false;
          await videoTrack.applyConstraints({ advanced: [{ torch: !current }] });
          const on = !current;
          btnTorch.classList.toggle('torch-on', on);
          if (torchState) torchState.textContent = on ? 'ON' : 'OFF';
        } catch (e) { console.error(e); }
      });
    }

    async function copyCurrentPayloadToClipboard(){
      const zone = currentZone || '';
      const arr = (data[zone]||[]).slice().sort((a,b)=>a-b);
      const payload = JSON.stringify({ zona: zone, ordini: arr }, null, 0);
      try { await navigator.clipboard.writeText(payload); } catch(_){}
      return payload;
    }

    function submitToGoogleForm({ zona, ordini }) {
      if (!GFORM.ACTION || !GFORM.ENTRY_ZONE || !GFORM.ENTRY_ORDERS) {
        console.warn("Google Form non configurato.");
        return false;
      }
      const zoneVal   = (zona || "-").trim();
      const ordersVal = (Array.isArray(ordini) && ordini.length) ? ordini.join(",") : "-";

      let iframe = S("#hidden_iframe_gform");
      if (!iframe) {
        iframe = document.createElement("iframe");
        iframe.name = "hidden_iframe_gform";
        iframe.id   = "hidden_iframe_gform";
        iframe.style.display = "none";
        SECTION.appendChild(iframe);
      }

      const form = document.createElement("form");
      form.action = GFORM.ACTION;
      form.method = "POST";
      form.target = "hidden_iframe_gform";

      const inZone = document.createElement("input");
      inZone.type  = "hidden";
      inZone.name  = GFORM.ENTRY_ZONE;
      inZone.value = zoneVal;
      form.appendChild(inZone);

      const inOrders = document.createElement("input");
      inOrders.type  = "hidden";
      inOrders.name  = GFORM.ENTRY_ORDERS;
      inOrders.value = ordersVal;
      form.appendChild(inOrders);

      SECTION.appendChild(form);
      try { form.submit(); } finally { form.remove(); }
      return true;
    }

    async function fullReset(clearClipboard=true){
      await stopCamera();

      for (const k in data) delete data[k];
      list.innerHTML = '<em style="opacity:.7">Nessun numero</em>';
      const summary = $('#summary'); if (summary) summary.textContent = '0 ordini in memoria';

      if (clearClipboard){
        try { await navigator.clipboard.writeText(''); } catch(_){}
      }

      [badge1,badge2,badge3,badge4].forEach(b=>{ if(b) b.classList.remove('done','pulse'); });
      badge1.classList.add('pulse');

      S('#section1').classList.add('active');
      ['section2','section3'].forEach(id=>{
        const el = S('#'+id);
        if (el && id!=='section1') el.classList.remove('active');
      });

      video.style.display='none';
      if (placeholder) placeholder.style.display='block';
      if (videoWrap) videoWrap.classList.remove('paused');
      if (dupMsg) dupMsg.classList.remove('show');

      currentZone = null;
      clearZoneSelectionsUI();

      hasEverStarted = false;
      scanningLocked = false;
      lockZoneSelectors(false);
      setActionButtonsEnabled(false);
      setScanButton_start();

      if (btnTorch) btnTorch.classList.remove('torch-on');
      if (torchState) torchState.textContent = 'OFF';

      if (keypad) keypad.classList.remove('show');
      manualBuffer = ""; if (keyDisplay) keyDisplay.textContent = '—';

      firstScanDone = false;

      if (pDoneOuter) pDoneOuter.style.display = 'none';

      if (btnNewOuter && btnNewExternal) {
        btnNewOuter.style.display = 'none';
        pDoneOuter.appendChild(btnNewExternal);
      }
    }

    btnClear.addEventListener('click', async ()=>{
      await fullReset(true);
      if (step4) step4.style.display='none';
      window.scrollTo({ top:0, behavior:'smooth' });
    });

    const progressMessages = [
      'Stabilisco handshake con il server…',
      'Sincronizzo timestamp NTP…',
      'Operazioni crittografiche avanzate…',
      'Ottimizzo il flusso dei pacchetti…',
      'se non va, vai in chiesina e accendi un cero.'
    ];

    function startStep4Progress(){
      step4Box.innerHTML = `
        <style>
          .progress-outer{height:12px;border-radius:999px;background:#101010;border:1px solid #2a2a2a;overflow:hidden}
          .progress-inner{height:100%;width:0;background:linear-gradient(90deg,#0a84ff,#34c759);transition:width .2s ease;border-radius:999px}
          .progress-msg{margin-top:10px;font-size:13px;opacity:.9}
        </style>
        <div class="progress-wrap">
          <div class="progress-outer"><div class="progress-inner" id="pInner"></div></div>
          <div class="progress-msg" id="pMsg">Inizializzo…</div>
        </div>
      `;

      const pInner = S('#pInner');
      const pMsg = S('#pMsg');

      let pct = 0;

      const incTimer = setInterval(()=>{
        pct += Math.floor(Math.random()*4) + 3;
        if (pct >= 96) {
          pct = 96;
          clearInterval(incTimer);
          pMsg.textContent = progressMessages[progressMessages.length-1];
          setTimeout(()=>{
            pInner.style.width = '100%';
            pMsg.textContent = 'Completato ✔︎';

            if (btnNewOuter && btnNewExternal){
              btnNewOuter.innerHTML = '';
              btnNewOuter.appendChild(btnNewExternal);
              btnNewOuter.style.display = 'block';
              /* Auto-scroll per mostrare completamente il bottone */
              setTimeout(()=>{
                btnNewOuter.scrollIntoView({ behavior:'smooth', block:'center' });
              }, 60);
            }

            if (btnNewExternal){
              btnNewExternal.onclick = async ()=>{
                await fullReset(true);
                step4.style.display = 'none';
                window.scrollTo({ top:0, behavior:'smooth' });
              };
            }
          }, 4000);
        }
        pInner.style.width = pct + '%';
      }, 120);

      let msgIdx = 0;
      const cycle = setInterval(()=>{
        if (pct >= 96){ clearInterval(cycle); return; }
        pMsg.textContent = progressMessages[msgIdx % (progressMessages.length-1)];
        msgIdx++;
      }, 800);
    }

    btnCopy.addEventListener('click', async ()=>{
      const zoneForSubmit = currentZone || '';
      const arrForSubmit  = (data[zoneForSubmit] || []).slice().sort((a,b)=>a-b);

      await copyCurrentPayloadToClipboard();
      submitToGoogleForm({ zona: zoneForSubmit, ordini: arrForSubmit });

      btnCopy.disabled = true; btnClear.disabled = true;
      btnCopy.classList.remove('success'); btnCopy.classList.add('ghost');
      btnClear.classList.remove('danger'); btnClear.classList.add('ghost');

      if (keypad) keypad.classList.remove('show'); manualBuffer = ""; if (keyDisplay) keyDisplay.textContent = '—';
      if (currentZone && data[currentZone]) delete data[currentZone];
      list.innerHTML = '<em style="opacity:.7">Nessun numero</em>';
      const sum = $('#summary'); if (sum) sum.textContent = '0 ordini in memoria';

      clearZoneSelectionsUI();
      currentZone = null;
      scanningLocked = false;
      lockZoneSelectors(false);

      badge3.classList.remove('pulse'); badge3.classList.add('done');
      if (badge4) badge4.classList.add('pulse');

      step4.style.display = '';
      step4.classList.add('gradient-border');
      markActive('section4');

      startStep4Progress();
      step4.scrollIntoView({ behavior:'smooth', block:'start' });
    });

    lockZoneSelectors(false);

    /* Evidenziazione dinamica del blocco 1 quando tab = scanner */
    const section1 = S('#section1');
    function applyTabHighlight(tab){
      if (!section1) return;
      if (tab === 'scanner') {
        section1.classList.add('scanner-focus');
      } else {
        section1.classList.remove('scanner-focus');
      }
    }
    if (document.title.toLowerCase().includes('scanner')) applyTabHighlight('scanner');
    if (window.SSO_ACTIVE_TAB) applyTabHighlight(window.SSO_ACTIVE_TAB);
    Object.defineProperty(window, 'SSO_ACTIVE_TAB', {
      set(v){ applyTabHighlight(v); },
      get(){ return undefined; }
    });
    document.addEventListener('sso:tabchange', (e)=>{
      const tab = e?.detail?.tab;
      if (tab) applyTabHighlight(tab);
    });

    window.addEventListener('pagehide', async ()=>{ await stopCamera(); }, { once:true });
    window.addEventListener('beforeunload', async ()=>{ await stopCamera(); }, { once:true });
    document.addEventListener('visibilitychange', async ()=>{
      if (document.visibilityState === 'hidden') await stopCamera();
    });
  })();
  </script>

  <!-- Barcode scanner (Code 39): 1) BarcodeDetector, 2) fallback QuaggaJS -->
  <script type="module">
    let lastText = "";

    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = src; s.async = true;
        s.onload = ()=>resolve();
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    // --- BarcodeDetector (nativo) ---
    let bdStop = null;
    async function startWithBarcodeDetector(videoEl, onResult){
      if (!('BarcodeDetector' in window)) throw new Error('BarcodeDetector non presente');
      if (window.BarcodeDetector.getSupportedFormats) {
        const fmts = await window.BarcodeDetector.getSupportedFormats();
        if (!fmts || !fmts.includes('code_39')) throw new Error('code_39 non supportato nativamente');
      }
      const detector = new window.BarcodeDetector({ formats: ['code_39'] });
      let running = true;

      async function loop(){
        if (!running) return;
        try{
          const codes = await detector.detect(videoEl);
          if (codes && codes.length){
            for (const c of codes){
              const text = (c.rawValue || c.displayValue || '').trim();
              if (text && text !== lastText){
                lastText = text;
                try{ onResult(text); }catch(e){ console.error(e); }
                setTimeout(()=>{ lastText = ""; }, 800);
                break;
              }
            }
          }
        }catch(e){}
        if (running) requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
      bdStop = ()=>{ running = false; };
    }

    // --- QuaggaJS (fallback) ---
    let quaggaRunning = false;
    async function startWithQuagga(videoEl, onResult){
      if (!window.Quagga){
        await loadScript('https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js');
      }
      return new Promise((resolve, reject)=>{
        try{
          window.Quagga.init({
            inputStream: {
              name: "LiveStream",
              type: "LiveStream",
              target: videoEl,
              constraints: { facingMode: "environment" }
            },
            decoder: { readers: ["code_39_reader"] },
            locate: true
          }, (err)=>{
            if (err){ reject(err); return; }
            window.Quagga.start();
            quaggaRunning = true;
            window.Quagga.onDetected((res)=>{
              const code = res && res.codeResult && res.codeResult.code;
              if (!code) return;
              if (code !== lastText){
                lastText = code;
                try{ onResult(code); }catch(e){ console.error(e); }
                setTimeout(()=>{ lastText = ""; }, 800);
              }
            });
            resolve();
          });
        }catch(e){ reject(e); }
      });
    }

    // API compatibile
    window.startQR = async function(videoEl, onResult){
      try{
        await startWithBarcodeDetector(videoEl, onResult);
      }catch(_){
        await startWithQuagga(videoEl, onResult);
      }
    };

    window.stopQR = function(){
      try{ if (bdStop) bdStop(); }catch(_){}
      bdStop = null;
      try{
        if (window.Quagga && quaggaRunning){
          window.Quagga.stop();
          quaggaRunning = false;
        }
      }catch(_){}
    };
  </script>
</body>
</html>
