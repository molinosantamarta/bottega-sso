<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Stòc</title>
  <link rel="manifest" href="/bottega-sso/manifest.webmanifest">
  <meta name="theme-color" content="#770505">

  <!-- Icone iOS -->
  <link rel="apple-touch-icon" sizes="180x180" href="/bottega-sso/apple-touch-icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/bottega-sso/apple-touch-icon-167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/bottega-sso/apple-touch-icon-152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/bottega-sso/apple-touch-icon-120.png">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Stòc">

  <!-- Font: Titolo Playfair Display + Sottotitolo Barcode -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Libre+Barcode+128+Text&display=swap" rel="stylesheet">

  <style>
    html,body{height:100%;background:#000;margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;color:#eaeaea}
    .x-wrap{padding:8px 16px 24px;max-width:760px;margin:0 auto}

    header{text-align:center;padding:18px 12px 10px;position:relative;z-index:1}

    header h2{margin:0;font-family:'Playfair Display',serif;font-weight:700;letter-spacing:-0.02em;
      font-size:clamp(56px,8vw,88px);
      background:linear-gradient(135deg,#ffd60a 0%,#ffcc00 30%,#ffb700 60%,#ff9500 100%);
      background-size:400% 400%;
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
      animation:goldFlow 14s ease-in-out infinite, fadeInTitle 1.6s ease-out both;
    }
    @keyframes goldFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes fadeInTitle{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

    header h1{margin:10px 0 0;font-size:26px;font-weight:400;color:#fff;opacity:1;
      font-family:'Libre Barcode 128 Text', cursive;text-transform:uppercase;letter-spacing:.02em}

    .beta-row{display:flex;justify-content:center;margin-top:14px;position:relative;top:0}
    .beta-pill{display:inline-flex;align-items:center;justify-content:center;padding:5px 12px;border-radius:999px;
      background:#ffd60a;color:#000;font-weight:800;font-size:11px;border:1px solid #e6c408;
      box-shadow:0 1px 0 rgba(255,255,255,.25) inset,0 4px 12px rgba(0,0,0,.25);
      position:relative;overflow:hidden}
    /* Effetto luce non invasivo: overlay separato, non tocca il colore del testo */
    .beta-pill::after{content:"";position:absolute;inset:-30% -40%;
      background:linear-gradient(90deg,transparent 0,rgba(255,255,255,.55) 45%,rgba(255,255,255,.9) 50%,rgba(255,255,255,.55) 55%,transparent 100%);
      transform:translateX(-120%);animation:pillShine 6s linear infin
    @keyframes shine{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .hero-img-wrap{display:flex;align-items:center;justify-content:center;margin-top:6px;position:relative;z-index:1}
    .hero-img-wrap img{width:92px;max-width:106px;height:auto;border-radius:12px;position:relative}
    .hero-img-wrap img:first-child{left:10px;z-index:1}
    .hero-img-wrap img:last-child{right:0;margin-left:-10px;z-index:2;top:5px}

    .x-tabbar{margin-top:8px;display:flex;justify-content:center;position:relative;top:-16px;z-index:1}
    .x-tabbar-inner{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:92%;max-width:480px;padding:8px;border-radius:38px;background:#f7f7f7;border:0px solid rgba(0,0,0,.1);box-shadow:0 12px 28px rgba(0,0,0,.15)}
    .x-tab{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:10px 12px;border-radius:28px;text-decoration:none;cursor:pointer;-webkit-tap-highlight-color:transparent;color:#6b6b70;border:0px solid transparent;transition:background .15s,color .15s,border-color .15s,box-shadow .15s}
    .x-tab[aria-selected="true"]{background:#ffd60a;color:#000;font-weight:700;border-color:#e6c408;box-shadow:inset 0 1px 0 rgba(255,255,255,.06),0 6px 16px rgba(0,0,0,.35)}
    .ico-bubble{display:flex;align-items:center;justify-content:center;background:transparent;border:none;box-shadow:none;width:auto;height:auto;border-radius:0}
    .x-tabbar .x-tab[aria-selected="false"] span{color:#222}

    [data-view]{display:none; position:relative;}
    [data-view].active{display:block; z-index:5;}

    [data-view] [data-sso]{--pane-max:760px;--pane-gutter:0px}
    [data-view] [data-sso] .wrap{max-width:var(--pane-max);padding-left:0!important;padding-right:0!important;margin-left:auto;margin-right:auto}
    [data-view] [data-sso] .section,[data-view] [data-sso] .btn-new-outer{width:100%;max-width:var(--pane-max);margin-left:auto;margin-right:auto}

    .card{margin:14px auto 0;border-radius:16px;padding:22px;background:#0b0b0c;border:1px solid rgba(255,255,255,.08);min-height:110px;width:92%;max-width:760px}

    footer{margin-top:40px;text-align:center;font-size:12px;color:#8e8e8e;opacity:.6;letter-spacing:.3px}

    /* Fallback banner (solo in dev/offline) */
    .fallback-note{margin:12px auto 0;max-width:760px;font-size:12px;opacity:.7;color:#c8c8c8;text-align:center}
    .fallback-card{margin:14px auto 0;border-radius:16px;padding:22px;background:#0b0b0c;border:1px dashed rgba(255,255,255,.18);min-height:110px;width:92%;max-width:760px}
  </style>
</head>
<body>
  <div class="x-wrap">
    <header>
      <h2>Stòc</h2>
      <h1>Scanner & Stoccaggio Ordini</h1>
      <div class="beta-row"><span class="beta-pill">Dove la storia incontra il futuro.</span></div>
    </header>

    <div class="hero-img-wrap">
      <img src="https://static.wixstatic.com/media/9d749b_4e7e462b0d2e40448664f342bb2cd2b5~mv2.png/v1/fill/w_240,h_260,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/shopper%20bottega_anteprima_edited_edited_.png" alt="Immagine 1">
      <img src="https://community.appinventor.mit.edu/uploads/default/original/3X/c/2/c21a68fb6312af849c89a657cd12c56faf74dc8e.gif" alt="Animazione">
    </div>

    <nav class="x-tabbar" role="tablist" aria-label="Navigazione pagine">
      <div class="x-tabbar-inner">
        <a class="x-tab" role="tab" href="#a" data-tab="a" aria-selected="true">
          <span class="ico-bubble"><span id="lottie-stoccaggio" style="width:68px;height:68px"></span></span>
          <span>Stoccaggio</span>
        </a>
        <a class="x-tab" role="tab" href="#b" data-tab="b" aria-selected="false">
          <span class="ico-bubble"><span id="lottie-scanner" style="width:68px;height:68px"></span></span>
          <span>Scanner</span>
        </a>
      </div>
    </nav>

    <section id="view-a" data-view class="active" data-src="./stoccaggio.html">
      <div class="card">Caricamento…</div>
    </section>

    <section id="view-b" data-view data-src="./scanner.html">
      <div class="card">Caricamento…</div>
    </section>

    <footer>© Tutti i diritti riservati – La Bottega di Casterno</footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <script>
    // --- LOTTIE (tollerante a errori di rete) ---------------------------------
    try{
      lottie.loadAnimation({container:document.getElementById('lottie-scanner'),renderer:'svg',loop:true,autoplay:true,path:'./scanner.lotties.json'});
      lottie.loadAnimation({container:document.getElementById('lottie-stoccaggio'),renderer:'svg',loop:true,autoplay:true,path:'./shopping-cart.lotties.json'});
    }catch(e){ console.warn('Lottie non disponibile:', e); }

    // --- Utility --------------------------------------------------------------
    const VIEWS=['a','b'];
    const $=s=>document.querySelector(s);
    const $$=s=>Array.from(document.querySelectorAll(s));

    // Fallback inline per ambienti senza rete / file://
    const EMBEDDED_PAGES={
      './stoccaggio.html': `
        <div class="fallback-note">(Fallback inline) Stoccaggio</div>
        <div class="fallback-card">
          <h3 style="margin:0 0 8px;font:600 16px/1.2 system-ui">Stoccaggio</h3>
          <p style="margin:0;color:#cfcfcf">Questa è una versione di anteprima. La pagina esterna <code>stoccaggio.html</code> non è stata caricata (offline o percorso non trovato).</p>
        </div>`,
      './scanner.html': `
        <div class="fallback-note">(Fallback inline) Scanner</div>
        <div class="fallback-card">
          <h3 style="margin:0 0 8px;font:600 16px/1.2 system-ui">Scanner</h3>
          <p style="margin:0;color:#cfcfcf">Questa è una versione di anteprima. La pagina esterna <code>scanner.html</code> non è stata caricata (offline o percorso non trovato).</p>
        </div>`
    };

    // Caricamento pagine esterne con fallback robusto
    const loadedStyles=new Set();

    function isHttpContext(){ return location.protocol==='http:' || location.protocol==='https:'; }

    async function fetchTextSafe(url, opts){
      if(!isHttpContext()) throw new Error('Contesto non-HTTP (es. file://).');
      const res=await fetch(url, opts);
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.text();
    }

    async function loadExternalInto(section){
      const url=section.getAttribute('data-src');
      if(!url||section.dataset.loaded==='true') return;

      try{
        const html=await fetchTextSafe(url,{credentials:'same-origin'});
        const doc=new DOMParser().parseFromString(html,'text/html');

        // Inietto <style> PRIMA del contenuto per evitare flash
        doc.querySelectorAll('style').forEach(styleEl=>{
          const s=document.createElement('style'); s.textContent=styleEl.textContent; document.head.appendChild(s);
        });
        // Eventuali CSS esterni
        doc.querySelectorAll('link[rel="stylesheet"]').forEach(link=>{
          const href=link.getAttribute('href'); if(!href) return;
          const abs=new URL(href, url).href;
          if(loadedStyles.has(abs)) return;
          const l=document.createElement('link'); l.rel='stylesheet'; l.href=abs; document.head.appendChild(l);
          loadedStyles.add(abs);
        });
        // Contenuto body
        section.innerHTML=doc.body?doc.body.innerHTML:html;
        // Script della sotto-pagina (inline + esterni)
        doc.querySelectorAll('script').forEach(oldS=>{
          const s=document.createElement('script');
          if(oldS.type) s.type=oldS.type;
          if(oldS.noModule) s.noModule=true;
          if(oldS.defer) s.defer=true;
          if(oldS.async) s.async=true;
          const src=oldS.getAttribute('src');
          if(src) s.src=new URL(src,url).href; else s.textContent=oldS.textContent||'';
          section.appendChild(s);
        });
        section.dataset.loaded='true';
        section.dataset.source='external';
        syncPaneVarsFor(section);
      }catch(err){
        console.warn('Impossibile caricare', url, '-', err.message);
        // Fallback elegante
        const fb = EMBEDDED_PAGES[url];
        if(fb){
          section.innerHTML = fb;
          section.dataset.loaded='true';
          section.dataset.source='fallback';
          syncPaneVarsFor(section);
        }else{
          const msg=document.createElement('div');
          msg.className='fallback-card';
          msg.innerHTML = `<strong>Non riesco a caricare <code>${url}</code></strong><br><span style="opacity:.8">Verifica che il file esista e sia servito dalla stessa origine.</span>`;
          section.innerHTML=''; section.appendChild(msg);
        }
      }
    }

    async function activate(view){
      if(!VIEWS.includes(view)) view='a';
      const section=view==='a'?$('#view-a'):$('#view-b');
      await loadExternalInto(section);
      $('#view-a').classList.toggle('active',view==='a');
      $('#view-b').classList.toggle('active',view==='b');
      $$('.x-tab').forEach(t=>t.setAttribute('aria-selected',t.dataset.tab===view?'true':'false'));
      $('#view-a').style.zIndex=(view==='a')?5:0;
      $('#view-b').style.zIndex=(view==='b')?5:0;
      syncPaneVarsFor(section);
      if(view==='b') document.dispatchEvent(new CustomEvent('sso:tabchange',{detail:{tab:'scanner'}}));
    }

    // Avvio: carica e attiva la PRIMA pagina (Stoccaggio) e prefetch della seconda
    loadExternalInto($('#view-a')).then(()=>activate('a'));
    loadExternalInto($('#view-b')); // prefetch per evitare flash al primo click

    document.querySelector('.x-tabbar-inner').addEventListener('click',e=>{
      const a=e.target.closest('.x-tab'); if(!a) return; e.preventDefault(); activate(a.dataset.tab);
    });

    // Sync width + gutter (gutter fisso = 0 per edge-to-edge)
    const EXTERNAL_GUTTER_PX=0;
    const wrapEl=document.querySelector('.x-wrap');

    function readWrapDims(){
      if(!wrapEl) return {w:760,g:0};
      const w=wrapEl.getBoundingClientRect().width; return {w,g:0};
    }
    function applyPaneVarsToRoots(pixels,gutter){
      const g=(typeof EXTERNAL_GUTTER_PX==='number')?EXTERNAL_GUTTER_PX:gutter;
      document.querySelectorAll('[data-view].active [data-sso]').forEach(root=>{
        root.style.setProperty('--pane-max',Math.round(pixels)+'px');
        root.style.setProperty('--pane-gutter',Math.round(g)+'px');
      });
    }
    function syncPaneVarsFor(section){ if(!section) return; const {w,g}=readWrapDims(); applyPaneVarsToRoots(w,g); }
    const ro=new ResizeObserver(entries=>{ for(const e of entries){ const w=e.contentRect.width; applyPaneVarsToRoots(w,0); } }); if(wrapEl) ro.observe(wrapEl);
    const mo=new MutationObserver(()=>syncPaneVarsFor(document.querySelector('[data-view].active'))); mo.observe(document.body,{childList:true,subtree:true});

    // --- Self tests (semplici) -----------------------------------------------
    (function runSelfTests(){
      console.group('%cStòc self-tests','color:#ffd60a');
      const a=$('#view-a'), b=$('#view-b');
      console.assert(a, 'view-a presente');
      console.assert(b, 'view-b presente');
      setTimeout(()=>{
        console.assert(a.dataset.loaded==='true', 'view-a caricata (esterno o fallback)');
        console.assert(b.dataset.loaded==='true', 'view-b prefetched (esterno o fallback)');
        console.groupEnd();
      }, 300);
    })();
  </script>
</body>
</html>
