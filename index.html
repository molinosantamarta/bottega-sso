<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SSO – Switcher (Scanner + Stoccaggio)</title>
  <style>
    :root{
      --bg:#000; --fg:#fff; --muted:#111; --border:#2c2c2e;
      --accent:#0a84ff; --glowA:#6a5acd; --glowB:#1e90ff;
      --tabbar-h:76px;
    }
    html,body{height:100%;background:var(--bg)}
    body{margin:0;color:var(--fg);font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif}

    .x-wrap{min-height:100vh;padding:16px 16px calc(var(--tabbar-h) + 16px)}
    [data-view]{display:none}
    [data-view].active{display:block}

    /* Pagina B placeholder */
    .x-devbox{
      max-width:820px;margin:24px auto 0;padding:18px 20px;
      border:2px dashed #7a7a7a;border-radius:16px;background:#0b0b0b;color:#eaeaea;
      font:14px/1.45 -apple-system,system-ui,Segoe UI,Roboto,sans-serif
    }

    /* iframe Scanner */
    #pageA-frame{
      width:100%;
      min-height:calc(100vh - var(--tabbar-h) - 32px);
      border:0;border-radius:16px;overflow:hidden;background:#000
    }

    /* TABBAR FISSA IN FONDO: area divisa in 2 metà cliccabili */
    .x-tabbar{
      position:fixed;left:0;right:0;bottom:0;z-index:1000;
      background:#0f0f11;border-top:1px solid var(--border);
      padding-bottom:env(safe-area-inset-bottom);
    }
    .x-tabbar-inner{
      max-width:960px;margin:0 auto;height:var(--tabbar-h);
      display:grid;grid-template-columns:1fr 1fr;align-items:stretch;
    }
    .x-half{
      position:relative;display:flex;align-items:center;justify-content:center;
      gap:10px; cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent;
      transition:background .15s ease, box-shadow .15s ease, color .15s ease, border-color .15s ease;
      color:#cfcfcf; background:#121214;
    }
    /* Divider centrale netto */
    .x-half.left { border-right:1px solid var(--border); }
    .x-half.right{ border-left:1px solid var(--border); }

    /* Stato selezionato: effetto "illuminato" coerente con stile pagina */
    .x-half[aria-selected="true"]{
      color:#fff;
      background:linear-gradient(180deg, rgba(220,255,233,.20), rgba(180,255,208,.10));
      box-shadow:0 10px 28px rgba(80,255,150,.18), inset 0 1px 0 rgba(255,255,255,.10);
      border-color:rgba(120,255,180,.55);
    }

    .x-label{font:13px/1.1 -apple-system,system-ui,Segoe UI,Roboto,sans-serif}
    .x-icon{width:20px;height:20px;display:block}

    /* Icone dinamiche semplici */
    @keyframes blink { 0%,100%{transform:scale(1)} 50%{transform:scale(.92)} }
    .ico-camera .iris{ transform-origin:50% 50%; animation:blink 1.6s ease-in-out infinite; }
    @keyframes pulseTick { 0%,100%{opacity:.9; transform:translateY(0)} 50%{opacity:1; transform:translateY(-1px)} }
    .ico-check .tick{ animation:pulseTick 1.8s ease-in-out infinite; }

    /* Quando selezionato, anche l’icona prende un po’ di “glow” */
    .x-half[aria-selected="true"] .x-icon{
      filter: drop-shadow(0 0 6px rgba(120,255,180,.45));
    }

    @media (max-width:520px){
      .x-label{font-size:12px}
      .x-icon{width:18px;height:18px}
    }
  </style>
</head>
<body>
  <main class="x-wrap">
    <!-- Pagina A: Scanner -->
    <section id="view-a" data-view class="active">
      <iframe id="pageA-frame"
              title="SSO Scanner"
              referrerpolicy="strict-origin-when-cross-origin"
              allow="camera; microphone; clipboard-write; autoplay; fullscreen">
      </iframe>
    </section>

    <!-- Pagina B: Stoccaggio -->
    <section id="view-b" data-view>
      <div class="x-devbox">
        questa pagina è in fase di sviluppo, verrà rilasciata con la versione 10.0 dell'app nei prossimi aggiornamenti,
        tu non devi fare nulla, appena pronta la vedrai - Pepe.
      </div>
    </section>
  </main>

  <!-- TABBAR FONDO: due metà cliccabili -->
  <nav class="x-tabbar" aria-label="Navigazione pagine">
    <div class="x-tabbar-inner">
      <div class="x-half left" data-tab="a" aria-selected="true">
        <!-- icona camera -->
        <svg class="x-icon ico-camera" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="3" y="7" width="18" height="12" rx="3" stroke="currentColor"/>
          <path d="M7 7l1.2-2h7.6L17 7" stroke="currentColor"/>
          <circle class="iris" cx="12" cy="13" r="3.2" stroke="currentColor"/>
        </svg>
        <span class="x-label">Scanner</span>
      </div>
      <div class="x-half right" data-tab="b" aria-selected="false">
        <!-- icona checklist -->
        <svg class="x-icon ico-check" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor"/>
          <path class="tick" d="M8 12.5l2.2 2.2L16 9" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="x-label">Stoccaggio</span>
      </div>
    </div>
  </nav>

  <!-- Router + sync selezione + stop camera su B -->
  <script>
    (function(){
      const VIEWS=['a','b'];
      const $=s=>document.querySelector(s);
      const $$=s=>Array.from(document.querySelectorAll(s));
      function activate(view){
        if(!VIEWS.includes(view)) view='a';
        $('#view-a').classList.toggle('active',view==='a');
        $('#view-b').classList.toggle('active',view==='b');
        $$('.x-half').forEach(h=>h.setAttribute('aria-selected', h.dataset.tab===view ? 'true' : 'false'));
        // Ferma scanner quando passi a B
        try {
          const w = document.getElementById('pageA-frame')?.contentWindow;
          if (view==='b' && w?.stopQR) w.stopQR();
        } catch(e){}
      }
      // Click su metà
      document.querySelector('.x-tabbar-inner').addEventListener('click', e=>{
        const half = e.target.closest('.x-half'); if(!half) return;
        const tab = half.dataset.tab;
        history.replaceState(null,'','#'+tab);
        activate(tab);
      });
      // Hash router
      function onHashChange(){ activate((location.hash||'#a').slice(1)); }
      window.addEventListener('hashchange',onHashChange);
      if(!location.hash) history.replaceState(null,'','#a');
      onHashChange();

      // (facoltativo) ricevi comandi dall'iframe scanner
      window.addEventListener('message', ev=>{
        const d = ev.data;
        if(!d || d.type!=='SSO_SWITCH') return;
        if(d.view==='a' || d.view==='b'){
          history.replaceState(null,'','#'+d.view);
          activate(d.view);
        }
      });
    })();
  </script>

  <!-- Template: documento Scanner (Versione 9.4) -->
  <template id="scanner-doc">
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SSO - Scanner Stoccaggio Ordini</title>
  <style>
    html, body { height:100%; background:#000; }
    body { margin:0; }

    [data-sso] { color-scheme: dark; }
    [data-sso] :where(*) { box-sizing: border-box; }
    [data-sso] {
      --bg:#000; --fg:#fff; --muted:#1c1c1e; --accent:#0a84ff; --danger:#ff453a;
      --ok:#34c759; --chip:#1f1f22; --border:#2c2c2e; --success:#22c55e; --torch-on:#ffd60a; --yellow:#ffd60a;
      background:var(--bg); color:var(--fg);
      font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;
      -webkit-text-size-adjust:115%; text-size-adjust:115%;
    }
    [data-sso] .wrap{ padding:12px 12px 40px; max-width:760px; margin:0 auto; }

    [data-sso] header{ padding:22px 16px 16px; text-align:center; border-bottom:1px solid #111; overflow:hidden; position:relative; }
    /* Pillola versione 9.4 centrata in alto */
    .version-pill{
      position:absolute; left:50%; top:8px; transform:translateX(-50%);
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      background:#ffd60a; color:#000; font-weight:900; font-size:12px;
      box-shadow:0 1px 0 rgba(255,255,255,.25) inset, 0 6px 16px rgba(0,0,0,.25);
      border:1px solid #e6c408; letter-spacing:.2px;
    }

    [data-sso] header h1{
      margin:0; font-size:21px; font-weight:900; line-height:1.3; color:transparent;
      background:linear-gradient(90deg, #ff0000 0%, #ff9900 25%, #ffff00 50%, #ff9900 75%, #ff0000 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      background-size:300% 100%; animation:radar-sweep 8s linear infinite;
    }
    [data-sso] header .subtitle { margin-top:6px; font-size:15px; font-weight:600; color:#ddd; opacity:.9; }

    .hero-img-wrap{ display:flex; align-items:center; justify-content:center; margin-top:14px; margin-bottom:10px; gap:0; position:relative; }
    @keyframes slideInRight { from { transform:translateX(60px); opacity:0; } to { transform:translateX(0); opacity:1; } }
    .hero-img-wrap img{ position:relative; left:7px; }
    .hero-img-wrap img.alt{ width:32.8%; max-width:295px; height:auto; border-radius:12px; display:block; box-shadow:0 10px 30px rgba(0,0,0,.25); animation:slideInRight .9s ease-out both; z-index:2; }
    .hero-img-wrap img.altB{ width:31.5%; max-width:284px; height:auto; border-radius:12px; display:block; box-shadow:0 10px 30px rgba(0,0,0,.2); animation:slideInRight .6s .05s ease-out both; margin-left:-3%; z-index:1; opacity:.95; top:6px; }

    .section{ margin-top:20px; border-radius:12px; padding:10px; transition:background .25s ease, box-shadow .25s ease, border-color .25s ease; border:1px solid #0f2616; }
    .section.active{
      background:linear-gradient(180deg, rgba(220,255,233,.25), rgba(180,255,208,.1));
      box-shadow:0 10px 28px rgba(80,255,150,.18), inset 0 1px 0 rgba(255,255,255,.12);
      border-color:rgba(120,255,180,.55);
    }

    .step-title{ font-size:14px; opacity:.9; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
    .step-badge{ background:#1f1f22; color:#fff; border-radius:999px; padding:2px 8px; font-size:12px; transition:all .2s ease; border:1px solid #2a2a2d; }
    .step-badge.done{ background:linear-gradient(180deg,#eafff2,#b8ffd4); color:#073; font-weight:900; border-color:#a4f5c4; text-shadow:0 0 6px rgba(120,255,180,.6); }
    @keyframes pulse-badge { 0%,100%{ transform:scale(1);} 50%{ transform:scale(1.1);} }
    .step-badge.pulse{ animation:pulse-badge 1.2s ease-in-out infinite; background:linear-gradient(180deg, #0a84ff, #0569c9); }

    .controls{ display:flex; gap:10px; align-items:center; }
    .controls.nowrap{ flex-wrap:nowrap; }
    .controls .spacer{ flex:1; }
    .controls.split .btn{ flex:1; }
    #section3 .controls.split .btn{ font-size:18px; padding:21px 16px; }

    .btn{ padding:14px 16px; border:0; border-radius:12px; font-size:16px; font-weight:700; color:#fff; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; line-height:1; }
    .btn:disabled{ opacity:.7; cursor:not-allowed; }
    .primary{ background:var(--accent); } .ghost{ background:#4b4b4e; color:#ddd; }
    .danger{ background:var(--danger); } .success{ background:var(--success); color:#001f0f; }
    .btn-yellow{ background:var(--yellow); color:#000; }

    .btn.pause{ background:#5a5a5e; color:#fff; }
    .btn.resume{ background:var(--success); color:#001f0f; }
    .pause-ico, .play-ico{ margin-left:8px; font-weight:900; }

    .torch-wrap{ display:flex; align-items:center; gap:7px; }
    .torch-label{ font-size:15px; line-height:1.05; text-align:right; opacity:.9; text-transform:lowercase; }
    .torch-label strong{ display:block; text-transform:uppercase; }

    .icon-btn{ width:44px; height:44px; border-radius:999px; position:relative; border:1px solid #2c2c2e; background:#fff; color:#000; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:inset 0 1px 0 rgba(255,255,255,.6), 0 4px 10px rgba(0,0,0,.35); overflow:visible; }
    .icon-btn.torch-on{ background:var(--torch-on); color:#111; border-color:#d8be07; }
    .icon-btn svg{ width:22px; height:22px; display:block; }

    .seg-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .seg{ display:flex; background:#121214; border:1px solid var(--border); border-radius:999px; overflow:auto; -webkit-overflow-scrolling:touch; transition:all .2s ease; }
    .seg .opt{ padding:8px 12px; font-size:14px; border:0; background:transparent; color:#fff; cursor:pointer; white-space:nowrap; transition:all .2s ease; }
    .seg .opt.active{ background:linear-gradient(180deg, #b8ffd4, #a4f5c4); color:#003b1f; font-weight:900; border-radius:999px; box-shadow:0 6px 18px rgba(120,255,180,.35), inset 0 1px 0 rgba(255,255,255,.35); }
    .seg-label{ font-size:13px; opacity:.85; min-width:72px; }

    .chips{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .chip{ background:#121214; color:#fff; padding:10px 12px; border-radius:999px; font-size:14px; border:1px solid var(--border); cursor:pointer; }

    .selected-zone{ margin-top:10px; padding:10px 12px; border-radius:12px; background:#111; border:1px solid var(--border); display:flex; align-items:center; gap:8px; font-weight:600; }
    .selected-dot{ width:10px; height:10px; border-radius:999px; background:var(--ok); display:inline-block; }

    .video-wrap{ width:100%; aspect-ratio:16/9; border-radius:12px; overflow:hidden; border:1px solid var(--border); margin-top:10px; background:#000; position:relative; display:block; }
    @media (max-width:600px){ .video-wrap{ height:56vw; aspect-ratio:auto; } }
    .video-wrap.paused::after{ content:"La scansione è in pausa"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(6px) brightness(.7); color:#fff; font-weight:800; letter-spacing:.6px; }

    .qr-guide{ position:absolute; left:50%; top:30%; transform:translate(-50%,-50%); height:30%; width:auto; display:none; pointer-events:none; }
    .qr-hint{ position:absolute; left:50%; top:66%; transform:translate(-50%,-50%); max-width:80%; width:80%; color:#fff; font-weight:800; font-size:13px; line-height:1.25; background:rgba(0,0,0,.45); padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.2); display:none; text-align:center; }

    .dup-msg{ position:absolute; left:50%; top:8%; transform:translateX(-50%); width:90%; max-width:680px; padding:10px 14px; border-radius:14px; background:rgba(0,0,0,.65); color:#fff; font-weight:800; text-align:center; opacity:0; pointer-events:none; transition:opacity .2s ease; border:1px solid rgba(255,255,255,.2); }
    .dup-msg.show{ opacity:1; }

    video{ display:none; width:100%; height:100%; object-fit:cover; object-position:center; background:#000; }

    .placeholder{ position:absolute; inset:0; border:1px dashed var(--border); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; color:#aaa; padding:15px; }

    .box{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#0b0b0b; margin-top:10px; }
    .label{ font-size:12px; opacity:.7; margin-bottom:4px; }
    .zone-line{ font-size:15px; font-weight:700; margin-bottom:8px; }
    .list{ display:flex; flex-wrap:wrap; gap:8px; min-height:44px; }

    .pill{ display:inline-flex; align-items:center; justify-content:center; background:#ffd60a; color:#000; font-weight:800; font-size:15px; line-height:1; padding:0 10px; border-radius:999px; box-shadow:0 1px 0 rgba(255,255,255,.25) inset, 0 4px 12px rgba(0,0,0,.25); border:1px solid #e6c408; }
    .pill.n1{ width:36px; height:36px; padding:0; } .pill.n2{ min-width:40px; height:36px; } .pill.n3{ min-width:48px; height:36px; }

    .summary{ margin-top:10px; font-size:12px; opacity:.75; }
    .divider{ height:.75px; background:#fff; opacity:.18; margin:10px 0 12px; border-radius:1px; }

    .manual-wrap{ margin-top:12px; }
    .manual-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .keypad{ display:none; margin-top:10px; }
    .keypad.show{ display:block; }
    .key-display{ height:44px; border:1px solid var(--border); border-radius:10px; background:#111; color:#fff; display:flex; align-items:center; justify-content:flex-end; padding:0 12px; font-weight:800; font-size:18px; letter-spacing:.8px; }
    .keys{ margin-top:8px; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; }
    .key{ height:48px; border-radius:12px; border:1px solid #2c2c2e; background:#1a1a1d; color:#fff; font-weight:800; font-size:18px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; }
    .key.action{ background:#2a2a2d; } .key.confirm{ background:#ffd60a; color:#000; }

    @keyframes radar-sweep{0%{background-position:0% 50%}50%{background-position:200% 50%}100%{background-position:0% 50%}}
    .gradient-border { border-image: linear-gradient(90deg,#6a5acd,#1e90ff) 1; }

    @media (max-width:600px){
      [data-sso] header h1{ font-size:23px; }
      [data-sso] header .subtitle{ font-size:16px; }
      .step-title{ font-size:15px; }
      .seg .opt,.chip,.custom input,.custom button{ font-size:15px; }
      .torch-label{ font-size:16px; }
      .label,.summary,.dup-msg,.qr-hint{ font-size:14px; }
      #section3 .controls.split .btn{ font-size:18px; }
    }
  </style>
</head>
<body>
  <div data-sso>
    <header>
      <span class="version-pill">Versione 9.4</span>
      <h1>SSO - Scanner Stoccaggio Ordini</h1>
      <div class="subtitle">Scansiona le spese in pochi secondi e trovale subito al momento del ritiro!</div>

      <div class="hero-img-wrap">
        <img class="alt"  src="https://static.wixstatic.com/media/9d749b_4e7e462b0d2e40448664f342bb2cd2b5~mv2.png/v1/fill/w_116,h_126,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/shopper%20bottega_anteprima_edited_edited_.png" alt="Immagine 1" />
        <img class="altB" src="https://community.appinventor.mit.edu/uploads/default/original/3X/c/2/c21a68fb6312af849c89a657cd12c56faf74dc8e.gif" alt="Animazione" />
      </div>
    </header>

    <div class="wrap">
      <!-- STEP 1 -->
      <div class="section active" id="section1">
        <div class="step-title"><span class="step-badge" id="badge1">1</span> Seleziona la zona che stai per scansionare</div>

        <div class="seg-row">
          <div class="seg-label">NEGOZIO</div>
          <div class="seg" id="segNegozio">
            <button class="opt" data-zone="NEGOZIO - SOPRA">SOPRA</button>
            <button class="opt" data-zone="NEGOZIO - SOTTO">SOTTO</button>
          </div>
        </div>

        <div class="seg-row">
          <div class="seg-label">CAMION</div>
          <div class="seg" id="segCamion">
            <button class="opt" data-zone="CAMION - SOPRA">SOPRA</button>
            <button class="opt" data-zone="CAMION - SOTTO">SOTTO</button>
          </div>
        </div>

        <div class="chips">
          <button class="chip" data-zone="CARNE">CARNE</button>
          <button class="chip" data-zone="SCALE">SCALE</button>
        </div>

        <div class="custom">
          <input id="customZone" placeholder="Scrivi tu la zona..">
          <button id="useCustom">Usa</button>
        </div>

        <div class="selected-zone" id="selectedZone"><span class="selected-dot"></span> <span id="loc">Nessuna zona selezionata</span></div>
      </div>

      <!-- STEP 2 -->
      <div class="section" id="section2">
        <div class="step-title"><span class="step-badge" id="badge2">2</span> Avvia scansione</div>

        <div class="controls nowrap">
          <button id="btnScan" class="btn primary">Avvia scansione</button>
          <div class="spacer"></div>
          <div class="torch-wrap">
            <div class="torch-label"><span>torcia</span><strong id="torchState">OFF</strong></div>
            <button id="btnTorch" class="icon-btn" title="Torcia" aria-label="Torcia">
              <svg viewBox="0 0 512 512" aria-hidden="true">
                <path d="M128 96h256v64l-64 96v128a64 64 0 0 1-64 64h-0a64 64 0 0 1-64-64V256l-64-96V96z" fill="currentColor"/>
                <rect x="208" y="48" width="96" height="24" rx="12" fill="currentColor"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="video-wrap" id="videoWrap">
          <img id="qrGuide" class="qr-guide" src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" alt="Guida QR" />
          <div id="qrHint" class="qr-hint">scansiona il codice QR del biglietto sulla spesa</div>
          <video id="video" playsinline muted></video>

          <div id="placeholder" class="placeholder">
            <div style="display:flex;gap:12px;align-items:center;">
              <svg style="width:36px;height:36px" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4 7h3l1.5-2h7L17 7h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.5"/>
                <circle cx="12" cy="13" r="3.5" stroke="currentColor" stroke-width="1.5"/>
              </svg>
              <span>La fotocamera comparirà qui dopo aver cliccato “Avvia scansione”.</span>
            </div>
          </div>

          <div id="dupMsg" class="dup-msg">già scansionato, passa al prossimo ordine.</div>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="section" id="section3">
        <div class="step-title"><span class="step-badge" id="badge3">3</span> Verifica e Conferma</div>
        <div class="box">
          <div class="label">Zona</div>
          <div class="zone-line" id="zoneLine">—</div>
          <div class="list" id="list"></div>
          <div class="summary" id="summary">0 ordini in memoria</div>

          <!-- Inserimento manuale -->
          <div class="manual-wrap">
            <div class="manual-controls">
              <button id="toggleKeypad" class="btn ghost" type="button">Aggiungi manualmente</button>
            </div>
            <div class="keypad" id="keypad">
              <div class="key-display" id="keyDisplay">—</div>
              <div class="keys">
                <div class="key">1</div><div class="key">2</div><div class="key">3</div>
                <div class="key">4</div><div class="key">5</div><div class="key">6</div>
                <div class="key">7</div><div class="key">8</div><div class="key">9</div>
                <div class="key action" data-act="back">⌫</div>
                <div class="key">0</div>
                <div class="key confirm" data-act="ok">Aggiungi</div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="controls split" style="margin-top:0;">
            <button id="btnCopy" class="btn success" disabled>Termina e invia</button>
            <button id="btnClear" class="btn danger" disabled>Cancella e rifai</button>
          </div>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="section" id="section4" style="display:none">
        <div class="step-title"><span class="step-badge" id="badge4">4</span> Invio scansioni</div>
        <div class="box gradient-border" id="step4Box"></div>
        <div class="progress-done" id="pDoneOuter" style="display:none">
          <button id="btnNew" class="btn btn-yellow">Nuova scansione</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // opzionale: bridge per controlli dalla pagina padre (se mai servisse)
    window.addEventListener('message', ev=>{
      // riservato per futuri comandi
    });

    const root = document.querySelector('[data-sso]');
    const loc = root.querySelector('#loc');
    const zoneLine = root.querySelector('#zoneLine');
    const list = root.querySelector('#list');
    const badge1 = root.querySelector('#badge1');
    const badge2 = root.querySelector('#badge2');
    const badge3 = root.querySelector('#badge3');
    const badge4 = document.getElementById('badge4');
    const selectedZoneBox = root.querySelector('#selectedZone');
    const videoWrap = document.getElementById('videoWrap');
    const video = root.querySelector('#video');
    const placeholder = root.querySelector('#placeholder');
    const dupMsg = document.getElementById('dupMsg');
    const qrGuide = document.getElementById('qrGuide');
    const qrHint = document.getElementById('qrHint');
    const btnScan = root.querySelector('#btnScan');
    const btnClear = root.querySelector('#btnClear');
    const btnCopy = root.querySelector('#btnCopy');
    const btnTorch = document.getElementById('btnTorch');
    const torchState = document.getElementById('torchState');
    const step4 = document.getElementById('section4');
    const step4Box = document.getElementById('step4Box');
    const pDoneOuter = document.getElementById('pDoneOuter');
    const btnNewExternal = document.getElementById('btnNew');

    const toggleKeypadBtn = document.getElementById('toggleKeypad');
    const keypad = document.getElementById('keypad');
    const keyDisplay = document.getElementById('keyDisplay');

    let currentZone = null;
    const data = {};
    let stream = null;
    let videoTrack = null;

    let qrPaused = false;
    let qrRunning = false;
    let hasEverStarted = false;
    let scanningLocked = false;
    let dupTimer = null;
    let firstScanDone = false;

    const GFORM = {
      ACTION: "https://docs.google.com/forms/d/e/1FAIpQLSdixUK5TjPdfYMeso-XXTJHYy2Vy23F44j5FEMWFddWRfRh7Q/formResponse",
      ENTRY_ZONE:   "entry.1910612286",
      ENTRY_ORDERS: "entry.1223265482"
    };

    const AC = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    function ensureAC(){ if (!audioCtx) audioCtx = new AC(); return audioCtx; }
    function playTone(freq=880, dur=0.16, type='sine', gain=0.2, delay=0){
      try{
        const ac = ensureAC();
        const o = ac.createOscillator(), g = ac.createGain();
        o.type = type; o.frequency.value = freq; o.connect(g); g.connect(ac.destination);
        const now = ac.currentTime + (delay||0);
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
        o.start(now); o.stop(now + dur + 0.02);
      }catch(_){}}
    function soundZoneChange(){ playTone(660, 0.09, 'triangle', 0.18); }
    function soundScanOK(){  playTone(1046.5, 0.10, 'sine', 0.22, 0.00); playTone(1318.5, 0.11, 'sine', 0.20, 0.07); }
    function soundScanDuplicate(){ playTone(392, 0.18, 'square', 0.22); }

    // STEP 1 pulse
    badge1.classList.add('pulse');

    function markActive(id){ document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); const el=document.getElementById(id); if(el) el.classList.add('active'); }
    function clearZoneSelectionsUI(){
      root.querySelectorAll('.opt,.chip').forEach(b=>b.classList.remove('active'));
      selectedZoneBox.classList.remove('active'); loc.textContent='Nessuna zona selezionata'; zoneLine.textContent='—';
    }

    function select(z){
      if (scanningLocked){ alert('Non puoi cambiare zona dopo aver avviato la scansione.'); return; }
      currentZone = z; loc.textContent=z; zoneLine.textContent=z; renderList();
      root.querySelectorAll('.seg-label').forEach(l=>l.classList.remove('active'));
      root.querySelectorAll('.seg').forEach(s=>s.classList.remove('active'));
      root.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      selectedZoneBox.classList.remove('active');

      if(z.startsWith('NEGOZIO')){ root.querySelector('#segNegozio').previousElementSibling.classList.add('active'); root.querySelector('#segNegozio').classList.add('active'); }
      if(z.startsWith('CAMION')){ root.querySelector('#segCamion').previousElementSibling.classList.add('active'); root.querySelector('#segCamion').classList.add('active'); }
      if(z.startsWith('CARNE') || z.startsWith('SCALE')){ const chip=[...root.querySelectorAll('.chip')].find(c=>c.dataset.zone===z); if(chip) chip.classList.add('active'); }

      badge1.classList.remove('pulse'); badge1.classList.add('done'); badge2.classList.add('pulse');
      document.getElementById('section1').classList.add('active'); selectedZoneBox.classList.add('active');
      soundZoneChange();
    }

    function pillClassFor(num){ const l=String(num).length; return l===1?'pill n1':(l===2?'pill n2':'pill n3'); }
    function updateSummaryFor(zone){ const arr=(data[zone]||[]); const unique=new Set(arr).size; const s=root.querySelector('#summary'); if(s){ s.textContent = `${unique} ${unique===1?'ordine':'ordini'} in memoria`; } }
    function renderList(){
      list.innerHTML=''; const arr=(data[currentZone]||[]).slice().sort((a,b)=>a-b);
      if(!arr.length){ list.innerHTML='<em style="opacity:.7">Nessun numero</em>'; }
      for(const n of arr){ const s=document.createElement('span'); s.className=pillClassFor(n); s.textContent=n; list.appendChild(s); }
      updateSummaryFor(currentZone||'_');
    }
    function showDuplicateOverlay(){ dupMsg.classList.add('show'); clearTimeout(dupTimer); dupTimer=setTimeout(()=>dupMsg.classList.remove('show'),1200); }
    function setActionButtonsEnabled(v){ btnCopy.disabled=!v; btnClear.disabled=!v; }
    function hideQrGuideOnce(){ if(!firstScanDone){ firstScanDone=true; if(qrGuide) qrGuide.style.display='none'; if(qrHint) qrHint.style.display='none'; } }
    function addScanned(v){
      if(!currentZone){ alert('Seleziona prima una zona.'); return; }
      if(v<1||v>999){ alert('Sono ammessi solo valori da 1 a 999.'); return; }
      if(!data[currentZone]) data[currentZone]=[];
      if(!data[currentZone].includes(v)){ data[currentZone].push(v); renderList(); soundScanOK(); setActionButtonsEnabled(true); hideQrGuideOnce(); }
      else { soundScanDuplicate(); showDuplicateOverlay(); hideQrGuideOnce(); }
    }

    // Manuale
    let manualBuffer=""; const keyDisp=()=>keyDisplay.textContent = manualBuffer.length?manualBuffer:'—';
    toggleKeypadBtn.addEventListener('click', ()=>{
      if(!currentZone){ alert('Seleziona prima una zona per poter inserire manualmente.'); return; }
      keypad.classList.toggle('show'); if(!keypad.classList.contains('show')){ manualBuffer=""; keyDisp(); }
    });
    keypad.addEventListener('click', e=>{
      const k=e.target.closest('.key'); if(!k) return;
      const act=k.dataset.act;
      if(act==='back'){ manualBuffer=manualBuffer.slice(0,-1); keyDisp(); return; }
      if(act==='ok'){ if(!manualBuffer) return; const n=parseInt(manualBuffer,10); if(Number.isFinite(n)&&n>=1&&n<=999){ addScanned(n); } else { alert('Inserisci un valore da 1 a 999.'); } manualBuffer=""; keyDisp(); return; }
      const d=k.textContent.trim(); if(/^\d$/.test(d)){ const next=(manualBuffer+d).replace(/^0+(\d)/,'$1'); if(next.length<=3){ manualBuffer=next; keyDisp(); } }
    });

    // Zone
    root.querySelectorAll('#segNegozio .opt, #segCamion .opt, .chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (scanningLocked){ alert('Non puoi cambiare zona dopo aver avviato la scansione.'); return; }
        root.querySelectorAll('.opt, .chip').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active'); select(btn.dataset.zone);
      });
    });
    root.querySelector('#useCustom').addEventListener('click', ()=>{
      if (scanningLocked){ alert('Non puoi cambiare zona dopo aver avviato la scansione.'); return; }
      const v=(root.querySelector('#customZone').value||'').trim(); if(!v) return;
      root.querySelectorAll('.opt,.chip').forEach(b=>b.classList.remove('active')); select(v);
    });

    // Camera / QR
    async function openCamera(){
      if (!currentZone){ alert('Seleziona una zona.'); return; }
      try{
        const constraints={audio:false, video:{ facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080} }};
        video.setAttribute('playsinline',''); video.setAttribute('muted',''); video.muted=true;
        await stopCamera();
        if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ throw new Error('getUserMedia non disponibile'); }
        const s=await navigator.mediaDevices.getUserMedia(constraints);
        stream=s; video.srcObject=stream; await video.play(); videoTrack=stream.getVideoTracks()[0];
        firstScanDone=false; if(qrGuide) qrGuide.style.display='block'; if(qrHint) qrHint.style.display='block';
        if(window.startQR){ window.startQR(video,(text)=>{ if(qrPaused) return; const m=text.match(/\d+/g); if(!m) return; for(const v of m) addScanned(parseInt(v,10)); }); qrRunning=true; }
        markActive('section2'); video.style.display='block'; placeholder.style.display='none';
        badge2.classList.remove('pulse'); badge2.classList.add('done'); badge3.classList.add('pulse');
        hasEverStarted=true; scanningLocked=true; lockZoneSelectors(true);
        setScanButton_active(); setActionButtonsEnabled(true);
      }catch(err){ console.error(err); alert('Non riesco ad aprire la fotocamera.\nControlla HTTPS e i permessi camera.'); }
    }
    function lockZoneSelectors(lock){
      root.querySelectorAll('#segNegozio .opt, #segCamion .opt, .chip, #useCustom').forEach(el=>{ lock?el.setAttribute('disabled','disabled'):el.removeAttribute('disabled'); });
      const ci=root.querySelector('#customZone'); if(ci) ci.disabled=!!lock;
    }
    async function stopCamera(){
      if(window.stopQR) window.stopQR(); qrRunning=false; qrPaused=false; videoWrap.classList.remove('paused');
      if(stream){ for(const t of stream.getTracks()) t.stop(); stream=null; }
      try{ video.pause(); }catch(_){} video.srcObject=null; videoTrack=null;
      if(qrGuide) qrGuide.style.display='none'; if(qrHint)  qrHint.style.display='none';
      setScanButton_start();
    }
    function setScanButton_start(){ btnScan.textContent='Avvia scansione'; btnScan.classList.remove('pause','resume','success'); btnScan.classList.add('primary'); }
    function setScanButton_active(){ btnScan.innerHTML='Pausa scansione <span class="pause-ico">⏸</span>'; btnScan.classList.remove('primary','resume','success'); btnScan.classList.add('pause'); }
    function setScanButton_paused(){ btnScan.innerHTML='Riprendi scansione <span class="play-ico">▶</span>'; btnScan.classList.remove('primary','pause'); btnScan.classList.add('resume','success'); }
    btnScan.addEventListener('click', async ()=>{
      if (!hasEverStarted || !stream){ await openCamera(); return; }
      if (!qrPaused){ qrPaused=true; if(window.stopQR) window.stopQR(); qrRunning=false; videoWrap.classList.add('paused'); setScanButton_paused(); setActionButtonsEnabled(true); }
      else { if(window.startQR){ window.startQR(video,(text)=>{ if(qrPaused) return; const m=text.match(/\d+/g); if(!m) return; for(const v of m) addScanned(parseInt(v,10)); }); qrRunning=true; } qrPaused=false; videoWrap.classList.remove('paused'); setScanButton_active(); setActionButtonsEnabled(true); }
    });
    btnTorch.addEventListener('click', async ()=>{
      try{
        if(!videoTrack){ await openCamera(); if(!videoTrack) return; }
        const caps=videoTrack.getCapabilities&&videoTrack.getCapabilities(); if(!caps||!caps.torch){ alert('Torcia non supportata su questo dispositivo'); return; }
        const settings=videoTrack.getSettings&&videoTrack.getSettings(); const cur=settings&&settings.torch?true:false;
        await videoTrack.applyConstraints({ advanced:[{ torch: !cur }] });
        const on=!cur; btnTorch.classList.toggle('torch-on',on); torchState.textContent=on?'ON':'OFF';
      }catch(e){ console.error(e); }
    });

    async function copyCurrentPayloadToClipboard(){
      const zone=currentZone||''; const arr=(data[zone]||[]).slice().sort((a,b)=>a-b);
      const payload=JSON.stringify({ zona:zone, ordini:arr }, null, 0);
      try{ await navigator.clipboard.writeText(payload); }catch(_){}
      return payload;
    }

    function submitToGoogleForm({ zona, ordini }){
      if(!GFORM.ACTION||!GFORM.ENTRY_ZONE||!GFORM.ENTRY_ORDERS){ console.warn('Google Form non configurato.'); return false; }
      const zoneVal=(zona||'-').trim(); const ordersVal=(Array.isArray(ordini)&&ordini.length)?ordini.join(','):'-';
      let iframe=document.getElementById('hidden_iframe_gform');
      if(!iframe){ iframe=document.createElement('iframe'); iframe.name='hidden_iframe_gform'; iframe.id='hidden_iframe_gform'; iframe.style.display='none'; document.body.appendChild(iframe); }
      const form=document.createElement('form'); form.action=GFORM.ACTION; form.method='POST'; form.target='hidden_iframe_gform';
      const inZone=document.createElement('input'); inZone.type='hidden'; inZone.name=GFORM.ENTRY_ZONE; inZone.value=zoneVal; form.appendChild(inZone);
      const inOrders=document.createElement('input'); inOrders.type='hidden'; inOrders.name=GFORM.ENTRY_ORDERS; inOrders.value=ordersVal; form.appendChild(inOrders);
      document.body.appendChild(form); try{ form.submit(); } finally { form.remove(); }
      return true;
    }

    async function fullReset(clearClipboard=true){
      await stopCamera();
      for(const k in data) delete data[k];
      list.innerHTML='<em style="opacity:.7">Nessun numero</em>';
      const s=root.querySelector('#summary'); if(s) s.textContent='0 ordini in memoria';
      if(clearClipboard){ try{ await navigator.clipboard.writeText(''); }catch(_){} }
      [badge1,badge2,badge3,badge4].forEach(b=>{ if(b) b.classList.remove('done','pulse'); }); badge1.classList.add('pulse');
      document.getElementById('section1').classList.add('active'); ['section2','section3'].forEach(id=>{ const el=document.getElementById(id); if(el && id!=='section1') el.classList.remove('active'); });
      video.style.display='none'; placeholder.style.display='block'; videoWrap.classList.remove('paused'); dupMsg.classList.remove('show');
      currentZone=null; clearZoneSelectionsUI();
      hasEverStarted=false; scanningLocked=false; lockZoneSelectors(false); setActionButtonsEnabled(false); setScanButton_start();
      btnTorch.classList.remove('torch-on'); torchState.textContent='OFF';
      keypad.classList.remove('show'); keyDisplay.textContent='—';
      firstScanDone=false; if(qrGuide) qrGuide.style.display='none'; if(qrHint)  qrHint.style.display='none';
      if(pDoneOuter) pDoneOuter.style.display='none';
    }

    btnClear.addEventListener('click', async ()=>{ await fullReset(true); if(step4) step4.style.display='none'; window.scrollTo({ top:0, behavior:'smooth' }); });

    const progressMessages=['Stabilisco handshake con il server…','Sincronizzo timestamp NTP…','Operazioni crittografiche avanzate…','Ottimizzo il flusso dei pacchetti…','se non va, vai in chiesina e accendi un cero.'];
    function startStep4Progress(){
      step4Box.innerHTML='<div class="progress-wrap"><div class="progress-outer"><div class="progress-inner" id="pInner"></div></div><div class="progress-msg" id="pMsg">Inizializzo…</div></div>';
      const pInner=document.getElementById('pInner'); const pMsg=document.getElementById('pMsg'); let pct=0;
      const inc=setInterval(()=>{ pct+=Math.floor(Math.random()*4)+3; if(pct>=96){ pct=96; clearInterval(inc); pMsg.textContent=progressMessages[progressMessages.length-1]; setTimeout(()=>{ pInner.style.width='100%'; pMsg.textContent='Completato ✔︎'; if(pDoneOuter) pDoneOuter.style.display='flex'; if(btnNewExternal){ btnNewExternal.onclick=async()=>{ await fullReset(true); step4.style.display='none'; window.scrollIntoView({behavior:'smooth', block:'start'}); }; } },4000); } pInner.style.width=pct+'%'; },120);
      let i=0; const cyc=setInterval(()=>{ if(pct>=96){ clearInterval(cyc); return; } pMsg.textContent=progressMessages[i % (progressMessages.length-1)]; i++; },800);
    }

    btnCopy.addEventListener('click', async ()=>{
      const zone=currentZone||''; const arr=(data[zone]||[]).slice().sort((a,b)=>a-b);
      await copyCurrentPayloadToClipboard(); submitToGoogleForm({ zona:zone, ordini:arr });
      btnCopy.disabled=true; btnClear.disabled=true; btnCopy.classList.remove('success'); btnCopy.classList.add('ghost'); btnClear.classList.remove('danger'); btnClear.classList.add('ghost');
      keypad.classList.remove('show'); keyDisplay.textContent='—';
      if(currentZone && data[currentZone]) delete data[currentZone];
      list.innerHTML='<em style="opacity:.7">Nessun numero</em>'; document.getElementById('summary').textContent='0 ordini in memoria';
      clearZoneSelectionsUI(); currentZone=null; scanningLocked=false; lockZoneSelectors(false);
      badge3.classList.remove('pulse'); badge3.classList.add('done'); if(badge4) badge4.classList.add('pulse');
      step4.style.display=''; step4.classList.add('gradient-border'); markActive('section4');
      startStep4Progress(); step4.scrollIntoView({ behavior:'smooth', block:'start' });
    });

    lockZoneSelectors(false);
    window.addEventListener('pagehide', async ()=>{ await stopCamera(); }, { once:true });
    window.addEventListener('beforeunload', async ()=>{ await stopCamera(); }, { once:true });
    document.addEventListener('visibilitychange', async ()=>{ if(document.visibilityState==='hidden') await stopCamera(); });
  })();
  </script>

  <!-- QR scanner (ZXing) -->
  <script type="module">
    import { BrowserQRCodeReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm";
    const qrReader = new BrowserQRCodeReader(); let qrControls = null; let lastText = "";
    window.startQR = async function(videoEl, onResult){
      qrControls = await qrReader.decodeFromVideoElement(videoEl, (result, err) => {
        if (result) {
          const text = result.getText();
          if (text && text !== lastText) {
            lastText = text;
            try { onResult(text); } catch(e) { console.error(e); }
            setTimeout(()=>{ lastText = ""; }, 800);
          }
        }
      });
    };
    window.stopQR = function(){ try{ if(qrControls) qrControls.stop(); }catch(_){} qrControls=null; };
  </script>
</body>
</html>
  </template>

  <!-- Montaggio nell'iframe con SRCdoc -->
  <script>
    (function(){
      const iframe = document.getElementById('pageA-frame');
      const tpl = document.getElementById('scanner-doc');
      if (!iframe || !tpl) return;
      iframe.srcdoc = tpl.innerHTML;
    })();
  </script>
</body>
</html>
