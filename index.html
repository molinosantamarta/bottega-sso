<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SSO Scanner – Standalone</title>
  <style>
    /* Reset pagina e sfondo nero pieno */
    html, body { height:100%; background:#000; }
    body { margin:0; }

    [data-sso] { color-scheme: dark; }
    [data-sso] :where(*) { box-sizing: border-box; }
    [data-sso] {
      --bg:#000;
      --fg:#fff;
      --muted:#1c1c1e;
      --accent:#0a84ff;
      --danger:#ff453a;
      --ok:#34c759;
      --chip:#1f1f22;
      --border:#2c2c2e;
      --success:#22c55e; /* verde per azioni positive */
      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;
    }
    [data-sso] .wrap{ padding:12px 12px 40px; max-width:760px; margin:0 auto; }

    [data-sso] header{ padding:16px 16px 12px; text-align:center; border-bottom:1px solid #111; }
    [data-sso] header h1{
      margin:0; font-size:21px; font-weight:900; line-height:1.3; color:transparent;
      background:linear-gradient(90deg, #ff0000 0%, #ff9900 25%, #ffff00 50%, #ff9900 75%, #ff0000 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      background-size:300% 100%; animation:radar-sweep 8s linear infinite;
    }
    [data-sso] header .subtitle {
      margin-top:6px;
      font-size:15px;
      font-weight:600;
      color:#ddd;
      opacity:.9;
    }

    /* Immagine tra sottotitolo e pillola beta */
    [data-sso] .hero-img-wrap{
      display:flex; justify-content:center; margin-top:14px; margin-bottom:10px;
    }
    [data-sso] .hero-img-wrap img{
      width:50%; max-width:380px; height:auto; border-radius:12px; display:block;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }

    /* Pillola Beta 4.1 sotto l'immagine (margine maggiore) */
    [data-sso] .beta-row{ display:flex; justify-content:center; margin-top:14px; }
    [data-sso] .beta-pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      background:#ffd60a; color:#000; font-weight:800; font-size:12px;
      box-shadow:0 1px 0 rgba(255,255,255,.25) inset, 0 4px 12px rgba(0,0,0,.25);
      border:1px solid #e6c408; letter-spacing:.2px;
    }

    [data-sso] .section{ margin-top:20px; border-radius:12px; padding:10px; transition:background .25s ease, box-shadow .25s ease, border-color .25s ease; border:1px solid #0f2616; }
    [data-sso] .section.active{
      background:linear-gradient(180deg, rgba(220,255,233,.25), rgba(180,255,208,.1));
      box-shadow:0 10px 28px rgba(80,255,150,.18), inset 0 1px 0 rgba(255,255,255,.12);
      border-color:rgba(120,255,180,.55);
    }

    [data-sso] .step-title{ font-size:14px; opacity:.9; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
    [data-sso] .step-badge{ background:#1f1f22; color:#fff; border-radius:999px; padding:2px 8px; font-size:12px; transition:all .2s ease; border:1px solid #2a2a2d; }
    [data-sso] .step-badge.done{ background:linear-gradient(180deg,#eafff2,#b8ffd4); color:#073; font-weight:900; border-color:#a4f5c4; text-shadow:0 0 6px rgba(120,255,180,.6); }

    @keyframes pulse-badge {
      0%,100%{ transform:translateZ(0) scale(1); box-shadow:0 0 0 0 rgba(10,132,255,.0);}
      50%{ transform:translateZ(0) scale(1.1); box-shadow:0 0 0 6px rgba(10,132,255,.15);}
    }
    [data-sso] .step-badge.pulse{ animation:pulse-badge 1.2s ease-in-out infinite; background:linear-gradient(180deg, #0a84ff, #0569c9); }

    /* Controlli */
    [data-sso] .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    @media (max-width:699px){ [data-sso] .controls{ flex-direction:row; } }

    [data-sso] .btn{
      padding:14px 16px; border:0; border-radius:12px; font-size:16px; font-weight:700; color:#fff; cursor:pointer;
      transition: filter .15s ease, opacity .15s ease, background-color .15s ease, color .15s ease;
    }
    [data-sso] .btn:disabled{ opacity:.45; cursor:not-allowed; filter:grayscale(0.5); }
    [data-sso] .primary{ background:var(--accent); flex:1; }
    [data-sso] .ghost{ background:var(--muted); }
    [data-sso] .danger{ background:var(--danger); }
    [data-sso] .success{ background:var(--success); color:#001f0f; } /* verde */
    /* stati per il tasto scan */
    [data-sso] .btn.pause{ background:#5a5a5e; color:#fff; }   /* grigio più chiaro */
    [data-sso] .btn.resume{ background:var(--success); color:#001f0f; }   /* verde */
    [data-sso] .pause-ico, [data-sso] .play-ico{ margin-left:8px; font-weight:900; }

    /* Bottone tondo torcia (iOS-like) + fascio luce invertito (180°) */
    [data-sso] .icon-btn{
      width:44px; height:44px; border-radius:999px; position:relative;
      border:1px solid #2c2c2e;
      background:radial-gradient(100% 100% at 50% 0%, #2a2a2d 0%, #141416 100%);
      display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 4px 10px rgba(0,0,0,.35);
      overflow:visible;
    }
    [data-sso] .icon-btn:active{ transform:scale(.97); }
    [data-sso] .icon-btn svg{ width:22px; height:22px; display:block; }
    /* Cono sfumato ~10°, ruotato 180° */
    [data-sso] .icon-btn.torch-on::after{
      content:""; position:absolute; left:50%; bottom:44px; transform:translateX(-50%) rotate(180deg);
      width:12px; height:0; border-left:60px solid transparent; border-right:60px solid transparent;
      border-bottom:160px solid rgba(255, 244, 200, .18);
      filter:blur(2px);
      pointer-events:none;
    }

    [data-sso] .seg-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    [data-sso] .seg{ display:flex; background:#121214; border:1px solid var(--border); border-radius:999px; overflow:auto; -webkit-overflow-scrolling:touch; transition:all .2s ease; }
    [data-sso] .seg::-webkit-scrollbar{ display:none; }
    [data-sso] .seg.active{
      border-color:rgba(120,255,180,.8);
      background:linear-gradient(180deg, rgba(220,255,233,.35), rgba(180,255,208,.18));
      box-shadow:0 8px 24px rgba(80,255,150,.22), inset 0 1px 0 rgba(255,255,255,.12);
    }
    [data-sso] .seg .opt{ padding:8px 12px; font-size:14px; border:0; background:transparent; color:#fff; cursor:pointer; white-space:nowrap; transition:all .2s ease; }
    [data-sso] .seg .opt.active{
      background:linear-gradient(180deg, #b8ffd4, #a4f5c4);
      color:#003b1f; font-weight:900; border-radius:999px; box-shadow:0 6px 18px rgba(120,255,180,.35), inset 0 1px 0 rgba(255,255,255,.35);
    }
    [data-sso] .seg .opt:disabled{ opacity:.45; cursor:not-allowed; }
    [data-sso] .seg-label{ font-size:13px; opacity:.85; min-width:72px; transition:all .2s ease; }
    [data-sso] .seg-label.active{ color:#00d07c; font-weight:800; opacity:1; text-shadow:0 0 10px rgba(120,255,180,.65); }

    [data-sso] .chips{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    [data-sso] .chip{ background:#2a2a2d; color:#fff; padding:10px 12px; border-radius:999px; font-size:14px; border:0; cursor:pointer; white-space:nowrap; transition:all .2s ease; }
    [data-sso] .chip.active{
      background:linear-gradient(180deg, #b8ffd4, #a4f5c4);
      color:#003b1f; font-weight:900; box-shadow:0 6px 18px rgba(120,255,180,.35), inset 0 1px 0 rgba(255,255,255,.35);
    }
    [data-sso] .chip:disabled{ opacity:.45; cursor:not-allowed; }

    [data-sso] .custom{ display:flex; gap:8px; margin-top:10px; }
    [data-sso] .custom input{ flex:1; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#161618; color:#fff; font-size:14px; }
    [data-sso] .custom input::placeholder{ color:#aaa; }
    [data-sso] .custom button{ padding:12px 14px; border-radius:999px; border:0; background:var(--muted); color:#fff; font-weight:700; cursor:pointer; }
    [data-sso] .custom button:disabled{ opacity:.45; cursor:not-allowed; }

    [data-sso] .selected-zone{
      margin-top:10px; padding:10px 12px; border-radius:12px; background:#111; border:1px solid var(--border);
      display:flex; align-items:center; gap:8px; font-weight:600; transition:background .3s ease, box-shadow .3s ease, color .3s ease;
    }
    [data-sso] .selected-zone.active{ background:#ffd60a; color:#000; box-shadow:0 4px 14px rgba(0,0,0,.25); }
    [data-sso] .selected-dot{ width:10px; height:10px; border-radius:999px; background:var(--ok); display:inline-block; }

    /* Video wrapper per crop + stato pausa (overlay) */
    [data-sso] .video-wrap{
      width:100%;
      aspect-ratio:16/9;
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--border);
      margin-top:10px;
      background:#000;
      position:relative;
    }
    @media (max-width:600px){
      [data-sso] .video-wrap{ height:56vw; aspect-ratio:auto; }
    }
    [data-sso] .video-wrap.paused::after{
      content:"La scansione è in pausa"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      backdrop-filter:blur(6px) brightness(.7);
      color:#fff; font-weight:800; letter-spacing:.6px;
    }
    [data-sso] video{
      display:none;
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      background:#000;
    }
    [data-sso] .placeholder{
      width:100%;
      height:100%;
      border:1px dashed var(--border);
      border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      color:#aaa; text-align:center; padding:0 12px;
    }

    [data-sso] .box{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#0b0b0b; margin-top:10px; }
    [data-sso] .label{ font-size:12px; opacity:.7; margin-bottom:4px; }
    [data-sso] .zone-line{ font-size:15px; font-weight:700; margin-bottom:8px; }
    [data-sso] .list{ display:flex; flex-wrap:wrap; gap:8px; min-height:44px; }

    /* PALLINI ADATTIVI (1/2/3 cifre), centrati, gialli con testo nero */
    [data-sso] .pill{
      display:inline-flex; align-items:center; justify-content:center;
      background:#ffd60a; color:#000; font-weight:800;
      font-size:15px; line-height:1;
      padding:0 10px;  /* per n2/n3 */
      border-radius:999px;
      box-shadow:0 1px 0 rgba(255,255,255,.25) inset, 0 4px 12px rgba(0,0,0,.25);
      border:1px solid #e6c408;
    }
    [data-sso] .pill.n1{ width:36px; height:36px; padding:0; }
    [data-sso] .pill.n2{ min-width:40px; height:36px; }
    [data-sso] .pill.n3{ min-width:48px; height:36px; }

    [data-sso] .summary{ margin-top:10px; font-size:12px; opacity:.75; }

    /* Inserimento manuale */
    [data-sso] .manual-wrap{ margin-top:12px; }
    [data-sso] .manual-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    [data-sso] .keypad{ display:none; margin-top:10px; }
    [data-sso] .keypad.show{ display:block; }
    [data-sso] .key-display{
      height:44px; border:1px solid var(--border); border-radius:10px; background:#111; color:#fff;
      display:flex; align-items:center; justify-content:flex-end; padding:0 12px; font-weight:800; font-size:18px; letter-spacing:.8px;
    }
    [data-sso] .keys{
      margin-top:8px;
      display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;
    }
    [data-sso] .key{
      height:48px; border-radius:12px; border:1px solid #2c2c2e; background:#1a1a1d; color:#fff; font-weight:800; font-size:18px;
      display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
    }
    [data-sso] .key.action{ background:#2a2a2d; }
    /* Conferma gialla con testo nero */
    [data-sso] .key.confirm{ background:#ffd60a; color:#000; }

    .spacer{ height:1px; }

    [data-sso] .demo-badge{
      position:fixed; top:10px; right:10px; background:#333; color:#fff;
      font:12px/1 -apple-system,system-ui,Segoe UI,Roboto,sans-serif;
      padding:6px 8px; border-radius:8px; opacity:.8;
    }
    @keyframes radar-sweep{0%{background-position:0% 50%;}50%{background-position:200% 50%;}100%{background-position:0% 50%;}}
  </style>
</head>
<body>
  <div data-sso>
    <header>
      <h1>Scanner Stoccaggio Ordini</h1>
      <div class="subtitle">Scansiona le spese in pochi secondi e trovale subito al momento del ritiro!</div>

      <div class="hero-img-wrap">
        <img src="https://static.wixstatic.com/media/9d749b_c55ce2c8dc7c439cb7fbd8fd6cf7bac5~mv2.png" alt="Immagine promozionale" />
      </div>

      <div class="beta-row"><span class="beta-pill">Beta 4.1</span></div>
    </header>

    <div class="wrap">
      <!-- STEP 1 -->
      <div class="section active" id="section1">
        <div class="step-title"><span class="step-badge" id="badge1">1</span> Seleziona la zona che stai per scansionare</div>

        <div class="seg-row">
          <div class="seg-label">NEGOZIO</div>
          <div class="seg" id="segNegozio">
            <button class="opt" data-zone="NEGOZIO - SOPRA">SOPRA</button>
            <button class="opt" data-zone="NEGOZIO - SOTTO">SOTTO</button>
          </div>
        </div>

        <div class="seg-row">
          <div class="seg-label">CAMION</div>
          <div class="seg" id="segCamion">
            <button class="opt" data-zone="CAMION - SOPRA">SOPRA</button>
            <button class="opt" data-zone="CAMION - SOTTO">SOTTO</button>
          </div>
        </div>

        <div class="chips">
          <button class="chip" data-zone="CARNE">CARNE</button>
          <button class="chip" data-zone="SCALE">SCALE</button>
        </div>

        <div class="custom">
          <input id="customZone" placeholder="Scrivi tu la zona..">
          <button id="useCustom">Usa</button>
        </div>

        <div class="selected-zone" id="selectedZone"><span class="selected-dot"></span> <span id="loc">Nessuna zona selezionata</span></div>
      </div>

      <!-- STEP 2 -->
      <div class="section" id="section2">
        <div class="step-title"><span class="step-badge" id="badge2">2</span> Avvia scansione</div>
        <div class="controls">
          <button id="btnScan" class="btn primary">Avvia scansione</button>

          <!-- Tasto tondo torcia, icona stile iOS-like + cono invertito -->
          <button id="btnTorch" class="icon-btn" title="Torcia" aria-label="Torcia">
            <!-- Flashlight iOS-like -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 5h12a1 1 0 0 1 .8 1.6L17 9H7L5.2 6.6A1 1 0 0 1 6 5Z" fill="#cfd4da" stroke="#0b0c0d" stroke-width="1.2"/>
              <rect x="8" y="9" width="8" height="10" rx="2.2" fill="#2d2f34" stroke="#141518" stroke-width="1.2"/>
              <rect x="10" y="11.6" width="4" height="2.8" rx="1" fill="#0a84ff"/>
            </svg>
          </button>
        </div>

        <!-- Wrappa il video per il crop -->
        <div class="video-wrap" id="videoWrap">
          <video id="video" playsinline muted></video>
          <div id="placeholder" class="placeholder">
            La fotocamera comparirà qui dopo aver cliccato “Avvia scansione”.
          </div>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="section" id="section3">
        <div class="step-title"><span class="step-badge" id="badge3">3</span> Verifica numeri letti</div>
        <div class="box">
          <div class="label">Zona</div>
          <div class="zone-line" id="zoneLine">—</div>
          <div class="list" id="list"></div>
          <div class="summary" id="summary"></div>

          <!-- Inserimento manuale -->
          <div class="manual-wrap">
            <div class="manual-controls">
              <button id="toggleKeypad" class="btn ghost" type="button">Aggiungi manualmente</button>
            </div>
            <div class="keypad" id="keypad">
              <div class="key-display" id="keyDisplay">—</div>
              <div class="keys">
                <div class="key">1</div><div class="key">2</div><div class="key">3</div>
                <div class="key">4</div><div class="key">5</div><div class="key">6</div>
                <div class="key">7</div><div class="key">8</div><div class="key">9</div>
                <div class="key action" data-act="back">⌫</div>
                <div class="key">0</div>
                <div class="key confirm" data-act="ok">Aggiungi</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="section" id="section4">
        <div class="step-title"><span class="step-badge" id="badge4">4</span> Termina</div>
        <div class="controls">
          <button id="btnCopy" class="btn success" disabled>Termina e invia</button>
          <button id="btnClear" class="btn danger" disabled>Svuota e ricomincia</button>
        </div>
      </div>

      <!-- STEP 5 (hidden finché non si preme “Termina e invia”) -->
      <div class="section" id="section5" style="display:none">
        <div class="step-title"><span class="step-badge" id="badge5">5</span> Invio</div>
        <div class="box">
          Qui ci sarà il modulo Google che comunicherà con il database del foglio Google degli ordini, sezione stoccaggio. Script ancora da costruire, Pepe ci sta lavorando su.
        </div>
      </div>

      <div class="spacer"></div>
    </div>
  </div>

  <div class="demo-badge" aria-hidden="true">Standalone GitHub Pages</div>

  <script>
  (function(){
    const root = document.querySelector('[data-sso]');
    const loc = root.querySelector('#loc');
    const zoneLine = root.querySelector('#zoneLine');
    const list = root.querySelector('#list');
    const badge1 = root.querySelector('#badge1');
    const badge2 = root.querySelector('#badge2');
    const badge3 = root.querySelector('#badge3');
    const badge4 = root.querySelector('#badge4');
    const badge5 = document.getElementById('badge5');
    const selectedZoneBox = root.querySelector('#selectedZone');
    const videoWrap = document.getElementById('videoWrap');
    const video = root.querySelector('#video');
    const placeholder = root.querySelector('#placeholder');
    const btnScan = root.querySelector('#btnScan');
    const btnClear = root.querySelector('#btnClear');
    const btnCopy = root.querySelector('#btnCopy');
    const btnTorch = document.getElementById('btnTorch');

    // Manual keypad
    const toggleKeypadBtn = document.getElementById('toggleKeypad');
    const keypad = document.getElementById('keypad');
    const keyDisplay = document.getElementById('keyDisplay');

    let currentZone = null;
    const data = {};
    let stream = null;
    let videoTrack = null;

    let qrPaused = false;
    let qrRunning = false;
    let hasEverStarted = false;
    let scanningLocked = false; // blocca cambio zona dopo avvio
    let torchOn = false;

    // === AUDIO ===
    const AC = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    function ensureAC(){
      if (!audioCtx) audioCtx = new AC();
      return audioCtx;
    }
    function playTone(freq=880, dur=0.16, type='sine', gain=0.2, delay=0){
      try{
        const ac = ensureAC();
        const o = ac.createOscillator();
        const g = ac.createGain();
        o.type = type;
        o.frequency.value = freq;
        o.connect(g); g.connect(ac.destination);
        const now = ac.currentTime + (delay||0);
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
        o.start(now);
        o.stop(now + dur + 0.02);
      }catch(_){}
    }
    function soundZoneChange(){ playTone(660, 0.09, 'triangle', 0.18); }
    function soundScanOK(){  // doppio chime
      playTone(1046.5, 0.10, 'sine', 0.22, 0.00); // C6
      playTone(1318.5, 0.11, 'sine', 0.20, 0.07); // E6
    }
    function soundScanDuplicate(){ playTone(392, 0.18, 'square', 0.22); }  // G4

    // STEP 1 (già illuminato da markup)
    badge1.classList.add('pulse');

    function markActive(sectionId){
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      const sec = document.getElementById(sectionId);
      if (sec) sec.classList.add('active');
    }

    function select(z){
      if (scanningLocked){
        alert('Non puoi cambiare zona dopo aver avviato la scansione.');
        return;
      }
      currentZone = z;
      loc.textContent = z;
      zoneLine.textContent = z;
      renderList();

      root.querySelectorAll('.seg-label').forEach(l=>l.classList.remove('active'));
      root.querySelectorAll('.seg').forEach(s=>s.classList.remove('active'));
      root.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      selectedZoneBox.classList.remove('active');

      if(z.startsWith('NEGOZIO')){
        root.querySelector('#segNegozio').previousElementSibling.classList.add('active');
        root.querySelector('#segNegozio').classList.add('active');
      }
      if(z.startsWith('CAMION')){
        root.querySelector('#segCamion').previousElementSibling.classList.add('active');
        root.querySelector('#segCamion').classList.add('active');
      }
      if(z.startsWith('CARNE') || z.startsWith('SCALE')){
        const chip = [...root.querySelectorAll('.chip')].find(c => c.dataset.zone===z);
        if(chip) chip.classList.add('active');
      }

      badge1.classList.remove('pulse');
      badge1.classList.add('done');
      badge2.classList.add('pulse');

      document.getElementById('section1').classList.add('active');
      selectedZoneBox.classList.add('active');

      soundZoneChange();
    }

    function pillClassFor(num){
      const len = String(num).length;
      if (len === 1) return 'pill n1';
      if (len === 2) return 'pill n2';
      return 'pill n3';
    }

    function renderList(){
      list.innerHTML='';
      const arr = (data[currentZone]||[]).slice().sort((a,b)=>a-b);
      if (!arr.length){ list.innerHTML = '<em style="opacity:.7">Nessun numero</em>'; return; }
      for (const n of arr){
        const s = document.createElement('span');
        s.className = pillClassFor(n);
        s.textContent = n;
        list.appendChild(s);
      }
      const total = arr.length;
      const unique = new Set(arr).size;
      const summary = root.querySelector('#summary');
      if (summary) {
        const label = unique === 1 ? 'ordine' : 'ordini';
        summary.textContent = total ? `${unique} ${label} in memoria` : '';
      }
    }

    function addScanned(val){
      if (!currentZone){
        alert('Seleziona prima una zona.');
        return;
      }
      if (val < 1 || val > 999) {
        alert('Sono ammessi solo valori da 1 a 999.');
        return;
      }
      if (!data[currentZone]) data[currentZone] = [];
      if (!data[currentZone].includes(val)) {
        data[currentZone].push(val);
        renderList();
        soundScanOK();
        setActionButtonsEnabled(true);
      } else {
        soundScanDuplicate();
      }
    }

    // --- Inserimento manuale ---
    let manualBuffer = "";
    function refreshManualDisplay(){ keyDisplay.textContent = manualBuffer.length ? manualBuffer : '—'; }

    toggleKeypadBtn.addEventListener('click', ()=>{
      if (!currentZone){
        alert('Seleziona prima una zona per poter inserire manualmente.');
        return;
      }
      keypad.classList.toggle('show');
      if (!keypad.classList.contains('show')) {
        manualBuffer = "";
        refreshManualDisplay();
      }
    });
    keypad.addEventListener('click', (e)=>{
      const k = e.target.closest('.key');
      if (!k) return;
      const act = k.dataset.act;
      if (act === 'back'){
        manualBuffer = manualBuffer.slice(0,-1);
        refreshManualDisplay();
        return;
      }
      if (act === 'ok'){
        if (!manualBuffer) return;
        const n = parseInt(manualBuffer, 10);
        if (Number.isFinite(n) && n >= 1 && n <= 999) {
          addScanned(n);
        } else {
          alert('Inserisci un valore da 1 a 999.');
        }
        manualBuffer = "";
        refreshManualDisplay();
        return;
      }
      // solo cifre
      const digit = k.textContent.trim();
      if (/^\d$/.test(digit)){
        const next = (manualBuffer + digit).replace(/^0+(\d)/,'$1'); // no zeri iniziali
        if (next.length <= 3) {
          manualBuffer = next;
          refreshManualDisplay();
        }
      }
    });

    // Selettori zona (bloccabili dopo avvio)
    root.querySelectorAll('#segNegozio .opt, #segCamion .opt, .chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (scanningLocked){
          alert('Non puoi cambiare zona dopo aver avviato la scansione.');
          return;
        }
        root.querySelectorAll('.opt, .chip').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        select(btn.dataset.zone);
      });
    });
    root.querySelector('#useCustom').addEventListener('click', ()=>{
      if (scanningLocked){
        alert('Non puoi cambiare zona dopo aver avviato la scansione.');
        return;
      }
      const v = (root.querySelector('#customZone').value||'').trim(); if (!v) return;
      root.querySelectorAll('.opt,.chip').forEach(b=>b.classList.remove('active'));
      select(v);
    });

    // === Camera / QR ===
    async function openCamera(){
      if (!currentZone){
        alert('Seleziona una zona.');
        return;
      }
      try{
        const constraints = {
          audio:false,
          video:{ facingMode:{ ideal:'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 } }
        };

        // iOS: playsinline + muted
        video.setAttribute('playsinline','');
        video.setAttribute('muted','');
        video.muted = true;

        // ferma eventuale stream precedente
        await stopCamera();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          throw new Error('getUserMedia non disponibile (HTTPS? permessi bloccati?)');
        }

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();
        videoTrack = stream.getVideoTracks()[0];

        if (window.startQR) {
          window.startQR(video, (text) => {
            if (qrPaused) return;
            const match = text.match(/\d+/g);
            if (!match) return;
            for (const m of match) addScanned(parseInt(m, 10));
          });
          qrRunning = true;
        }

        // UI on
        markActive('section2');
        video.style.display='block';
        placeholder.style.display='none';

        // badge
        badge2.classList.remove('pulse');
        badge2.classList.add('done');
        badge3.classList.add('pulse');

        hasEverStarted = true;
        scanningLocked = true; // blocca cambio zona
        lockZoneSelectors(true);

        // stato iniziale: scansione attiva => bottone “Pausa scansione ⏸”
        setScanButton_active();
        setActionButtonsEnabled(true);

      } catch(err){
        console.error(err);
        alert(
          'Non riesco ad aprire la fotocamera.\n' +
          '- Sito in HTTPS?\n' +
          '- Permesso camera concesso al browser?\n\n' +
          (err && err.name ? 'Errore: '+err.name : '')
        );
      }
    }

    function lockZoneSelectors(lock){
      root.querySelectorAll('#segNegozio .opt, #segCamion .opt, .chip, #useCustom').forEach(el=>{
        if (lock) el.setAttribute('disabled','disabled');
        else el.removeAttribute('disabled');
      });
      const customInput = root.querySelector('#customZone');
      if (customInput) customInput.disabled = !!lock;
    }

    async function stopCamera(){
      if (window.stopQR) window.stopQR();
      qrRunning = false;
      qrPaused = false;
      videoWrap.classList.remove('paused');

      if (stream){
        for (const t of stream.getTracks()) t.stop();
        stream = null;
      }
      try{ video.pause(); }catch(_){}
      video.srcObject = null;

      videoTrack = null;

      setScanButton_start();
    }

    /* ===== Stato bottone scansione =====
       start()  -> blu  "Avvia scansione"
       active() -> grigio chiaro "Pausa scansione ⏸"  (scansione attiva)
       paused() -> verde "Riprendi scansione ▶" (scansione in pausa)
    */
    function setScanButton_start(){
      btnScan.textContent = 'Avvia scansione';
      btnScan.classList.remove('pause','resume','success');
      btnScan.classList.add('primary');
    }
    function setScanButton_active(){
      btnScan.innerHTML = 'Pausa scansione <span class="pause-ico">⏸</span>';
      btnScan.classList.remove('primary','resume','success');
      btnScan.classList.add('pause');
    }
    function setScanButton_paused(){
      btnScan.innerHTML = 'Riprendi scansione <span class="play-ico">▶</span>';
      btnScan.classList.remove('primary','pause');
      btnScan.classList.add('resume','success');
    }

    function setActionButtonsEnabled(enabled){
      btnCopy.disabled = !enabled;
      btnClear.disabled = !enabled;
    }

    // Toggle scan (giro logico richiesto)
    btnScan.addEventListener('click', async ()=>{
      if (!hasEverStarted || !stream){
        await openCamera(); // avvia -> diventa "Pausa scansione ⏸"
        return;
      }
      if (!qrPaused){
        // Metti in pausa
        qrPaused = true;
        if (window.stopQR) window.stopQR();
        qrRunning = false;
        videoWrap.classList.add('paused');
        setScanButton_paused();          // verde con ▶
        setActionButtonsEnabled(true);
      } else {
        // Riprendi
        if (window.startQR){
          window.startQR(video, (text)=>{
            if (qrPaused) return;
            const match = text.match(/\d+/g);
            if (!match) return;
            for (const m of match) addScanned(parseInt(m, 10));
          });
          qrRunning = true;
        }
        qrPaused = false;
        videoWrap.classList.remove('paused');
        setScanButton_active();          // grigio chiaro con ⏸
        setActionButtonsEnabled(true);
      }
    });

    // Torcia
    btnTorch.addEventListener('click', async ()=>{
      try {
        if (!videoTrack) {
          await openCamera();
          if (!videoTrack) return;
        }
        const caps = videoTrack.getCapabilities && videoTrack.getCapabilities();
        if (!caps || !caps.torch) {
          alert('Torcia non supportata su questo dispositivo');
          return;
        }
        const settings = videoTrack.getSettings && videoTrack.getSettings();
        const current = settings && settings.torch ? true : false;
        await videoTrack.applyConstraints({ advanced: [{ torch: !current }] });
        // toggla cono simulato
        torchOn = !current;
        btnTorch.classList.toggle('torch-on', torchOn);
      } catch (e) {
        console.error(e);
      }
    });

    // Reset completo
    function fullReset(){
      for (const k in data) delete data[k];
      currentZone = null;

      [badge1,badge2,badge3,badge4,badge5].forEach(b=>{ if(b) b.classList.remove('done','pulse'); });
      badge1.classList.add('pulse');

      document.getElementById('section1').classList.add('active');
      ['section2','section3','section4','section5'].forEach(id=>{
        const el = document.getElementById(id);
        if (el && id!=='section1') el.classList.remove('active');
      });

      video.style.display='none';
      placeholder.style.display='block';
      loc.textContent = 'Nessuna zona selezionata';
      zoneLine.textContent = '—';
      selectedZoneBox.classList.remove('active');
      root.querySelectorAll('.opt,.chip').forEach(b=>b.classList.remove('active'));

      hasEverStarted = false;
      scanningLocked = false;
      lockZoneSelectors(false);
      setActionButtonsEnabled(false);
      setScanButton_start();

      // torcia UI
      btnTorch.classList.remove('torch-on');

      // nascondi step 5 se aperto
      const s5 = document.getElementById('section5');
      if (s5) s5.style.display='none';

      // chiudi keypad
      keypad.classList.remove('show');
      manualBuffer = "";
      keyDisplay.textContent = '—';
    }

    btnClear.addEventListener('click', async ()=>{
      await stopCamera();
      fullReset(); // come primo avvio
    });

    // "Termina e invia": mostra Step 5, chiude keypad e deseleziona zona
    btnCopy.addEventListener('click', async ()=>{
      await stopCamera();

      // chiudi keypad
      keypad.classList.remove('show');
      manualBuffer = "";
      keyDisplay.textContent = '—';

      // deseleziona zona
      currentZone = null;
      root.querySelectorAll('.opt,.chip').forEach(b=>b.classList.remove('active'));
      selectedZoneBox.classList.remove('active');
      loc.textContent = 'Nessuna zona selezionata';
      zoneLine.textContent = '—';

      document.getElementById('section3').classList.add('active');
      badge3.classList.remove('pulse');
      badge3.classList.add('done');
      badge4.classList.add('done');

      const s5 = document.getElementById('section5');
      if (s5){
        s5.style.display = '';
        markActive('section5');
        if (badge5) badge5.classList.add('done');
      }
    });

    window.addEventListener('pagehide', async ()=>{ await stopCamera(); }, { once:true });
    window.addEventListener('beforeunload', async ()=>{ await stopCamera(); }, { once:true });
    document.addEventListener('visibilitychange', async ()=>{
      if (document.visibilityState === 'hidden') await stopCamera();
    });
  })();
  </script>

  <!-- QR scanner (ZXing) -->
  <script type="module">
    import { BrowserQRCodeReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm";

    const qrReader = new BrowserQRCodeReader();
    let qrControls = null;
    let lastText = "";

    window.startQR = async function(videoEl, onResult){
      qrControls = await qrReader.decodeFromVideoElement(videoEl, (result, err) => {
        if (result) {
          const text = result.getText();
          if (text && text !== lastText) {
            lastText = text;
            try { onResult(text); } catch(e) { console.error(e); }
            setTimeout(()=>{ lastText = ""; }, 800);
          }
        }
      });
    };

    window.stopQR = function(){
      try { if (qrControls) qrControls.stop(); } catch(_) {}
      qrControls = null;
    };
  </script>
</body>
</html>
