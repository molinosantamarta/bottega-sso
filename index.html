<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SSO - Scanner Stoccaggio Ordini — Mini-SPA (2 viste)</title>

  <!-- 👇 Stili SPA (leggeri, non toccano il tuo CSS interno) -->
  <style>
    :root{ --spa-bg:#000; --spa-fg:#fff; --spa-muted:#1c1c1e; --spa-accent:#0a84ff; }
    html, body { height:100%; background:#000; }
    body { margin:0; color:var(--spa-fg); font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif; }

    /* Contenitore app a due viste */
    #app { min-height:100dvh; position:relative; }
    .view { display:none; }
    .view.active { display:block; }

    /* Tabbar fissa in basso */
    .tabbar {
      position:fixed; left:0; right:0; bottom:0; z-index:9999;
      height:64px; background:#0b0b0b; border-top:1px solid #111;
      display:flex; gap:8px; align-items:center; justify-content:space-around;
      padding:8px 10px;
    }
    .tabbar .tab {
      flex:1; height:48px; border-radius:12px; border:1px solid #2c2c2e;
      background:#161618; color:#fff; font-weight:800; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      text-decoration:none; user-select:none;
    }
    .tabbar .tab.active {
      background:linear-gradient(180deg, #b8ffd4, #a4f5c4);
      color:#003b1f; border-color:#98f0c0; box-shadow:0 6px 18px rgba(120,255,180,.35), inset 0 1px 0 rgba(255,255,255,.35);
    }

    /* Spaziatura di sicurezza per i contenuti sopra la tabbar
       (non tocco i tuoi stili; aggiungo un safe-area extra) */
    .spa-safe-bottom { padding-bottom:88px; }
    @supports(padding: max(0px)) {
      .spa-safe-bottom { padding-bottom:max(88px, env(safe-area-inset-bottom)); }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- ===================== VISTA A ===================== -->
    <div id="viewA" class="view active">
      <div class="spa-safe-bottom">
        <!-- ========== INIZIO: TUO FILE ORIGINALE (immutato) ========== -->

        <!doctype html>
        <html lang="it">
        <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
          <title>SSO - Scanner Stoccaggio Ordini</title>
          <style>
            /* Reset pagina e sfondo nero pieno */
            html, body { height:100%; background:#000; }
            body { margin:0; }

            [data-sso] { color-scheme: dark; }
            [data-sso] :where(*) { box-sizing: border-box; }
            [data-sso] {
              --bg:#000;
              --fg:#fff;
              --muted:#1c1c1e;
              --accent:#0a84ff;
              --danger:#ff453a;
              --ok:#34c759;
              --chip:#1f1f22;
              --border:#2c2c2e;
              --success:#22c55e;
              --torch-on:#ffd60a;
              --yellow:#ffd60a;
              background:var(--bg);
              color:var(--fg);
              font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;
              -webkit-text-size-adjust:115%;
              text-size-adjust:115%;
            }
            [data-sso] .wrap{ padding:12px 12px 40px; max-width:760px; margin:0 auto; }

            [data-sso] header{ padding:16px 16px 12px; text-align:center; border-bottom:1px solid #111; overflow:hidden; }
            [data-sso] header h1{
              margin:0; font-size:21px; font-weight:900; line-height:1.3; color:transparent;
              background:linear-gradient(90deg, #ff0000 0%, #ff9900 25%, #ffff00 50%, #ff9900 75%, #ff0000 100%);
              -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
              background-size:300% 100%; animation:radar-sweep 8s linear infinite;
            }
            [data-sso] header .subtitle { margin-top:6px; font-size:15px; font-weight:600; color:#ddd; opacity:.9; }

            /* Immagini header */
            [data-sso] .hero-img-wrap{
              display:flex; flex-direction:row; align-items:center; justify-content:center;
              margin-top:14px; margin-bottom:10px; gap:0; position:relative;
            }
            @keyframes slideInRight { from { transform:translateX(60px); opacity:0; } to { transform:translateX(0); opacity:1; } }
            [data-sso] .hero-img-wrap img{ position:relative; left:7px; }
            [data-sso] .hero-img-wrap img.alt{
              width:32.8%; max-width:295px; height:auto; border-radius:12px; display:block;
              box-shadow:0 10px 30px rgba(0,0,0,.25);
              animation:slideInRight .9s ease-out both; z-index:2;
            }
            [data-sso] .hero-img-wrap img.altB{
              width:31.5%; max-width:284px; height:auto; border-radius:12px; display:block;
              box-shadow:0 10px 30px rgba(0,0,0,.2);
              animation:slideInRight .6s .05s ease-out both;
              margin-left:-3%; z-index:1; opacity:.95; top:6px;
            }

            .beta-row{ display:flex; justify-content:center; margin-top:14px; }
            .beta-pill{
              display:inline-flex; align-items:center; justify-content:center;
              padding:6px 10px; border-radius:999px;
              background:#ffd60a; color:#000; font-weight:800; font-size:12px;
              box-shadow:0 1px 0 rgba(255,255,255,.25) inset, 0 4px 12px rgba(0,0,0,.25);
              border:1px solid #e6c408; letter-spacing:.2px;
            }

            [data-sso] .section{ margin-top:20px; border-radius:12px; padding:10px; transition:background .25s ease, box-shadow .25s ease, border-color .25s ease; border:1px solid #0f2616; }
            [data-sso] .section.active{
              background:linear-gradient(180deg, rgba(220,255,233,.25), rgba(180,255,208,.1));
              box-shadow:0 10px 28px rgba(80,255,150,.18), inset 0 1px 0 rgba(255,255,255,.12);
              border-color:rgba(120,255,180,.55);
            }

            [data-sso] .step-title{ font-size:14px; opacity:.9; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
            [data-sso] .step-badge{ background:#1f1f22; color:#fff; border-radius:999px; padding:2px 8px; font-size:12px; transition:all .2s ease; border:1px solid #2a2a2d; }
            [data-sso] .step-badge.done{ background:linear-gradient(180deg,#eafff2,#b8ffd4); color:#073; font-weight:900; border-color:#a4f5c4; text-shadow:0 0 6px rgba(120,255,180,.6); }
            @keyframes pulse-badge { 0%,100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(10,132,255,0);} 50%{ transform:scale(1.1); box-shadow:0 0 0 6px rgba(10,132,255,.15);} }
            [data-sso] .step-badge.pulse{ animation:pulse-badge 1.2s ease-in-out infinite; background:linear-gradient(180deg, #0a84ff, #0569c9); }

            .controls{ display:flex; gap:10px; align-items:center; }
            .controls.nowrap{ flex-wrap:nowrap; }
            .controls .spacer{ flex:1; }
            .controls.split .btn{ flex:1; }
            #section3 .controls.split .btn{ font-size:18px; padding:21px 16px; }

            .btn{
              padding:14px 16px; border:0; border-radius:12px; font-size:16px; font-weight:700; color:#fff; cursor:pointer;
              transition: filter .15s ease, opacity .15s ease, background-color .15s ease, color .15s ease;
              display:inline-flex; align-items:center; justify-content:center; line-height:1;
            }
            .btn:disabled{ opacity:.7; cursor:not-allowed; filter:none; }
            .primary{ background:var(--accent); }
            .ghost{ background:#4b4b4e; color:#ddd; }
            .danger{ background:var(--danger); }
            .success{ background:var(--success); color:#001f0f; }
            .btn-yellow{ background:var(--yellow); color:#000; }

            .btn.pause{ background:#5a5a5e; color:#fff; }
            .btn.resume{ background:var(--success); color:#001f0f; }
            .pause-ico, .play-ico{ margin-left:8px; font-weight:900; }

            .torch-wrap{ display:flex; align-items:center; gap:7px; }
            .torch-label{ font-size:15px; line-height:1.05; text-align:right; opacity:.9; text-transform:lowercase; }
            .torch-label strong{ display:block; text-transform:uppercase; }

            .icon-btn{
              width:44px; height:44px; border-radius:999px; position:relative;
              border:1px solid #2c2c2e; background:#fff; color:#000;
              display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
              box-shadow:inset 0 1px 0 rgba(255,255,255,.6), 0 4px 10px rgba(0,0,0,.35);
              overflow:visible;
            }
            .icon-btn.torch-on{ background:var(--torch-on); color:#111; border-color:#d8be07; }
            .icon-btn:active{ transform:scale(.97); }
            .icon-btn svg{ width:22px; height:22px; display:block; }
            .icon-btn.torch-on::after{
              content:""; position:absolute; left:50%; bottom:44px;
              transform:translateX(-50%) rotate(180deg);
              width:12px; height:0; border-left:60px solid transparent; border-right:60px solid transparent;
              border-bottom:160px solid rgba(255, 244, 200, .18);
              filter:blur(2px); pointer-events:none;
            }

            .seg-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
            .seg{ display:flex; background:#121214; border:1px solid var(--border); border-radius:999px; overflow:auto; -webkit-overflow-scrolling:touch; transition:all .2s ease; }
            .seg::-webkit-scrollbar{ display:none; }
            .seg.active{
              border-color:rgba(120,255,180,.8);
              background:linear-gradient(180deg, rgba(220,255,233,.35), rgba(180,255,208,.18));
              box-shadow:0 8px 24px rgba(80,255,150,.22), inset 0 1px 0 rgba(255,255,255,.12);
            }
            .seg .opt{ padding:8px 12px; font-size:14px; border:0; background:transparent; color:#fff; cursor:pointer; white-space:nowrap; transition:all .2s ease; }
            .seg .opt.active{
              background:linear-gradient(180deg, #b8ffd4, #a4f5c4);
              color:#003b1f; font-weight:900; border-radius:999px; box-shadow:0 6px 18px rgba(120,255,180,.35), inset 0 1px 0 rgba(255,255,255,.35);
            }
            .seg .opt:disabled{ opacity:.45; cursor:not-allowed; }
            .seg-label{ font-size:13px; opacity:.85; min-width:72px; transition:all .2s ease; }
            .seg-label.active{ font-weight:800; opacity:1; color:#00d07c; text-shadow:0 0 10px rgba(120,255,180,.65); }

            .chips{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
            .chip{
              background:#121214; color:#fff; padding:10px 12px; border-radius:999px; font-size:14px; border:1px solid var(--border);
              cursor:pointer; white-space:nowrap; transition:all .2s ease;
            }
            .chip.active{
              background:linear-gradient(180deg, #b8ffd4, #a4f5c4);
              color:#003b1f; font-weight:900; box-shadow:0 6px 18px rgba(120,255,180,.35), inset 0 1px 0 rgba(255,255,255,.35);
              border-color:transparent;
            }
            .chip:disabled{ opacity:.45; cursor:not-allowed; }

            .custom{ display:flex; gap:8px; margin-top:10px; }
            .custom input{ flex:1; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#161618; color:#fff; font-size:14px; }
            .custom input::placeholder{ color:#aaa; }
            .custom button{ padding:12px 14px; border-radius:999px; border:0; background:var(--muted); color:#fff; font-weight:700; cursor:pointer; }
            .custom button:disabled{ opacity:.45; cursor:not-allowed; }

            .selected-zone{
              margin-top:10px; padding:10px 12px; border-radius:12px; background:#111; border:1px solid var(--border);
              display:flex; align-items:center; gap:8px; font-weight:600; transition:background .3s ease, box-shadow .3s ease, color .3s ease;
            }
            .selected-zone.active{ background:#ffd60a; color:#000; box-shadow:0 4px 14px rgba(0,0,0,.25); }
            .selected-dot{ width:10px; height:10px; border-radius:999px; background:var(--ok); display:inline-block; }

            .video-wrap{
              width:100%; aspect-ratio:16/9; border-radius:12px; overflow:hidden; border:1px solid var(--border);
              margin-top:10px; background:#000; position:relative; display:block;
            }
            @media (max-width:600px){ .video-wrap{ height:56vw; aspect-ratio:auto; } }
            .video-wrap.paused::after{
              content:"La scansione è in pausa"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
              backdrop-filter:blur(6px) brightness(.7); color:#fff; font-weight:800; letter-spacing:.6px;
            }

            .qr-guide{ position:absolute; left:50%; top:30%; transform:translate(-50%,-50%); height:30%; width:auto; opacity:1; display:none; pointer-events:none; }
            .qr-hint{
              position:absolute; left:50%; top:66%; transform:translate(-50%,-50%);
              max-width:80%; width:80%; color:#fff; font-weight:800; font-size:13px; letter-spacing:.2px; line-height:1.25;
              background:rgba(0,0,0,.45); padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.2);
              display:none; text-align:center; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
            }

            .dup-msg{
              position:absolute; left:50%; top:8%; transform:translateX(-50%);
              width:90%; max-width:680px; padding:10px 14px; border-radius:14px;
              background:rgba(0,0,0,.65); color:#fff; font-weight:800; letter-spacing:.2px; text-align:center;
              opacity:0; pointer-events:none; transition:opacity .2s ease; border:1px solid rgba(255,255,255,.2);
              display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.25;
            }
            .dup-msg.show{ opacity:1; }

            video{ display:none; width:100%; height:100%; object-fit:cover; object-position:center; background:#000; }

            .placeholder{
              position:absolute; inset:0; border:1px dashed var(--border); border-radius:12px;
              display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px;
              color:#aaa; text-align:left; padding:15px;
            }
            .ph-row{ display:flex; align-items:center; gap:12px; justify-content:center; width:100%; }
            .ph-icon{ width:36px; height:36px; opacity:.9; }

            .box{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#0b0b0b; margin-top:10px; }
            .label{ font-size:12px; opacity:.7; margin-bottom:4px; }
            .zone-line{ font-size:15px; font-weight:700; margin-bottom:8px; }
            .list{ display:flex; flex-wrap:wrap; gap:8px; min-height:44px; }

            .pill{
              display:inline-flex; align-items:center; justify-content:center;
              background:#ffd60a; color:#000; font-weight:800; font-size:15px; line-height:1;
              padding:0 10px; border-radius:999px;
              box-shadow:0 1px 0 rgba(255,255,255,.25) inset, 0 4px 12px rgba(0,0,0,.25);
              border:1px solid #e6c408;
            }
            .pill.n1{ width:36px; height:36px; padding:0; }
            .pill.n2{ min-width:40px; height:36px; }
            .pill.n3{ min-width:48px; height:36px; }

            .summary{ margin-top:10px; font-size:12px; opacity:.75; }
            .divider{ height:0.75px; background:#fff; opacity:.18; margin:10px 0 12px; border-radius:1px; }

            .manual-wrap{ margin-top:12px; }
            .manual-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
            .keypad{ display:none; margin-top:10px; }
            .keypad.show{ display:block; }
            .key-display{
              height:44px; border:1px solid var(--border); border-radius:10px; background:#111; color:#fff;
              display:flex; align-items:center; justify-content:flex-end; padding:0 12px; font-weight:800; font-size:18px; letter-spacing:.8px;
            }
            .keys{ margin-top:8px; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; }
            .key{
              height:48px; border-radius:12px; border:1px solid #2c2c2e; background:#1a1a1d; color:#fff; font-weight:800; font-size:18px;
              display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
            }
            .key.action{ background:#2a2a2d; }
            .key.confirm{ background:#ffd60a; color:#000; }

            .spacer{ height:1px; }

            @keyframes radar-sweep{0%{background-position:0% 50%;}50%{background-position:200% 50%;}100%{background-position:0% 50%;}}
            @keyframes glow-border { 0%{ border-color:#6a5acd; box-shadow:0 0 0 rgba(0,0,0,0); } 50%{ border-color:#1e90ff; box-shadow:0 0 14px rgba(30,144,255,.35); } 100%{ border-color:#6a5acd; box-shadow:0 0 0 rgba(0,0,0,0); } }
            .gradient-border { border-image: linear-gradient(90deg,#6a5acd,#1e90ff) 1; animation: glow-border 2s ease forwards; }
            .progress-wrap{ margin-top:6px; }
            .progress-outer{ width:100%; height:12px; border-radius:999px; background:#161616; border:1px solid #333; overflow:hidden; }
            .progress-inner{ height:100%; width:0%; background:linear-gradient(90deg,#6a5acd,#1e90ff); transition:width .1s linear; }
            .progress-msg{ margin-top:10px; font-size:13px; opacity:.95; min-height:20px; text-align:center; }
            .progress-done{ margin-top:12px; display:flex; justify-content:center; }
            .progress-done .btn-yellow{ padding:12px 16px; font-weight:16px; color:#000; border-radius:12px; }

            @media (max-width:600px){
              [data-sso] header h1{ font-size:23px; }
              [data-sso] header .subtitle{ font-size:16px; }
              [data-sso] .step-title{ font-size:15px; }
              [data-sso] .seg .opt{ font-size:15px; }
              [data-sso] .seg-label{ font-size:14px; }
              [data-sso] .chip{ font-size:15px; }
              [data-sso] .custom input, [data-sso] .custom button{ font-size:15px; }
              [data-sso] .torch-label{ font-size:16px; }
              [data-sso] .label{ font-size:13px; }
              [data-sso] .zone-line{ font-size:16px; }
              [data-sso] .summary{ font-size:16px; }
              #section3 .controls.split .btn{ font-size:18px; }
              .qr-hint{ font-size:14px; }
              .dup-msg{ font-size:14px; }
            }
          </style>
        </head>
        <body>
          <div data-sso>
            <header>
              <h1>SSO - Scanner Stoccaggio Ordini</h1>
              <div class="subtitle">Scansiona le spese in pochi secondi e trovale subito al momento del ritiro!</div>

              <div class="hero-img-wrap">
                <img class="alt" src="https://static.wixstatic.com/media/9d749b_4e7e462b0d2e40448664f342bb2cd2b5~mv2.png/v1/fill/w_116,h_126,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/shopper%20bottega_anteprima_edited_edited_.png" alt="Immagine 1" />
                <img class="altB" src="https://community.appinventor.mit.edu/uploads/default/original/3X/c/2/c21a68fb6312af849c89a657cd12c56faf74dc8e.gif" alt="Animazione" />
              </div>

              <div class="beta-row"><span class="beta-pill">Versione 9.0</span></div>
            </header>

            <div class="wrap">
              <!-- STEP 1 -->
              <div class="section active" id="section1">
                <div class="step-title"><span class="step-badge" id="badge1">1</span> Seleziona la zona che stai per scansionare</div>

                <div class="seg-row">
                  <div class="seg-label">NEGOZIO</div>
                  <div class="seg" id="segNegozio">
                    <button class="opt" data-zone="NEGOZIO - SOPRA">SOPRA</button>
                    <button class="opt" data-zone="NEGOZIO - SOTTO">SOTTO</button>
                  </div>
                </div>

                <div class="seg-row">
                  <div class="seg-label">CAMION</div>
                  <div class="seg" id="segCamion">
                    <button class="opt" data-zone="CAMION - SOPRA">SOPRA</button>
                    <button class="opt" data-zone="CAMION - SOTTO">SOTTO</button>
                  </div>
                </div>

                <div class="chips">
                  <button class="chip" data-zone="CARNE">CARNE</button>
                  <button class="chip" data-zone="SCALE">SCALE</button>
                </div>

                <div class="custom">
                  <input id="customZone" placeholder="Scrivi tu la zona..">
                  <button id="useCustom">Usa</button>
                </div>

                <div class="selected-zone" id="selectedZone"><span class="selected-dot"></span> <span id="loc">Nessuna zona selezionata</span></div>
              </div>

              <!-- STEP 2 -->
              <div class="section" id="section2">
                <div class="step-title"><span class="step-badge" id="badge2">2</span> Avvia scansione</div>

                <div class="controls nowrap">
                  <button id="btnScan" class="btn primary">Avvia scansione</button>
                  <div class="spacer"></div>
                  <div class="torch-wrap">
                    <div class="torch-label"><span>torcia</span><strong id="torchState">OFF</strong></div>
                    <button id="btnTorch" class="icon-btn" title="Torcia" aria-label="Torcia">
                      <svg viewBox="0 0 512 512" aria-hidden="true">
                        <path d="M128 96h256v64l-64 96v128a64 64 0 0 1-64 64h-0a64 64 0 0 1-64-64V256l-64-96V96z" fill="currentColor"/>
                        <rect x="208" y="48" width="96" height="24" rx="12" fill="currentColor"/>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="video-wrap" id="videoWrap">
                  <img id="qrGuide" class="qr-guide" style="display:none" src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" alt="Guida QR" />
                  <div id="qrHint" class="qr-hint" style="display:none">scansiona il codice QR del biglietto sulla spesa</div>
                  <video id="video" playsinline muted></video>

                  <div id="placeholder" class="placeholder">
                    <div class="ph-row">
                      <svg class="ph-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M4 7h3l1.5-2h7L17 7h3a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.5"/>
                        <circle cx="12" cy="13" r="3.5" stroke="currentColor" stroke-width="1.5"/>
                      </svg>
                      <span>La fotocamera comparirà qui dopo aver cliccato “Avvia scansione”.</span>
                    </div>
                    <div class="ph-row">
                      <svg class="ph-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M4 10h3l4-3v10l-4-3H4z" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M16 8a5 5 0 0 1 0 8M14 10a3 3 0 0 1 0 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      </svg>
                      <span>Attiva il volume per un’esperienza migliore e più intuitiva.</span>
                    </div>
                  </div>

                  <div id="dupMsg" class="dup-msg">già scansionato, passa al prossimo ordine.</div>
                </div>
              </div>

              <!-- STEP 3 -->
              <div class="section" id="section3">
                <div class="step-title"><span class="step-badge" id="badge3">3</span> Verifica e Conferma</div>
                <div class="box">
                  <div class="label">Zona</div>
                  <div class="zone-line" id="zoneLine">—</div>
                  <div class="list" id="list"></div>
                  <div class="summary" id="summary">0 ordini in memoria</div>

                  <!-- Inserimento manuale -->
                  <div class="manual-wrap">
                    <div class="manual-controls">
                      <button id="toggleKeypad" class="btn ghost" type="button">Aggiungi manualmente</button>
                    </div>
                    <div class="keypad" id="keypad">
                      <div class="key-display" id="keyDisplay">—</div>
                      <div class="keys">
                        <div class="key">1</div><div class="key">2</div><div class="key">3</div>
                        <div class="key">4</div><div class="key">5</div><div class="key">6</div>
                        <div class="key">7</div><div class="key">8</div><div class="key">9</div>
                        <div class="key action" data-act="back">⌫</div>
                        <div class="key">0</div>
                        <div class="key confirm" data-act="ok">Aggiungi</div>
                      </div>
                    </div>
                  </div>

                  <div class="divider"></div>

                  <div class="controls split" style="margin-top:0;">
                    <button id="btnCopy" class="btn success" disabled>Termina e invia</button>
                    <button id="btnClear" class="btn danger" disabled>Cancella e rifai</button>
                  </div>
                </div>
              </div>

              <!-- STEP 4 -->
              <div class="section" id="section4" style="display:none">
                <div class="step-title"><span class="step-badge" id="badge4">4</span> Invio scansioni</div>
                <div class="box gradient-border" id="step4Box"></div>
                <div class="progress-done" id="pDoneOuter" style="display:none">
                  <button id="btnNew" class="btn btn-yellow">Nuova scansione</button>
                </div>
              </div>

              <div class="spacer"></div>
            </div>
          </div>

          <script>
          (function(){
            const root = document.querySelector('[data-sso]');
            const loc = root.querySelector('#loc');
            const zoneLine = root.querySelector('#zoneLine');
            const list = root.querySelector('#list');
            const badge1 = root.querySelector('#badge1');
            const badge2 = root.querySelector('#badge2');
            const badge3 = root.querySelector('#badge3');
            const badge4 = document.getElementById('badge4');
            const selectedZoneBox = root.querySelector('#selectedZone');
            const videoWrap = document.getElementById('videoWrap');
            const video = root.querySelector('#video');
            const placeholder = root.querySelector('#placeholder');
            const dupMsg = document.getElementById('dupMsg');
            const qrGuide = document.getElementById('qrGuide');
            const qrHint = document.getElementById('qrHint');
            const btnScan = root.querySelector('#btnScan');
            const btnClear = root.querySelector('#btnClear');
            const btnCopy = root.querySelector('#btnCopy');
            const btnTorch = document.getElementById('btnTorch');
            const torchState = document.getElementById('torchState');
            const step4 = document.getElementById('section4');
            const step4Box = document.getElementById('step4Box');
            const pDoneOuter = document.getElementById('pDoneOuter');
            const btnNewExternal = document.getElementById('btnNew');

            // Manual keypad
            const toggleKeypadBtn = document.getElementById('toggleKeypad');
            const keypad = document.getElementById('keypad');
            const keyDisplay = document.getElementById('keyDisplay');

            let currentZone = null;
            const data = {};           // { zone: [numbers] }
            let stream = null;
            let videoTrack = null;

            let qrPaused = false;
            let qrRunning = false;
            let hasEverStarted = false;
            let scanningLocked = false;
            let dupTimer = null;
            let firstScanDone = false;

            // === CONFIG GOOGLE FORM (2 domande: ZONA + ORDINI CSV) ===
            const GFORM = {
              ACTION: "https://docs.google.com/forms/d/e/1FAIpQLSdixUK5TjPdfYMeso-XXTJHYy2Vy23F44j5FEMWFddWRfRh7Q/formResponse",
              ENTRY_ZONE:   "entry.1910612286",  // Domanda 1: ZONA (short answer)
              ENTRY_ORDERS: "entry.1223265482"   // Domanda 2: ORDINI (short answer)
            };

            // Forza hint/guide nascosti all’avvio
            if (qrGuide) qrGuide.style.display = 'none';
            if (qrHint)  qrHint.style.display  = 'none';

            // === AUDIO ===
            const AC = window.AudioContext || window.webkitAudioContext;
            let audioCtx = null;
            function ensureAC(){ if (!audioCtx) audioCtx = new AC(); return audioCtx; }
            function playTone(freq=880, dur=0.16, type='sine', gain=0.2, delay=0){
              try{
                const ac = ensureAC();
                const o = ac.createOscillator(), g = ac.createGain();
                o.type = type; o.frequency.value = freq; o.connect(g); g.connect(ac.destination);
                const now = ac.currentTime + (delay||0);
                g.gain.setValueAtTime(0.0001, now);
                g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
                o.start(now); o.stop(now + dur + 0.02);
              }catch(_){}
            }
            function soundZoneChange(){ playTone(660, 0.09, 'triangle', 0.18); }
            function soundScanOK(){  playTone(1046.5, 0.10, 'sine', 0.22, 0.00); playTone(1318.5, 0.11, 'sine', 0.20, 0.07); }
            function soundScanDuplicate(){ playTone(392, 0.18, 'square', 0.22); }

            // STEP 1 pulse
            badge1.classList.add('pulse');

            function markActive(sectionId){
              document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
              const sec = document.getElementById(sectionId);
              if (sec) sec.classList.add('active');
            }

            function clearZoneSelectionsUI(){
              root.querySelectorAll('.opt,.chip').forEach(b=>b.classList.remove('active'));
              selectedZoneBox.classList.remove('active');
              loc.textContent = 'Nessuna zona selezionata';
              zoneLine.textContent = '—';
            }

            function select(z){
              if (scanningLocked){
                alert('Non puoi cambiare zona dopo aver avviato la scansione.');
                return;
              }
              currentZone = z;
              loc.textContent = z;
              zoneLine.textContent = z;
              renderList();

              root.querySelectorAll('.seg-label').forEach(l=>l.classList.remove('active'));
              root.querySelectorAll('.seg').forEach(s=>s.classList.remove('active'));
              root.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
              selectedZoneBox.classList.remove('active');

              if(z.startsWith('NEGOZIO')){
                root.querySelector('#segNegozio').previousElementSibling.classList.add('active');
                root.querySelector('#segNegozio').classList.add('active');
              }
              if(z.startsWith('CAMION')){
                root.querySelector('#segCamion').previousElementSibling.classList.add('active');
                root.querySelector('#segCamion').classList.add('active');
              }
              if(z.startsWith('CARNE') || z.startsWith('SCALE')){
                const chip = [...root.querySelectorAll('.chip')].find(c => c.dataset.zone===z);
                if(chip) chip.classList.add('active');
              }

              badge1.classList.remove('pulse');
              badge1.classList.add('done');
              badge2.classList.add('pulse');

              document.getElementById('section1').classList.add('active');
              selectedZoneBox.classList.add('active');

              soundZoneChange();
            }

            function pillClassFor(num){
              const len = String(num).length;
              if (len === 1) return 'pill n1';
              if (len === 2) return 'pill n2';
              return 'pill n3';
            }

            function updateSummaryFor(zone){
              const arr = (data[zone]||[]);
              const unique = new Set(arr).size;
              const summary = root.querySelector('#summary');
              if (summary) {
                const label = unique === 1 ? 'ordine' : 'ordini';
                summary.textContent = `${unique} ${label} in memoria`;
              }
            }

            function renderList(){
              list.innerHTML='';
              const arr = (data[currentZone]||[]).slice().sort((a,b)=>a-b);
              if (!arr.length){ list.innerHTML = '<em style="opacity:.7">Nessun numero</em>'; }
              for (const n of arr){
                const s = document.createElement('span');
                s.className = pillClassFor(n);
                s.textContent = n;
                list.appendChild(s);
              }
              updateSummaryFor(currentZone || '_');
            }

            function showDuplicateOverlay(){
              dupMsg.classList.add('show');
              clearTimeout(dupTimer);
              dupTimer = setTimeout(()=>dupMsg.classList.remove('show'), 1200);
            }

            function setActionButtonsEnabled(enabled){
              btnCopy.disabled = !enabled;
              btnClear.disabled = !enabled;
            }

            function hideQrGuideOnce(){
              if (!firstScanDone){
                firstScanDone = true;
                if (qrGuide) qrGuide.style.display = 'none';
                if (qrHint)  qrHint.style.display  = 'none';
              }
            }

            function addScanned(val){
              if (!currentZone){ alert('Seleziona prima una zona.'); return; }
              if (val < 1 || val > 999) { alert('Sono ammessi solo valori da 1 a 999.'); return; }
              if (!data[currentZone]) data[currentZone] = [];
              if (!data[currentZone].includes(val)) {
                data[currentZone].push(val);
                renderList();
                soundScanOK();
                setActionButtonsEnabled(true);
                hideQrGuideOnce();
              } else {
                soundScanDuplicate();
                showDuplicateOverlay();
                hideQrGuideOnce();
              }
            }

            // --- Inserimento manuale ---
            let manualBuffer = "";
            function refreshManualDisplay(){ keyDisplay.textContent = manualBuffer.length ? manualBuffer : '—'; }

            toggleKeypadBtn.addEventListener('click', ()=>{
              if (!currentZone){
                alert('Seleziona prima una zona per poter inserire manualmente.');
                return;
              }
              keypad.classList.toggle('show');
              if (!keypad.classList.contains('show')) {
                manualBuffer = "";
                refreshManualDisplay();
              }
            });
            keypad.addEventListener('click', (e)=>{
              const k = e.target.closest('.key'); if (!k) return;
              const act = k.dataset.act;
              if (act === 'back'){ manualBuffer = manualBuffer.slice(0,-1); refreshManualDisplay(); return; }
              if (act === 'ok'){
                if (!manualBuffer) return;
                const n = parseInt(manualBuffer, 10);
                if (Number.isFinite(n) && n >= 1 && n <= 999) { addScanned(n); }
                else { alert('Inserisci un valore da 1 a 999.'); }
                manualBuffer = ""; refreshManualDisplay(); return;
              }
              const digit = k.textContent.trim();
              if (/^\d$/.test(digit)){
                const next = (manualBuffer + digit).replace(/^0+(\d)/,'$1');
                if (next.length <= 3) { manualBuffer = next; refreshManualDisplay(); }
              }
            });

            // Selettori zona
            root.querySelectorAll('#segNegozio .opt, #segCamion .opt, .chip').forEach(btn=>{
              btn.addEventListener('click', ()=>{
                if (scanningLocked){ alert('Non puoi cambiare zona dopo aver avviato la scansione.'); return; }
                root.querySelectorAll('.opt, .chip').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                select(btn.dataset.zone);
              });
            });
            root.querySelector('#useCustom').addEventListener('click', ()=>{
              if (scanningLocked){ alert('Non puoi cambiare zona dopo aver avviato la scansione.'); return; }
              const v = (root.querySelector('#customZone').value||'').trim(); if (!v) return;
              root.querySelectorAll('.opt,.chip').forEach(b=>b.classList.remove('active'));
              select(v);
            });

            // === Camera / QR ===
            async function openCamera(){
              if (!currentZone){ alert('Seleziona una zona.'); return; }
              try{
                const constraints = {
                  audio:false,
                  video:{ facingMode:{ ideal:'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 } }
                };

                video.setAttribute('playsinline',''); video.setAttribute('muted',''); video.muted = true;
                await stopCamera();

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
                  throw new Error('getUserMedia non disponibile (HTTPS? permessi bloccati?)');
                }

                const streamLocal = await navigator.mediaDevices.getUserMedia(constraints);
                stream = streamLocal;
                video.srcObject = stream;
                await video.play();
                videoTrack = stream.getVideoTracks()[0];

                firstScanDone = false;
                qrGuide.style.display = 'block';
                qrHint.style.display  = 'block';

                if (window.startQR) {
                  window.startQR(video, (text) => {
                    if (qrPaused) return;
                    const match = text.match(/\d+/g);
                    if (!match) return;
                    for (const m of match) addScanned(parseInt(m, 10));
                  });
                  qrRunning = true;
                }

                markActive('section2');
                video.style.display='block';
                placeholder.style.display='none';

                badge2.classList.remove('pulse'); badge2.classList.add('done'); badge3.classList.add('pulse');

                hasEverStarted = true;
                scanningLocked = true;
                lockZoneSelectors(true);

                setScanButton_active();
                setActionButtonsEnabled(true);

              } catch(err){
                console.error(err);
                alert('Non riesco ad aprire la fotocamera.\n- Sito in HTTPS?\n- Permesso camera concesso al browser?\n\n' + (err && err.name ? 'Errore: '+err.name : ''));
              }
            }

            function lockZoneSelectors(lock){
              root.querySelectorAll('#segNegozio .opt, #segCamion .opt, .chip, #useCustom').forEach(el=>{
                if (lock) el.setAttribute('disabled','disabled');
                else el.removeAttribute('disabled');
              });
              const customInput = root.querySelector('#customZone');
              if (customInput) customInput.disabled = !!lock;
            }

            async function stopCamera(){
              if (window.stopQR) window.stopQR();
              qrRunning = false; qrPaused = false;
              videoWrap.classList.remove('paused');

              if (stream){ for (const t of stream.getTracks()) t.stop(); stream = null; }
              try{ video.pause(); }catch(_){}
              video.srcObject = null;
              videoTrack = null;

              qrGuide.style.display = 'none';
              qrHint.style.display  = 'none';

              setScanButton_start();
            }

            function setScanButton_start(){
              btnScan.textContent = 'Avvia scansione';
              btnScan.classList.remove('pause','resume','success');
              btnScan.classList.add('primary');
            }
            function setScanButton_active(){
              btnScan.innerHTML = 'Pausa scansione <span class="pause-ico">⏸</span>';
              btnScan.classList.remove('primary','resume','success');
              btnScan.classList.add('pause');
            }
            function setScanButton_paused(){
              btnScan.innerHTML = 'Riprendi scansione <span class="play-ico">▶</span>';
              btnScan.classList.remove('primary','pause');
              btnScan.classList.add('resume','success');
            }

            btnScan.addEventListener('click', async ()=>{
              if (!hasEverStarted || !stream){ await openCamera(); return; }
              if (!qrPaused){
                qrPaused = true;
                if (window.stopQR) window.stopQR();
                qrRunning = false;
                videoWrap.classList.add('paused');
                setScanButton_paused();
                setActionButtonsEnabled(true);
              } else {
                if (window.startQR){
                  window.startQR(video, (text)=>{
                    if (qrPaused) return;
                    const match = text.match(/\d+/g);
                    if (!match) return;
                    for (const m of match) addScanned(parseInt(m, 10));
                  });
                  qrRunning = true;
                }
                qrPaused = false;
                videoWrap.classList.remove('paused');
                setScanButton_active();
                setActionButtonsEnabled(true);
              }
            });

            btnTorch.addEventListener('click', async ()=>{
              try {
                if (!videoTrack) {
                  await openCamera();
                  if (!videoTrack) return;
                }
                const caps = videoTrack.getCapabilities && videoTrack.getCapabilities();
                if (!caps || !caps.torch) { alert('Torcia non supportata su questo dispositivo'); return; }
                const settings = videoTrack.getSettings && videoTrack.getSettings();
                const current = settings && settings.torch ? true : false;
                await videoTrack.applyConstraints({ advanced: [{ torch: !current }] });
                const on = !current;
                btnTorch.classList.toggle('torch-on', on);
                torchState.textContent = on ? 'ON' : 'OFF';
              } catch (e) { console.error(e); }
            });

            async function copyCurrentPayloadToClipboard(){
              const zone = currentZone || '';
              const arr = (data[zone]||[]).slice().sort((a,b)=>a-b);
              const payload = JSON.stringify({ zona: zone, ordini: arr }, null, 0);
              try { await navigator.clipboard.writeText(payload); } catch(_){}
              return payload;
            }

            // === Invio al Google Form (2 domande: ZONA + ORDINI CSV) ===
            function submitToGoogleForm({ zona, ordini }) {
              if (!GFORM.ACTION || !GFORM.ENTRY_ZONE || !GFORM.ENTRY_ORDERS) {
                console.warn("Google Form non configurato.");
                return false;
              }
              const zoneVal   = (zona || "-").trim();
              const ordersVal = (Array.isArray(ordini) && ordini.length) ? ordini.join(",") : "-";

              let iframe = document.getElementById("hidden_iframe_gform");
              if (!iframe) {
                iframe = document.createElement("iframe");
                iframe.name = "hidden_iframe_gform";
                iframe.id   = "hidden_iframe_gform";
                iframe.style.display = "none";
                document.body.appendChild(iframe);
              }

              const form = document.createElement("form");
              form.action = GFORM.ACTION;
              form.method = "POST";
              form.target = "hidden_iframe_gform";

              const inZone = document.createElement("input");
              inZone.type  = "hidden";
              inZone.name  = GFORM.ENTRY_ZONE;
              inZone.value = zoneVal;
              form.appendChild(inZone);

              const inOrders = document.createElement("input");
              inOrders.type  = "hidden";
              inOrders.name  = GFORM.ENTRY_ORDERS;
              inOrders.value = ordersVal; // es: "1,2,3"
              form.appendChild(inOrders);

              document.body.appendChild(form);
              try { form.submit(); } finally { form.remove(); }
              return true;
            }

            async function fullReset(clearClipboard=true){
              await stopCamera();

              for (const k in data) delete data[k];
              list.innerHTML = '<em style="opacity:.7">Nessun numero</em>';
              const summary = root.querySelector('#summary'); if (summary) summary.textContent = '0 ordini in memoria';

              if (clearClipboard){
                try { await navigator.clipboard.writeText(''); } catch(_) {}
              }

              [badge1,badge2,badge3,badge4].forEach(b=>{ if(b) b.classList.remove('done','pulse'); });
              badge1.classList.add('pulse');

              document.getElementById('section1').classList.add('active');
              ['section2','section3'].forEach(id=>{
                const el = document.getElementById(id);
                if (el && id!=='section1') el.classList.remove('active');
              });

              video.style.display='none';
              placeholder.style.display='block';
              videoWrap.classList.remove('paused');
              dupMsg.classList.remove('show');

              currentZone = null;
              clearZoneSelectionsUI();

              hasEverStarted = false;
              scanningLocked = false;
              lockZoneSelectors(false);
              setActionButtonsEnabled(false);
              setScanButton_start();

              btnTorch.classList.remove('torch-on');
              torchState.textContent = 'OFF';

              keypad.classList.remove('show');
              manualBuffer = ""; keyDisplay.textContent = '—';

              firstScanDone = false;
              if (qrGuide) qrGuide.style.display = 'none';
              if (qrHint)  qrHint.style.display  = 'none';

              if (pDoneOuter) pDoneOuter.style.display = 'none';
            }

            btnClear.addEventListener('click', async ()=>{
              await fullReset(true);
              if (step4) step4.style.display='none';
              window.scrollTo({ top:0, behavior:'smooth' });
            });

            const progressMessages = [
              'Stabilisco handshake con il server…',
              'Sincronizzo timestamp NTP…',
              'Operazioni crittografiche avanzate…',
              'Ottimizzo il flusso dei pacchetti…',
              'se non va, vai in chiesina e accendi un cero.'
            ];

            function startStep4Progress(){
              step4Box.innerHTML = `
                <div class="progress-wrap">
                  <div class="progress-outer"><div class="progress-inner" id="pInner"></div></div>
                  <div class="progress-msg" id="pMsg">Inizializzo…</div>
                </div>
              `;

              const pInner = document.getElementById('pInner');
              const pMsg = document.getElementById('pMsg');

              let pct = 0;

              const incTimer = setInterval(()=>{
                pct += Math.floor(Math.random()*4) + 3;
                if (pct >= 96) {
                  pct = 96;
                  clearInterval(incTimer);
                  pMsg.textContent = progressMessages[progressMessages.length-1];
                  setTimeout(()=>{
                    pInner.style.width = '100%';
                    pMsg.textContent = 'Completato ✔︎';
                    if (pDoneOuter) pDoneOuter.style.display = 'flex';
                    if (btnNewExternal){
                      btnNewExternal.onclick = async ()=>{
                        await fullReset(true);
                        step4.style.display = 'none';
                        window.scrollTo({ top:0, behavior:'smooth' });
                      };
                    }
                  }, 4000);
                }
                pInner.style.width = pct + '%';
              }, 120);

              let msgIdx = 0;
              const cycle = setInterval(()=>{
                if (pct >= 96){ clearInterval(cycle); return; }
                pMsg.textContent = progressMessages[msgIdx % (progressMessages.length-1)];
                msgIdx++;
              }, 800);
            }

            // "Termina e invia"
            btnCopy.addEventListener('click', async ()=>{
              const zoneForSubmit = currentZone || '';
              const arrForSubmit  = (data[zoneForSubmit] || []).slice().sort((a,b)=>a-b);

              await copyCurrentPayloadToClipboard();
              submitToGoogleForm({ zona: zoneForSubmit, ordini: arrForSubmit });

              btnCopy.disabled = true; btnClear.disabled = true;
              btnCopy.classList.remove('success'); btnCopy.classList.add('ghost');
              btnClear.classList.remove('danger'); btnClear.classList.add('ghost');

              keypad.classList.remove('show'); manualBuffer = ""; keyDisplay.textContent = '—';
              if (currentZone && data[currentZone]) delete data[currentZone];
              list.innerHTML = '<em style="opacity:.7">Nessun numero</em>';
              document.getElementById('summary').textContent = '0 ordini in memoria';

              clearZoneSelectionsUI();
              currentZone = null;
              scanningLocked = false;
              lockZoneSelectors(false);

              badge3.classList.remove('pulse'); badge3.classList.add('done');
              if (badge4) badge4.classList.add('pulse');

              step4.style.display = '';
              step4.classList.add('gradient-border');
              markActive('section4');

              startStep4Progress();
              step4.scrollIntoView({ behavior:'smooth', block:'start' });
            });

            lockZoneSelectors(false);

            window.addEventListener('pagehide', async ()=>{ await stopCamera(); }, { once:true });
            window.addEventListener('beforeunload', async ()=>{ await stopCamera(); }, { once:true });
            document.addEventListener('visibilitychange', async ()=>{
              if (document.visibilityState === 'hidden') await stopCamera();
            });
          })();
          </script>

          <!-- QR scanner (ZXing) -->
          <script type="module">
            import { BrowserQRCodeReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm";

            const qrReader = new BrowserQRCodeReader();
            let qrControls = null;
            let lastText = "";

            window.startQR = async function(videoEl, onResult){
              qrControls = await qrReader.decodeFromVideoElement(videoEl, (result, err) => {
                if (result) {
                  const text = result.getText();
                  if (text && text !== lastText) {
                    lastText = text;
                    try { onResult(text); } catch(e) { console.error(e); }
                    setTimeout(()=>{ lastText = ""; }, 800);
                  }
                }
              });
            };

            window.stopQR = function(){
              try { if (qrControls) qrControls.stop(); } catch(_) {}
              qrControls = null;
            };
          </script>
        </body>
        </html>

        <!-- ========== FINE: TUO FILE ORIGINALE (immutato) ========== -->
      </div>
    </div>

    <!-- ===================== VISTA B ===================== -->
    <div id="viewB" class="view">
      <div class="spa-safe-bottom" style="padding:24px;">
        <!-- Contenitore vuoto pronto: qui potrai montare il “secondo codice” in futuro -->
      </div>
    </div>

    <!-- ===================== TABBAR ===================== -->
    <nav class="tabbar" role="tablist" aria-label="Navigazione viste">
      <a class="tab active" id="tabA" role="tab" aria-selected="true" href="#A">Pagina A</a>
      <a class="tab" id="tabB" role="tab" aria-selected="false" href="#B">Pagina B</a>
    </nav>
  </div>

  <!-- 👇 Router ultra-semplice per hosting statico -->
  <script>
    (function(){
      const viewA = document.getElementById('viewA');
      const viewB = document.getElementById('viewB');
      const tabA  = document.getElementById('tabA');
      const tabB  = document.getElementById('tabB');

      function setActive(which){
        const a = which === 'A';
        viewA.classList.toggle('active', a);
        viewB.classList.toggle('active', !a);
        tabA.classList.toggle('active', a);
        tabB.classList.toggle('active', !a);
        tabA.setAttribute('aria-selected', a ? 'true':'false');
        tabB.setAttribute('aria-selected', !a ? 'true':'false');
        // Nota: non forzo lo stop della camera per non toccare il tuo codice “A”.
        // Se vuoi spegnerla quando passi a B, basta chiamare window.stopQR() qui
        // e fermare i track video se presenti (ma sarebbe una modifica funzionale).
      }

      function applyRouteFromHash(){
        const h = (location.hash || '#A').toUpperCase();
        setActive(h.includes('B') ? 'B' : 'A');
      }

      window.addEventListener('hashchange', applyRouteFromHash);
      // Inizializza rotta (default su Pagina A)
      if (!location.hash) location.replace('#A');
      applyRouteFromHash();
    })();
  </script>
</body>
</html>
